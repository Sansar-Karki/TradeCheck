<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TradeCheck</title>

  <meta name="theme-color" content="#0b0f19" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Tailwind + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 10px 24px rgba(0,0,0,0.20); }
    .chip { border: 1px solid rgba(255,255,255,0.10); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- AUTH GATE -->
  <div id="authGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-2xl bg-gray-900 border border-gray-800 p-6 card">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center font-bold">TC</div>
        <div>
          <div class="font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Sign in to continue</div>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="authEmail" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Email" autocomplete="email">
        <input id="authPass" type="password" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Password (6+ chars)" autocomplete="current-password">
      </div>

      <button id="loginBtn" class="mt-4 w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Log in</button>
      <button id="signupBtn" class="mt-2 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Sign up</button>

      <div id="authMsg" class="text-xs text-red-300 mt-2"></div>
      <div class="text-xs text-gray-500 mt-3">
        Uses Supabase Auth + DB. If email confirmation is enabled, you must confirm before logging in.
      </div>
    </div>
  </div>

  <!-- USERNAME SETUP (first login) -->
  <div id="profileGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-2xl bg-gray-900 border border-gray-800 p-6 card">
      <div class="font-semibold">One quick thing</div>
      <div class="text-sm text-gray-400 mt-1">Pick a username for your dashboard.</div>

      <input id="profileUsername" class="mt-4 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Username (3-24 chars)">
      <button id="saveProfileBtn" class="mt-3 w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save</button>
      <div id="profileMsg" class="text-xs text-red-300 mt-2"></div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div class="max-w-6xl mx-auto p-4 pb-24">
    <!-- Top bar -->
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gray-900 border border-gray-800 flex items-center justify-center font-bold">TC</div>
        <div>
          <div id="greetingLine" class="text-lg font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">
            <span id="quoteLine"></span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gray-900 border border-gray-800 hover:bg-gray-800 text-sm">Log out</button>
      </div>
    </div>

    <!-- Market open card -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="text-xs text-gray-400">Next market open</div>
        <div id="marketOpenLine" class="mt-1 font-semibold">9:30 AM ET</div>
        <div id="marketCountdown" class="mt-1 text-sm text-gray-400"></div>
      </div>

      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="text-xs text-gray-400">Daily focus</div>
        <div id="todayFocusLine" class="mt-1 font-semibold">Do your Daily Review. One prompt. One answer.</div>
        <button id="dailyReviewBtn" class="mt-3 w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Daily Review</button>
      </div>

      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="text-xs text-gray-400">Daily Review streak</div>
        <div class="mt-1 flex items-baseline gap-2">
          <div id="streakCount" class="text-2xl font-bold">0</div>
          <div class="text-sm text-gray-400">days</div>
        </div>
        <div id="streakSub" class="mt-1 text-sm text-gray-400">Start tonight.</div>
      </div>
    </div>

    <!-- Stats + chart -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="text-sm font-semibold">Stats</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-950 border border-gray-800 p-3">
            <div class="text-xs text-gray-400">Total trades</div>
            <div id="statTotalTrades" class="mt-1 text-xl font-bold">0</div>
          </div>
          <div class="rounded-xl bg-gray-950 border border-gray-800 p-3">
            <div class="text-xs text-gray-400">Win rate</div>
            <div id="statWinRate" class="mt-1 text-xl font-bold">0%</div>
          </div>
          <div class="rounded-xl bg-gray-950 border border-gray-800 p-3">
            <div class="text-xs text-gray-400">Avg R</div>
            <div id="statAvgR" class="mt-1 text-xl font-bold">0.00</div>
          </div>
          <div class="rounded-xl bg-gray-950 border border-gray-800 p-3">
            <div class="text-xs text-gray-400">This week (R)</div>
            <div id="statWeekR" class="mt-1 text-xl font-bold">0.00</div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card lg:col-span-2">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">P&L chart (R)</div>
          <div class="text-xs text-gray-400">Cumulative by day</div>
        </div>
        <div class="mt-3">
          <canvas id="rChart" height="110"></canvas>
        </div>
      </div>
    </div>

    <!-- Quick add trade + Recent trades -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Add trade</div>
          <div class="text-xs text-gray-400">Rule-focused logging</div>
        </div>

        <div class="mt-3 space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-400">Date</label>
              <input id="tDate" type="date" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Symbol</label>
              <input id="tSymbol" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="AAPL">
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Strategy</label>
            <input id="tStrategy" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="ORB / Reversal / etc">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-400">Direction</label>
              <select id="tDir" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option>Long</option>
                <option>Short</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400">Realized (R)</label>
              <input id="tR" inputmode="decimal" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="1.50 or -1.00">
            </div>
          </div>

          <div>
            <div class="text-xs text-gray-400">Mistake tags</div>
            <div id="mistakeChips" class="mt-2 flex flex-wrap gap-2"></div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Note (optional)</label>
            <textarea id="tNote" rows="2" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="One sentence is plenty."></textarea>
          </div>

          <button id="addTradeBtn" class="w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save trade</button>
          <div id="tradeMsg" class="text-xs text-red-300"></div>
        </div>
      </div>

      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card lg:col-span-2">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Recent trades</div>
          <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-gray-900 border border-gray-800 hover:bg-gray-800 text-sm">Refresh</button>
        </div>
        <div id="tradesList" class="mt-3 space-y-2 max-h-[420px] overflow-auto no-scrollbar"></div>
        <div id="emptyTrades" class="hidden mt-3 text-sm text-gray-400">No trades yet. Either you were disciplined, or you forgot to log. Only one of those is flattering.</div>
      </div>
    </div>

    <!-- Journal -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Free write</div>
          <div class="text-xs text-gray-400">Anytime</div>
        </div>
        <textarea id="freeWriteText" rows="6" class="mt-3 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Dump thoughts. No structure. No shame."></textarea>
        <button id="freeWriteSave" class="mt-3 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm font-medium">Save free write</button>
        <div id="freeMsg" class="text-xs text-red-300 mt-2"></div>
      </div>

      <div class="rounded-2xl bg-gray-900 border border-gray-800 p-4 card lg:col-span-2">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Journal</div>
          <div class="text-xs text-gray-400">Daily Review + free writes</div>
        </div>

        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-xl bg-gray-950 border border-gray-800 overflow-hidden">
            <div id="journalList" class="max-h-[360px] overflow-auto no-scrollbar"></div>
          </div>
          <div class="md:col-span-2 rounded-xl bg-gray-950 border border-gray-800 p-4">
            <div id="journalDetail" class="text-sm text-gray-400">Select an entry.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DAILY REVIEW MODAL -->
  <div id="dailyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-gray-900 border border-gray-800 p-6 card">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-semibold text-lg">Daily Review</div>
          <div id="dailySummary" class="text-sm text-gray-400 mt-1"></div>
        </div>
        <button id="dailyClose" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Close</button>
      </div>

      <div class="mt-5 rounded-xl bg-gray-950 border border-gray-800 p-4">
        <div id="dailyPromptTitle" class="font-semibold"></div>
        <div id="dailyPromptText" class="text-sm text-gray-300 mt-2"></div>

        <textarea id="dailyResponse" rows="6" class="mt-4 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Answer honestly. Future you is watching."></textarea>

        <div class="mt-4 flex items-center gap-2">
          <button id="dailySave" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save review</button>
          <button id="dailyNew" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">New prompt</button>
        </div>

        <div id="dailyMsg" class="text-xs text-red-300 mt-2"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================
   CONFIG: paste your Supabase values here
   ========================================= */
const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================================
   Helpers
   ========================================= */
const el = (id)=>document.getElementById(id);
const show = (x)=>x.classList.remove("hidden");
const hide = (x)=>x.classList.add("hidden");
const todayISO = ()=> new Date().toISOString().slice(0,10);
const escapeHtml = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

function nyNow(){
  // Cheap ET approximation using Intl. Good enough for countdown display.
  const dt = new Date();
  const parts = new Intl.DateTimeFormat("en-US",{ timeZone:"America/New_York", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false, year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(dt);
  const get = (t)=>parts.find(p=>p.type===t)?.value;
  return { y:+get("year"), mo:+get("month"), d:+get("day"), h:+get("hour"), mi:+get("minute"), s:+get("second") };
}

function nextMarketOpenParts(){
  // Next weekday 9:30 AM ET. Not holiday-aware (yet).
  let { y, mo, d } = nyNow();
  let base = new Date(Date.UTC(y, mo-1, d, 0,0,0));
  for(let i=0;i<14;i++){
    const day = new Date(base.getTime() + i*86400000);
    const dow = day.getUTCDay(); // 0 Sun ... 6 Sat (UTC day corresponds to ET date via above y/mo/d)
    if(dow===0 || dow===6) continue;
    // Return the first weekday as target date. If today and before 9:30 ET, use today.
    const now = nyNow();
    const isToday = (day.getUTCFullYear()===now.y && (day.getUTCMonth()+1)===now.mo && day.getUTCDate()===now.d);
    if(isToday){
      const mins = now.h*60 + now.mi;
      if(mins < 570) return { y: now.y, mo: now.mo, d: now.d, h:9, mi:30 };
      // else: pick next weekday
      continue;
    }
    if(i===0) continue;
    // next weekday after today
    const nd = new Date(Date.UTC(now.y, now.mo-1, now.d, 0,0,0) + i*86400000);
    return { y: nd.getUTCFullYear(), mo: nd.getUTCMonth()+1, d: nd.getUTCDate(), h:9, mi:30 };
  }
  return { y, mo, d, h:9, mi:30 };
}

function countdownText(target){
  const now = nyNow();
  const nowUTC = Date.UTC(now.y, now.mo-1, now.d, now.h, now.mi, now.s);
  const tUTC = Date.UTC(target.y, target.mo-1, target.d, target.h, target.mi, 0);
  const diff = Math.max(0, Math.floor((tUTC-nowUTC)/1000));
  const hh = Math.floor(diff/3600);
  const mm = Math.floor((diff%3600)/60);
  const ss = diff%60;
  return { diff, text: `${hh}h ${mm}m ${ss}s` };
}

function formatDatePretty(iso){
  const [y,m,d] = (iso||"").split("-");
  if(!y) return "";
  return new Date(`${iso}T00:00:00`).toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
}

/* =========================================
   Quote of the day
   ========================================= */
const QUOTES = [
  "Discipline is a profit multiplier.",
  "One good trade beats five emotional ones.",
  "The market pays patience, not opinions.",
  "Your job is execution. The market handles results.",
  "If it’s not A-grade, it’s a donation.",
  "Size comes after consistency, not before.",
  "Boredom is usually the edge.",
  "Plan the trade. Trade the plan. Shocking, I know.",
  "Protect your mind like you protect your account.",
  "Small losses are tuition. Big losses are arrogance."
];
function dailyQuote(dateIso){
  const seed = Number((dateIso||"").split("-").join("")) || 1;
  return QUOTES[seed % QUOTES.length];
}

/* =========================================
   Prompt library (20 prompts, 2-axis)
   ========================================= */
const promptLibrary = [
  // Profitable + Calm (PC)
  { id:"pc_1", quad:"PC", title:"Do not get cocky", text:"What did you do today that worked, and how will you repeat it without increasing risk or speed?" },
  { id:"pc_2", quad:"PC", title:"Process proof", text:"Which rule protected you today? Write the exact moment it saved you." },
  { id:"pc_3", quad:"PC", title:"Scale with restraint", text:"If you scaled size 10% tomorrow, what condition must be true first?" },
  { id:"pc_4", quad:"PC", title:"Edge audit", text:"Describe one setup you skipped today. Was it discipline or fear? Prove it with your rules." },
  { id:"pc_5", quad:"PC", title:"Momentum without mania", text:"What will you stop doing tomorrow so today’s success doesn’t turn into tomorrow’s damage?" },

  // Profitable + Emotional (PE)
  { id:"pe_1", quad:"PE", title:"Luck vs skill", text:"You made money, but were you trading well? List 2 emotional decisions and the cost they could have had." },
  { id:"pe_2", quad:"PE", title:"The near miss", text:"What was the most dangerous moment today? Describe it like a police report." },
  { id:"pe_3", quad:"PE", title:"Impulse tax", text:"Which mistake tag showed up most? Why did it show up today, specifically?" },
  { id:"pe_4", quad:"PE", title:"Revenge in disguise", text:"Did you 'press' after winning? What emotion was driving that, and what rule would have blocked it?" },
  { id:"pe_5", quad:"PE", title:"Profit is not permission", text:"What boundary will you set tomorrow to keep profits from becoming confidence-fueled overtrading?" },

  // Unprofitable + Calm (UC)
  { id:"uc_1", quad:"UC", title:"Good loss", text:"If today was a clean loss, what evidence says your process was still correct?" },
  { id:"uc_2", quad:"UC", title:"Data, not drama", text:"What is one adjustment you can test that does not change your whole system?" },
  { id:"uc_3", quad:"UC", title:"Patience check", text:"Did you wait for A+ entries, or did you settle? Show the proof using your rules." },
  { id:"uc_4", quad:"UC", title:"Stop honoring", text:"Were your losses within plan? If yes, write why this is a win. If not, write what broke first." },
  { id:"uc_5", quad:"UC", title:"Tomorrow’s constraint", text:"What constraint (time, max trades, max risk) would make tomorrow cleaner?" },

  // Unprofitable + Emotional (UE)
  { id:"ue_1", quad:"UE", title:"Name the trigger", text:"What emotion ran the show today: fear, greed, boredom, or anger? Give one concrete example." },
  { id:"ue_2", quad:"UE", title:"Revenge protocol", text:"If you felt revenge/FOMO today, what will you do next time before placing any order? Write a 3-step reset." },
  { id:"ue_3", quad:"UE", title:"Overrisk autopsy", text:"Where did size or risk get out of control? What lie did you tell yourself to justify it?" },
  { id:"ue_4", quad:"UE", title:"Rule break ledger", text:"List every rule broken today. Next to each, write the consequence you are accepting." },
  { id:"ue_5", quad:"UE", title:"Avoidance", text:"Did you skip reviews or notes because it felt bad? What truth were you avoiding?" }
];

function quadrantLabel(q){
  return q==="PC" ? "Profitable + Calm" :
         q==="PE" ? "Profitable + Emotional" :
         q==="UC" ? "Unprofitable + Calm" :
         "Unprofitable + Emotional";
}

/* =========================================
   State
   ========================================= */
let currentUser = null; // { id, email, username }
let state = {
  trades: [],
  journals: [],
  freeWrites: [],
  selectedJournalKey: null
};

const mistakeOptions = [
  "Early entry","Late entry","No confirmation","Moved stop","Cut winner early","Let loser run",
  "Revenge trade","Overrisked","FOMO","None"
];

function renderMistakeChips(){
  const wrap = el("mistakeChips");
  wrap.innerHTML = mistakeOptions.map(m=>`
    <button type="button" data-m="${escapeHtml(m)}" class="chip px-3 py-1 rounded-full text-xs bg-gray-900 hover:bg-gray-800">
      ${escapeHtml(m)}
    </button>
  `).join("");

  wrap.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      btn.classList.toggle("bg-blue-600");
      btn.classList.toggle("hover:bg-blue-500");
      btn.classList.toggle("bg-gray-900");
      btn.classList.toggle("hover:bg-gray-800");
    });
  });
}

function selectedMistakes(){
  const chips = [...el("mistakeChips").querySelectorAll("button")];
  const picked = chips.filter(b=>b.classList.contains("bg-blue-600")).map(b=>b.getAttribute("data-m"));
  if(picked.length===0) return ["None"];
  if(picked.includes("None") && picked.length>1) return picked.filter(x=>x!=="None");
  return picked;
}

/* =========================================
   Supabase data layer
   ========================================= */
async function getSessionUser(){
  const { data: s } = await sb.auth.getSession();
  const session = s.session;
  if(!session) return null;
  const u = session.user;

  const { data: prof } = await sb.from("profiles").select("username").eq("id", u.id).maybeSingle();
  return { id: u.id, email: u.email || "", username: prof?.username || "" };
}

async function ensureProfile(userId, username){
  const uname = (username||"").trim();
  if(uname.length < 3 || uname.length > 24) throw new Error("Username must be 3-24 chars.");
  const { error } = await sb.from("profiles").insert({ id: userId, username: uname });
  if(error) throw error;
}

async function dbLoadTrades(){
  const { data, error } = await sb.from("trades").select("*").order("created_at", { ascending:false }).limit(300);
  if(error) throw error;
  return (data||[]).map(r=>({
    id: r.id,
    date: r.date,
    symbol: r.symbol,
    strategy: r.strategy,
    direction: r.direction,
    realizedR: Number(r.realized_r || 0),
    mistakes: Array.isArray(r.mistakes) ? r.mistakes : [],
    note: r.note || "",
    createdAt: r.created_at
  }));
}

async function dbInsertTrade(t){
  const payload = {
    date: t.date,
    symbol: t.symbol,
    strategy: t.strategy,
    direction: t.direction,
    realized_r: Number(t.realizedR || 0),
    mistakes: t.mistakes || [],
    note: t.note || ""
  };
  const { error } = await sb.from("trades").insert(payload);
  if(error) throw error;
}

async function dbLoadJournals(){
  const { data, error } = await sb.from("journals").select("*").order("date", { ascending:false }).limit(200);
  if(error) throw error;
  return (data||[]).map(j=>({
    id: j.id,
    date: j.date,
    promptId: j.prompt_id,
    response: j.response || "",
    signals: j.signals || {},
    createdAt: j.created_at
  }));
}

async function dbUpsertJournal(dateIso, promptId, response, signals){
  const payload = { date: dateIso, prompt_id: promptId, response: response || "", signals: signals || {} };
  const { error } = await sb.from("journals").upsert(payload, { onConflict: "user_id,date" });
  if(error) throw error;
}

async function dbLoadFreeWrites(){
  const { data, error } = await sb.from("free_writes").select("*").order("created_at", { ascending:false }).limit(200);
  if(error) throw error;
  return (data||[]).map(f=>({
    id: f.id,
    date: f.date,
    text: f.text || "",
    createdAt: f.created_at
  }));
}

async function dbInsertFreeWrite(dateIso, text){
  const payload = { date: dateIso, text: text || "" };
  const { error } = await sb.from("free_writes").insert(payload);
  if(error) throw error;
}

/* =========================================
   Daily signals + prompt selection
   ========================================= */
function tradesForDate(dateIso){
  return state.trades.filter(t=>t.date === dateIso);
}

function computeDailySignals(dateIso){
  const trades = tradesForDate(dateIso);
  const n = trades.length;

  const reviewed = trades; // we treat every trade as reviewed since it includes realizedR
  const wins = reviewed.filter(t=>t.realizedR > 0).length;
  const avgR = reviewed.length ? reviewed.reduce((a,t)=>a+t.realizedR,0)/reviewed.length : 0;

  const emoMistakes = ["Revenge trade","FOMO","Overrisked","Moved stop","Let loser run","Cut winner early","Early entry","Late entry","No confirmation"];
  let emoCount = 0;
  const emoTally = {};
  for(const t of trades){
    const ms = t.mistakes || [];
    const hit = ms.some(x=>emoMistakes.includes(x));
    if(hit) emoCount += 1;
    for(const m of ms){
      emoTally[m] = (emoTally[m]||0)+1;
    }
  }
  // pick top emotional trigger among a subset
  const candidates = ["Revenge trade","FOMO","Overrisked","Moved stop","Let loser run","Cut winner early","Early entry","Late entry","No confirmation"];
  let topEmo = "";
  let topN = -1;
  for(const c of candidates){
    if((emoTally[c]||0) > topN){ topN = (emoTally[c]||0); topEmo = c; }
  }
  if(topN <= 0) topEmo = "";

  const emoPct = n ? Math.round((emoCount/n)*100) : 0;
  const profitable = avgR >= 0.2;  // small buffer so "flat" isn't counted as profitable
  const emotional = emoPct >= 30 || ["Revenge trade","FOMO","Overrisked"].some(x=>(emoTally[x]||0)>0);

  const quad = profitable ? (emotional ? "PE" : "PC") : (emotional ? "UE" : "UC");
  return {
    dateIso,
    tradeCount: n,
    winRate: n ? Math.round((wins/n)*100) : 0,
    avgR,
    emoPct,
    quadrant: quad,
    topEmo
  };
}

function summarizeSignals(sig){
  if(sig.tradeCount === 0) return "No trades logged. Either you were disciplined, or you forgot to log. Only one of those is flattering.";
  const parts = [];
  parts.push(`${sig.tradeCount} trade${sig.tradeCount===1?"":"s"} logged.`);
  parts.push(`Quadrant: ${quadrantLabel(sig.quadrant)}.`);
  parts.push(`Win rate ${sig.winRate}%, avg R ${sig.avgR.toFixed(2)}.`);
  parts.push(`Emotion rate: ${sig.emoPct}%.`);
  if(sig.topEmo) parts.push(`Top trigger: ${sig.topEmo}.`);
  return parts.join(" ");
}

function promptScore(p, sig){
  let s = 0;
  if(p.quad === sig.quadrant) s += 10;

  if(sig.topEmo === "Revenge trade" && (p.id === "ue_1" || p.id === "ue_2" || p.id === "pe_4")) s += 3;
  if(sig.topEmo === "FOMO" && (p.id === "ue_2" || p.id === "ue_1" || p.id === "pe_5")) s += 3;
  if(sig.topEmo === "Overrisked" && (p.id === "ue_3" || p.id === "pe_5")) s += 3;

  // deterministic jitter per date to reduce repeats
  const seed = Number((sig.dateIso || "").split("-").join("")) || 0;
  const jitter = (seed % 13) * 0.07;
  return s + jitter;
}

function selectDailyPrompt(sig){
  const scored = promptLibrary
    .map(p => ({...p, _s: promptScore(p, sig)}))
    .sort((a,b)=>b._s-a._s);

  // Pick the first match; if none, fallback to top
  return scored.find(p => p.quad === sig.quadrant) || scored[0];
}

/* =========================================
   Metrics + streaks
   ========================================= */
function isoWeekStart(date){
  // Monday as start. date is Date object.
  const d = new Date(date);
  const day = (d.getDay()+6)%7; // Mon=0
  d.setDate(d.getDate()-day);
  d.setHours(0,0,0,0);
  return d;
}

function computeWeekR(){
  const now = new Date();
  const start = isoWeekStart(now);
  const startIso = start.toISOString().slice(0,10);
  const weekTrades = state.trades.filter(t=>t.date >= startIso);
  const sum = weekTrades.reduce((a,t)=>a + (Number(t.realizedR)||0), 0);
  return sum;
}

function computeStreak(){
  // streak = consecutive days with a journal entry (Daily Review) up to today
  const set = new Set(state.journals.map(j=>j.date));
  let streak = 0;
  let d = new Date(todayISO()+"T00:00:00");
  for(let i=0;i<400;i++){
    const iso = d.toISOString().slice(0,10);
    if(set.has(iso)) streak += 1;
    else break;
    d.setDate(d.getDate()-1);
  }
  return streak;
}

/* =========================================
   Rendering
   ========================================= */
let rChart = null;

function renderHero(){
  const greetLine = el("greetingLine");
  const qLine = el("quoteLine");
  const moLine = el("marketOpenLine");
  const cdLine = el("marketCountdown");
  const focus = el("todayFocusLine");

  const now = nyNow();
  const hr = now.h;
  const greet = hr < 12 ? "Good morning" : (hr < 18 ? "Good afternoon" : "Good evening");
  greetLine.textContent = `${greet}${currentUser?.username ? ", " + currentUser.username : ""}`;
  qLine.textContent = dailyQuote(todayISO());

  const target = nextMarketOpenParts();
  const pretty = formatDatePretty(`${target.y}-${String(target.mo).padStart(2,"0")}-${String(target.d).padStart(2,"0")}`);
  moLine.textContent = `9:30 AM ET • ${pretty}`;

  const cd = countdownText(target);
  cdLine.textContent = cd.diff===0 ? "Market is open (or you missed it)." : `Opens in ${cd.text}`;

  const today = todayISO();
  const j = state.journals.find(x=>x.date===today);
  if(j){
    const p = promptLibrary.find(x=>x.id===j.promptId);
    focus.textContent = p ? p.title : "Daily Review saved.";
  } else {
    focus.textContent = "Do your Daily Review. One prompt. One answer.";
  }
}

function renderStats(){
  el("statTotalTrades").textContent = String(state.trades.length);

  const wins = state.trades.filter(t=>t.realizedR > 0).length;
  const winRate = state.trades.length ? Math.round((wins/state.trades.length)*100) : 0;
  el("statWinRate").textContent = `${winRate}%`;

  const avgR = state.trades.length ? state.trades.reduce((a,t)=>a+t.realizedR,0)/state.trades.length : 0;
  el("statAvgR").textContent = avgR.toFixed(2);

  el("statWeekR").textContent = computeWeekR().toFixed(2);

  const streak = computeStreak();
  el("streakCount").textContent = String(streak);
  el("streakSub").textContent = streak ? "Keep the chain." : "Start tonight.";
}

function renderChart(){
  // Build daily cumulative R from trades
  const byDay = {};
  for(const t of state.trades){
    byDay[t.date] = (byDay[t.date]||0) + (Number(t.realizedR)||0);
  }
  const dates = Object.keys(byDay).sort();
  let cum = 0;
  const labels = [];
  const values = [];
  for(const d of dates){
    cum += byDay[d];
    labels.push(d.slice(5));
    values.push(Number(cum.toFixed(2)));
  }

  const ctx = el("rChart");
  if(rChart) rChart.destroy();
  rChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "Cumulative R", data: values, tension: 0.25 }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "rgba(229,231,235,0.7)" }, grid: { color: "rgba(31,41,55,0.35)" } },
        y: { ticks: { color: "rgba(229,231,235,0.7)" }, grid: { color: "rgba(31,41,55,0.35)" } }
      }
    }
  });
}

function renderTrades(){
  const list = el("tradesList");
  const empty = el("emptyTrades");

  if(state.trades.length === 0){
    list.innerHTML = "";
    show(empty);
    return;
  }
  hide(empty);

  const rows = state.trades.slice(0,30).map(t=>{
    const r = t.realizedR;
    const badge = r > 0 ? "bg-emerald-500/20 text-emerald-200 border-emerald-400/30" : (r < 0 ? "bg-red-500/20 text-red-200 border-red-400/30" : "bg-gray-500/20 text-gray-200 border-gray-400/30");
    const ms = (t.mistakes||[]).filter(x=>x && x!=="None");
    const msText = ms.length ? ms.join(", ") : "No mistakes";
    return `
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">${escapeHtml(t.symbol)} <span class="text-xs text-gray-400">(${escapeHtml(t.strategy)})</span></div>
            <div class="text-xs text-gray-500 mt-1">${escapeHtml(formatDatePretty(t.date))} • ${escapeHtml(t.direction)} • ${escapeHtml(msText)}</div>
            ${t.note ? `<div class="text-xs text-gray-300 mt-2">${escapeHtml(t.note)}</div>` : ``}
          </div>
          <div class="shrink-0 text-right">
            <div class="inline-flex items-center px-2 py-1 rounded-full border text-xs ${badge}">${r.toFixed(2)}R</div>
          </div>
        </div>
      </div>
    `;
  }).join("");
  list.innerHTML = rows;
}

function journalEntriesAll(){
  const a = state.journals.map(j=>({ type:"review", key:`review:${j.date}`, date:j.date, createdAt:j.createdAt, data:j }));
  const b = state.freeWrites.map(f=>({ type:"free", key:`free:${f.id}`, date:f.date, createdAt:f.createdAt, data:f }));
  return [...a, ...b].sort((x,y)=> (y.date||"").localeCompare(x.date||"") || String(y.createdAt||"").localeCompare(String(x.createdAt||"")));
}

function journalLabel(e){
  if(e.type==="free") return "Free write";
  const p = promptLibrary.find(x=>x.id===e.data.promptId);
  return p ? p.title : "Daily Review";
}

function renderJournal(selectedKey){
  const list = el("journalList");
  const detail = el("journalDetail");
  const entries = journalEntriesAll();

  if(entries.length===0){
    list.innerHTML = `<div class="p-4 text-sm text-gray-400">No entries yet. Do a Daily Review or add a free write.</div>`;
    detail.innerHTML = `<div class="text-sm text-gray-400">No entries to show.</div>`;
    return;
  }

  const current = selectedKey || state.selectedJournalKey || entries[0].key;
  state.selectedJournalKey = current;

  list.innerHTML = entries.map(e=>{
    const active = e.key === current;
    return `
      <button data-key="${escapeHtml(e.key)}" class="w-full text-left px-4 py-3 ${active ? "bg-gray-900" : "bg-gray-950 hover:bg-gray-900"}">
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-medium">${escapeHtml(formatDatePretty(e.date))}</div>
          <div class="text-[10px] px-2 py-0.5 rounded-full border border-gray-700 text-gray-400">${e.type==="review" ? "Review" : "Free"}</div>
        </div>
        <div class="text-xs text-gray-500 mt-1">${escapeHtml(journalLabel(e))}</div>
      </button>
    `;
  }).join("");

  list.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = btn.getAttribute("data-key");
      renderJournal(k);
    });
  });

  const entry = entries.find(x=>x.key===current) || entries[0];
  if(entry.type==="free"){
    detail.innerHTML = `
      <div class="text-xs text-gray-400">Free write</div>
      <div class="mt-2 whitespace-pre-wrap text-sm">${escapeHtml(entry.data.text)}</div>
    `;
  } else {
    const sig = entry.data.signals || {};
    const p = promptLibrary.find(x=>x.id===entry.data.promptId);
    detail.innerHTML = `
      <div class="text-xs text-gray-400">Daily Review • ${escapeHtml(quadrantLabel(sig.quadrant||"UC"))}</div>
      <div class="mt-2 font-semibold">${escapeHtml(p ? p.title : "Daily Review")}</div>
      <div class="mt-2 text-sm text-gray-300">${escapeHtml(p ? p.text : "")}</div>
      <div class="mt-4 text-xs text-gray-400">Your response</div>
      <div class="mt-1 whitespace-pre-wrap text-sm">${escapeHtml(entry.data.response || "")}</div>
      <div class="mt-4 text-xs text-gray-500">${escapeHtml(summarizeSignals(sig))}</div>
    `;
  }
}

function renderAll(){
  renderHero();
  renderStats();
  renderChart();
  renderTrades();
  renderJournal();
}

/* =========================================
   Daily Review modal flow
   ========================================= */
let currentPrompt = null;

function openDailyReview(forceNew=false){
  const dateIso = todayISO();
  const sig = computeDailySignals(dateIso);
  el("dailySummary").textContent = summarizeSignals(sig);

  const existing = state.journals.find(j=>j.date===dateIso);
  if(existing && !forceNew){
    currentPrompt = promptLibrary.find(p=>p.id===existing.promptId) || selectDailyPrompt(sig);
    el("dailyResponse").value = existing.response || "";
  } else {
    currentPrompt = selectDailyPrompt(sig);
    el("dailyResponse").value = "";
  }

  el("dailyPromptTitle").textContent = currentPrompt.title;
  el("dailyPromptText").textContent = currentPrompt.text;

  el("dailyMsg").textContent = "";
  show(el("dailyModal"));
}

/* =========================================
   Wiring
   ========================================= */
let heroTimer = null;
function startHeroTimer(){
  if(heroTimer) clearInterval(heroTimer);
  heroTimer = setInterval(renderHero, 1000);
  renderHero();
}

async function refreshData(){
  state.trades = await dbLoadTrades();
  state.journals = await dbLoadJournals();
  state.freeWrites = await dbLoadFreeWrites();
  renderAll();
}

function setAuthMessage(msg){ el("authMsg").textContent = msg || ""; }
function setProfileMessage(msg){ el("profileMsg").textContent = msg || ""; }

async function login(){
  const email = (el("authEmail").value||"").trim();
  const pass = el("authPass").value || "";
  setAuthMessage("");
  if(!email.includes("@") || pass.length < 6){ setAuthMessage("Email + 6+ char password required."); return; }

  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if(error){ setAuthMessage(error.message); return; }

  await boot();
}

async function signup(){
  const email = (el("authEmail").value||"").trim();
  const pass = el("authPass").value || "";
  setAuthMessage("");
  if(!email.includes("@") || pass.length < 6){ setAuthMessage("Email + 6+ char password required."); return; }

  const { data, error } = await sb.auth.signUp({ email, password: pass });
  if(error){ setAuthMessage(error.message); return; }

  // If confirm email is OFF, user is immediately signed in and can continue.
  // If confirm email is ON, they must confirm then log in.
  if(!data.session){
    setAuthMessage("Check your email to confirm, then log in.");
    return;
  }
  await boot();
}

async function logout(){
  await sb.auth.signOut();
  location.reload();
}

async function boot(){
  currentUser = await getSessionUser();
  if(!currentUser){
    show(el("authGate"));
    return;
  }
  hide(el("authGate"));

  // Require profile username once
  if(!currentUser.username){
    show(el("profileGate"));
    setProfileMessage("");
    return;
  }
  hide(el("profileGate"));

  // Seed inputs
  el("tDate").value = todayISO();
  renderMistakeChips();

  await refreshData();
  startHeroTimer();
}

async function saveProfile(){
  const uname = (el("profileUsername").value||"").trim();
  setProfileMessage("");
  try{
    await ensureProfile(currentUser.id, uname);
    currentUser.username = uname;
    hide(el("profileGate"));
    await boot();
  } catch(e){
    setProfileMessage(e.message || String(e));
  }
}

async function addTrade(){
  el("tradeMsg").textContent = "";
  const date = el("tDate").value || todayISO();
  const symbol = (el("tSymbol").value||"").trim().toUpperCase();
  const strategy = (el("tStrategy").value||"").trim();
  const direction = el("tDir").value;
  const realizedR = Number(el("tR").value);
  const mistakes = selectedMistakes();
  const note = (el("tNote").value||"").trim();

  if(!symbol || !strategy || !Number.isFinite(realizedR)){
    el("tradeMsg").textContent = "Date, symbol, strategy, and realized R are required.";
    return;
  }
  try{
    await dbInsertTrade({ date, symbol, strategy, direction, realizedR, mistakes, note });
    el("tSymbol").value = "";
    el("tR").value = "";
    el("tNote").value = "";
    // unselect chips
    [...el("mistakeChips").querySelectorAll("button")].forEach(b=>{
      b.classList.remove("bg-blue-600","hover:bg-blue-500");
      b.classList.add("bg-gray-900","hover:bg-gray-800");
    });
    await refreshData();
  } catch(e){
    el("tradeMsg").textContent = e.message || String(e);
  }
}

async function saveDailyReview(){
  el("dailyMsg").textContent = "";
  const dateIso = todayISO();
  const sig = computeDailySignals(dateIso);

  const resp = (el("dailyResponse").value||"").trim();
  if(!resp){
    el("dailyMsg").textContent = "Write something. One honest paragraph beats ten fake ones.";
    return;
  }

  try{
    await dbUpsertJournal(dateIso, currentPrompt.id, resp, sig);
    await refreshData();
    hide(el("dailyModal"));
  } catch(e){
    el("dailyMsg").textContent = e.message || String(e);
  }
}

async function saveFreeWrite(){
  el("freeMsg").textContent = "";
  const text = (el("freeWriteText").value||"").trim();
  if(!text) return;
  try{
    await dbInsertFreeWrite(todayISO(), text);
    el("freeWriteText").value = "";
    await refreshData();
  } catch(e){
    el("freeMsg").textContent = e.message || String(e);
  }
}

/* =========================================
   Events
   ========================================= */
el("loginBtn").addEventListener("click", login);
el("signupBtn").addEventListener("click", signup);
el("logoutBtn").addEventListener("click", logout);

el("saveProfileBtn").addEventListener("click", saveProfile);

el("addTradeBtn").addEventListener("click", addTrade);
el("refreshBtn").addEventListener("click", refreshData);

el("dailyReviewBtn").addEventListener("click", ()=>openDailyReview(false));
el("dailyClose").addEventListener("click", ()=>hide(el("dailyModal")));
el("dailyNew").addEventListener("click", ()=>openDailyReview(true));
el("dailySave").addEventListener("click", saveDailyReview);

el("freeWriteSave").addEventListener("click", saveFreeWrite);

// Enter-to-login convenience
el("authPass").addEventListener("keydown",(e)=>{ if(e.key==="Enter") login(); });

// Boot on load
boot();

</script>
</body>
</html>
