<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradeCheck | Discipline + Post-Trade Review</title>

  <!-- UI (keep the TradeCheck_UI_Redesign vibe) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PWA (use RELATIVE paths for GitHub Pages) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#030712">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TradeCheck">

  <style>
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
    }
    .card{
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      backdrop-filter: blur(10px);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 12px 48px rgba(0,0,0,0.2); }
    .chip{ border: 1px solid rgba(255,255,255,0.10); transition: all 0.2s; }
    .chip:hover{ transform: scale(1.05); }
    .disabled{ opacity: 0.55; cursor: not-allowed; }

    .glass{
      background: rgba(17, 25, 40, 0.75);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.125);
    }

    .gradient-blue{ background: linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(37,99,235,0.1) 100%); }
    .gradient-green{ background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(5,150,105,0.1) 100%); }
    .gradient-amber{ background: linear-gradient(135deg, rgba(251,191,36,0.2) 0%, rgba(245,158,11,0.1) 100%); }
    .gradient-red{ background: linear-gradient(135deg, rgba(239,68,68,0.2) 0%, rgba(220,38,38,0.1) 100%); }

    .btn-primary{
      background: linear-gradient(135deg, rgb(59,130,246), rgb(37,99,235));
      transition: all 0.2s;
    }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59,130,246,0.4); }
    .btn-primary:active{ transform: translateY(0); }

    .stat-number{
      font-size: 2.4rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-enter{ animation: modalSlideUp 0.25s cubic-bezier(0.4,0,0.2,1); }
    @keyframes modalSlideUp{ from{ opacity:0; transform: translateY(28px);} to{opacity:1; transform: translateY(0);} }

    .risk-meter{ height: 14px; border-radius: 9999px; background: rgba(31,41,55,1); overflow:hidden; position:relative; }
    .risk-meter-fill{ height:100%; transition: all 0.5s cubic-bezier(0.4,0,0.2,1); }
    .risk-low{ background: linear-gradient(90deg, rgb(16,185,129), rgb(5,150,105)); box-shadow: 0 0 18px rgba(16,185,129,0.4); }
    .risk-medium{ background: linear-gradient(90deg, rgb(251,191,36), rgb(245,158,11)); box-shadow: 0 0 18px rgba(251,191,36,0.35); }
    .risk-high{ background: linear-gradient(90deg, rgb(239,68,68), rgb(220,38,38)); box-shadow: 0 0 18px rgba(239,68,68,0.35); animation: pulse 2s infinite; }
    @keyframes pulse{ 0%,100%{opacity:1;} 50%{opacity:0.75;} }

    .trade-card-win{ border-left: 4px solid rgb(16,185,129); background: linear-gradient(90deg, rgba(16,185,129,0.06), transparent); }
    .trade-card-loss{ border-left: 4px solid rgb(239,68,68); background: linear-gradient(90deg, rgba(239,68,68,0.06), transparent); }
    .trade-card-pending{ border-left: 4px solid rgb(107,114,128); background: linear-gradient(90deg, rgba(107,114,128,0.06), transparent); }

    /* Mobile bottom tabs */
    @media (max-width: 768px){
      body{ padding-bottom: 86px; }
      .mobile-tabs{
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 60;
        background: rgba(3, 7, 18, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(59,130,246,0.2);
        padding: 0.55rem;
        display: flex; justify-content: space-around; align-items: center;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
      }
      .tab-btn{
        display:flex; flex-direction:column; align-items:center; gap: 0.25rem;
        padding: 0.55rem 0.75rem; border-radius: 0.85rem;
        font-size: 0.72rem; font-weight: 600;
        color: rgb(156,163,175);
        transition: all 0.2s;
        min-width: 70px;
      }
      .tab-btn.active{ color: rgb(96,165,250); background: rgba(59,130,246,0.15); }
      .tab-ico{ width: 22px; height: 22px; }
      .desktop-tabs{ display:none; }
    }
    @media (min-width: 769px){
      .mobile-tabs{ display:none; }
    }

    /* Desktop right-side tabs */
    .pill{
      padding: 0.55rem 0.9rem;
      border-radius: 9999px;
      background: rgba(31,41,55,0.6);
      border: 1px solid rgba(255,255,255,0.10);
      transition: all 0.2s;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(31,41,55,0.85); }
    .pill.active{ background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.35); color: rgb(147,197,253); }

    /* Inputs */
    .tc-in{
      background: rgb(3, 7, 18);
      border: 1px solid rgb(55, 65, 81);
      border-radius: 0.9rem;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      outline: none;
      transition: box-shadow .15s, border-color .15s;
      width: 100%;
    }
    .tc-in:focus{ border-color: rgba(59,130,246,0.9); box-shadow: 0 0 0 2px rgba(59,130,246,0.25); }
    .tc-label{ font-size: 0.75rem; color: rgb(156,163,175); font-weight: 600; }
    .tc-help{ font-size: 0.75rem; color: rgb(107,114,128); }

    /* Toast */
    .toast{
      position: fixed; right: 16px; top: 16px; z-index: 100;
      max-width: 360px;
      background: rgba(17,25,40,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(16px);
      border-radius: 1rem;
      padding: 0.9rem 1rem;
      box-shadow: 0 14px 48px rgba(0,0,0,0.35);
      display: none;
    }
    .toast.show{ display:block; animation: modalSlideUp .18s ease-out; }
  </style>
</head>

<body class="text-gray-100 min-h-screen">
  <!-- TOAST -->
  <div id="toast" class="toast">
    <div class="flex items-start gap-3">
      <div id="toastDot" class="w-3 h-3 rounded-full mt-1.5 bg-blue-500"></div>
      <div class="flex-1">
        <div id="toastTitle" class="font-bold text-sm">—</div>
        <div id="toastMsg" class="text-xs text-gray-300 mt-1 leading-relaxed">—</div>
      </div>
      <button id="toastX" class="text-gray-300 hover:text-white text-lg leading-none">✕</button>
    </div>
  </div>

  <!-- AUTH GATE -->
  <div id="authGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-3xl glass p-8 modal-enter">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center font-bold text-xl shadow-lg">TC</div>
        <div>
          <div class="font-bold text-lg leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Sign in to continue</div>
        </div>
      </div>

      <div class="space-y-3">
        <input id="authEmail" type="email" class="tc-in" placeholder="Email" autocomplete="email">
        <input id="authPass" type="password" class="tc-in" placeholder="Password (6+ chars)" autocomplete="current-password">
      </div>

      <button id="loginBtn" class="mt-4 w-full px-4 py-3 rounded-xl btn-primary text-sm font-semibold">Login</button>
      <button id="signupBtn" class="mt-3 w-full px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Sign up</button>

      <div id="authMsg" class="text-xs text-red-300 mt-3 text-center"></div>
      <div class="text-xs text-gray-500 mt-4">
        Tip: GitHub Pages is static. Supabase is your backend.
      </div>
    </div>
  </div>

  <!-- ONBOARDING GATE -->
  <div id="onboardingGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 p-4">
    <div class="w-full max-w-2xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-bold">Create your first strategy</div>
          <div class="text-sm text-gray-400 mt-1">No strategies, no trades. Build the rules first.</div>
        </div>
        <button id="onboardLogout" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Logout</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <div>
          <label class="tc-label">Strategy name</label>
          <input id="obName" class="tc-in mt-2" placeholder="e.g., NY ORB Reversal">
        </div>
        <div>
          <label class="tc-label">Timeframe</label>
          <select id="obTF" class="tc-in mt-2">
            <option value="">Select</option>
            <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
          </select>
        </div>
      </div>

      <div class="mt-6">
        <label class="tc-label">Checklist rules</label>
        <div id="obRulesList" class="mt-3 space-y-2"></div>
        <button type="button" id="obAddRuleBtn" class="mt-3 w-full px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">
          + Add rule
        </button>
        <div class="tc-help mt-2">Weights: Core=3, Confluence=2, Filter=1.</div>
      </div>

      <div class="mt-6">
        <button id="finishOnboardingBtn" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">Create strategy & continue</button>
      </div>

      <div id="obMsg" class="text-xs text-red-300 mt-3 text-center"></div>
    </div>
  </div>

  <!-- Desktop Header -->
  <header class="sticky top-0 z-10 glass border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center font-bold shadow-lg">TC</div>
        <div>
          <div class="font-bold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Discipline + Post-Trade Review</div>
        </div>
      </div>

      <div class="hidden md:flex items-center gap-2 desktop-tabs">
        <button class="pill active" data-tab="goals">Goals</button>
        <button class="pill" data-tab="review">Daily Review</button>
        <button class="pill" data-tab="analytics">Analytics</button>
        <button class="pill" data-tab="settings">Settings</button>
        <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Logout</button>
      </div>

      <div class="flex md:hidden items-center gap-2">
        <button id="logoutBtnMobile" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Logout</button>
      </div>
    </div>
  </header>

  <!-- Mobile Bottom Tabs -->
  <nav class="mobile-tabs">
    <button class="tab-btn active" data-tab="goals">
      <svg class="tab-ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
      <span>Goals</span>
    </button>
    <button class="tab-btn" data-tab="review">
      <svg class="tab-ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 11h12M8 15h12M4 7h.01M4 11h.01M4 15h.01"/></svg>
      <span>Review</span>
    </button>
    <button class="tab-btn" data-tab="analytics">
      <svg class="tab-ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19v-6a2 2 0 012-2h2a2 2 0 012 2v6m0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2M4 19a2 2 0 002 2h2a2 2 0 002-2"/></svg>
      <span>Stats</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <svg class="tab-ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.983 13.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06A1.65 1.65 0 004.6 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 008.9 4.6 1.65 1.65 0 0010.41 3H10.5a2 2 0 014 0h-.09A1.65 1.65 0 0016 4.6a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06A1.65 1.65 0 0019.4 9c.24.5.36 1.05.35 1.6a1.65 1.65 0 001.25 1.4H21a2 2 0 010 4h-.09A1.65 1.65 0 0019.4 15z"/></svg>
      <span>Settings</span>
    </button>
  </nav>

  <!-- Main (Core idea: Parts 1–4) -->
  <main id="mainApp" class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- HERO -->
    <section class="rounded-3xl border border-gray-800 glass p-8">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div>
          <div id="greetingLine" class="text-3xl font-black">Trade your plan.</div>
          <div id="subGreeting" class="text-sm text-gray-400 mt-2">Less “maybe”. More “because my rules said so”.</div>
          <div id="quoteLine" class="text-sm text-blue-400 mt-3 italic font-medium">—</div>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="rounded-2xl border border-gray-800 gradient-blue p-5 min-w-[240px]">
            <div class="text-xs text-gray-400 font-medium">Daily Review</div>
            <div id="dailyReviewStatus" class="text-xl font-bold mt-1">—</div>
            <div id="dailyReviewHint" class="text-xs text-gray-500 mt-2">—</div>
          </div>
          <div class="rounded-2xl border border-gray-800 gradient-amber p-5 min-w-[240px]">
            <div class="text-xs text-gray-400 font-medium">Today's focus</div>
            <div id="todayFocusLine" class="text-sm text-gray-200 mt-2 font-semibold">Log only A/B trades. Review the rest.</div>
          </div>
        </div>
      </div>

      <!-- Risk strip -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Daily Loss Limit</div>
          <div class="mt-3">
            <div class="flex items-baseline gap-2">
              <span id="dailyPnL" class="text-2xl font-bold">$0</span>
              <span id="dailyPnLLimit" class="text-xs text-gray-500">/ $500</span>
            </div>
            <div class="risk-meter mt-3"><div id="riskMeterFill" class="risk-meter-fill risk-low" style="width:0%"></div></div>
          </div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Trades Today</div>
          <div class="mt-3 flex items-baseline gap-2">
            <span id="tradesToday" class="text-2xl font-bold">0</span>
            <span id="tradesLimit" class="text-xs text-gray-500">/ 5 max</span>
          </div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Disciplined Streak</div>
          <div class="mt-3 flex items-baseline gap-2">
            <span id="currentStreak" class="text-2xl font-bold">0</span>
            <span class="text-xs text-gray-500">PD days</span>
          </div>
        </div>
      </div>
    </section>

    <!-- PARTS 1–4 -->
    <section class="rounded-3xl border border-gray-800 glass p-8">
      <div class="flex items-start justify-between flex-col lg:flex-row gap-4">
        <div>
          <div class="text-2xl font-bold">The only flow that matters</div>
          <div class="text-sm text-gray-400 mt-1">1) Strategy. 2) Checklist. 3) Log trade. 4) Post review.</div>
        </div>
        <div class="flex gap-2">
          <button id="jumpStrategy" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">1. Strategy</button>
          <button id="jumpTrade" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">2–3. Trade</button>
          <button id="jumpPost" class="px-4 py-2 rounded-xl btn-primary text-sm font-bold">4. Post Review</button>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-gray-800 gradient-blue p-6">
          <div class="text-xs text-blue-200 font-bold">PART 1</div>
          <div class="text-lg font-bold mt-2">Build your strategy</div>
          <div class="text-sm text-gray-300 mt-2">Rules + weights. No vibes.</div>
        </div>
        <div class="rounded-2xl border border-gray-800 gradient-amber p-6">
          <div class="text-xs text-amber-200 font-bold">PART 2–3</div>
          <div class="text-lg font-bold mt-2">Pre-trade checklist</div>
          <div class="text-sm text-gray-300 mt-2">Score your entry before saving.</div>
        </div>
        <div class="rounded-2xl border border-gray-800 gradient-green p-6">
          <div class="text-xs text-emerald-200 font-bold">PART 4</div>
          <div class="text-lg font-bold mt-2">Post-trade review</div>
          <div class="text-sm text-gray-300 mt-2">Outcome + mistakes + one lesson.</div>
        </div>
      </div>
    </section>

    <!-- PART 1: Strategy Builder -->
    <section id="sectionStrategy" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card rounded-3xl glass border border-gray-800 p-8">
        <div class="flex items-center justify-between gap-3 flex-col md:flex-row">
          <div>
            <div class="text-2xl font-bold">Strategy Builder</div>
            <div class="text-sm text-gray-400 mt-1">Each checklist item has weight 1–3.</div>
          </div>
          <button id="newStrategyBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold w-full md:w-auto">New Strategy</button>
        </div>

        <div id="strategyCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>

        <div id="strategyFormWrap" class="hidden mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Create Strategy</div>
            <button id="cancelStrategyBtn" class="text-sm text-gray-300 hover:text-white transition">Cancel</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="tc-label">Strategy name</label>
              <input id="sName" class="tc-in mt-2" placeholder="e.g., ORB Reversal"/>
            </div>
            <div>
              <label class="tc-label">Timeframe</label>
              <select id="sTF" class="tc-in mt-2">
                <option value="">Select</option>
                <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Checklist items</div>
                <div class="tc-help">Rule text + weight (1–3)</div>
              </div>
              <button id="addRuleBtn" class="px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Add rule</button>
            </div>
            <div id="rulesList" class="mt-3 space-y-2"></div>
          </div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="saveStrategyBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold">Save</button>
          </div>
        </div>
      </div>

      <div class="card rounded-3xl glass border border-gray-800 p-8">
        <div class="text-xl font-bold">Quick rules</div>
        <div class="text-sm text-gray-400 mt-1">If you can’t say it, you can’t trade it.</div>
        <div class="mt-6 space-y-3 text-sm text-gray-300">
          <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-4">
            <div class="font-semibold">Weight 3 (Core)</div>
            <div class="tc-help mt-1">Trend, key level, rejection confirmation.</div>
          </div>
          <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-4">
            <div class="font-semibold">Weight 2 (Confluence)</div>
            <div class="tc-help mt-1">Volume, VWAP, HTF alignment.</div>
          </div>
          <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-4">
            <div class="font-semibold">Weight 1 (Filter)</div>
            <div class="tc-help mt-1">News, chop, time of day.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 2–3: Trade Entry + Trades -->
    <section id="sectionTrade" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 card rounded-3xl glass border border-gray-800 p-8">
        <div>
          <div class="text-xl font-bold">Trade Entry</div>
          <div class="text-sm text-gray-400 mt-1">No entry/stop/target fields. This is discipline, not math class.</div>
        </div>

        <form id="tradeForm" class="mt-6 space-y-4">
          <div>
            <label class="tc-label">Strategy (required)</label>
            <select id="tStrategy" class="tc-in mt-2">
              <option value="">Select</option>
            </select>
          </div>

          <div>
            <label class="tc-label">Setup Type</label>
            <select id="tSetup" class="tc-in mt-2">
              <option value="">Select</option>
              <option>ORB</option>
              <option>Reversal</option>
              <option>Breakout</option>
              <option>Continuation</option>
              <option>Pullback</option>
              <option>Scalp</option>
              <option>Swing</option>
              <option>Other</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="tc-label">Symbol</label>
              <input id="tSymbol" class="tc-in mt-2" placeholder="AAPL / MNQ"/>
            </div>
            <div>
              <label class="tc-label">Session</label>
              <select id="tSession" class="tc-in mt-2">
                <option>London</option><option>NY</option><option>ORB</option><option>Other</option>
              </select>
            </div>
          </div>

          <div>
            <label class="tc-label">Date</label>
            <input id="tDate" type="date" class="tc-in mt-2">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="tc-label">Risk ($)</label>
              <input id="tRisk" type="number" step="0.01" class="tc-in mt-2" placeholder="e.g., 200">
            </div>
            <div>
              <label class="tc-label">Confidence</label>
              <select id="tConfidence" class="tc-in mt-2">
                <option value="1">Low</option>
                <option value="2" selected>Medium</option>
                <option value="3">High</option>
              </select>
            </div>
          </div>

          <div>
            <label class="tc-label">Screenshot</label>
            <input id="tShot" type="file" accept="image/*" class="mt-2 w-full text-sm text-gray-300">
            <div class="tc-help mt-1">Saved locally (base64). If you later want cloud storage, we can wire Supabase Storage.</div>
          </div>

          <div>
            <label class="tc-label">Notes</label>
            <textarea id="tNotes" rows="2" class="tc-in mt-2" placeholder="Context, plan, or the one thing you must not do."></textarea>
          </div>

          <button type="button" id="preTradeBtn" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">
            Pre-trade checklist
          </button>
          <div class="tc-help">Saves only after scoring the checklist.</div>
        </form>
      </div>

      <div class="lg:col-span-2 card rounded-3xl glass border border-gray-800 p-8">
        <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
          <div>
            <div class="text-xl font-bold">Trades</div>
            <div class="text-sm text-gray-400 mt-1">Post-trade review makes the analytics honest.</div>
          </div>
          <div class="flex gap-2">
            <button id="exportBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Export</button>
          </div>
        </div>

        <div id="tradesList" class="mt-6 space-y-4"></div>
        <div id="emptyTrades" class="mt-6 text-sm text-gray-400">No trades yet. That’s either discipline or denial. Add one.</div>
      </div>
    </section>
  </main>

  <!-- TAB CONTENT (bottom partitions) -->
  <section id="tab_goals" class="hidden max-w-7xl mx-auto px-4 pb-24 md:pb-8">
    <div class="rounded-3xl border border-gray-800 glass p-8 mt-8">
      <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
        <div>
          <div class="text-2xl font-bold">Goals & Achievements</div>
          <div class="text-sm text-gray-400 mt-1">Track progress. Celebrate real wins, not hopium.</div>
        </div>
        <button id="addGoalOpen" class="px-4 py-2 rounded-xl btn-primary text-sm font-bold w-full md:w-auto">Add Goal</button>
      </div>

      <div id="goalsList" class="mt-6 space-y-4"></div>

      <div class="mt-8">
        <div class="text-lg font-bold">Achievements</div>
        <div class="text-sm text-gray-400 mt-1">Automatically unlocked. You can’t buy these.</div>
        <div id="achievementsList" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>
  </section>

  <section id="tab_review" class="hidden max-w-7xl mx-auto px-4 pb-24 md:pb-8">
    <div class="rounded-3xl border border-gray-800 glass p-8 mt-8">
      <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
        <div>
          <div class="text-2xl font-bold">Daily Review</div>
          <div class="text-sm text-gray-400 mt-1">Five minutes. One score. One lesson.</div>
        </div>
        <button id="openDailyModal" class="px-4 py-2 rounded-xl btn-primary text-sm font-bold w-full md:w-auto">Do Today's Review</button>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="text-xs text-gray-400 font-semibold">Today's Status</div>
          <div id="dailyStatusCard" class="text-xl font-bold mt-2">—</div>
          <div id="dailyStatusHint" class="tc-help mt-2">—</div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6 lg:col-span-2">
          <div class="text-sm font-bold">Recent Reviews</div>
          <div id="recentDaily" class="mt-4 space-y-3"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="tab_analytics" class="hidden max-w-7xl mx-auto px-4 pb-24 md:pb-8">
    <div class="rounded-3xl border border-gray-800 glass p-8 mt-8">
      <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
        <div>
          <div class="text-2xl font-bold">Analytics</div>
          <div class="text-sm text-gray-400 mt-1">Simple, useful, and mildly insulting.</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 w-full md:w-auto">
          <div>
            <label class="tc-label">Strategy</label>
            <select id="filterStrategy" class="tc-in mt-2">
              <option value="ALL">All strategies</option>
            </select>
          </div>
          <div>
            <label class="tc-label">Setup</label>
            <select id="filterSetup" class="tc-in mt-2">
              <option value="ALL">All setups</option>
            </select>
          </div>
          <div>
            <label class="tc-label">Session</label>
            <select id="filterSession" class="tc-in mt-2">
              <option value="ALL">All</option>
              <option value="London">London</option>
              <option value="NY">NY</option>
              <option value="ORB">ORB</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="tc-label">Day</label>
            <select id="filterDOW" class="tc-in mt-2">
              <option value="ALL">All</option>
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="card rounded-3xl glass border border-gray-800 p-6">
          <div class="text-sm text-gray-400 font-medium">Trades (filtered)</div>
          <div id="statTotalTrades" class="stat-number mt-3">0</div>
        </div>
        <div class="card rounded-3xl glass border border-gray-800 p-6">
          <div class="text-sm text-gray-400 font-medium">Avg Pre Score</div>
          <div id="statAvgScore" class="stat-number mt-3">0%</div>
        </div>
        <div class="card rounded-3xl glass border border-gray-800 p-6">
          <div class="text-sm text-gray-400 font-medium">Win Rate</div>
          <div id="statWinRate" class="stat-number mt-3">0%</div>
        </div>
        <div class="card rounded-3xl glass border border-gray-800 p-6">
          <div class="text-sm text-gray-400 font-medium">Avg Realized R</div>
          <div id="statAvgR" class="stat-number mt-3">0.00</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold">R Curve</div>
            <div class="text-xs text-gray-500">From completed post reviews</div>
          </div>
          <div class="mt-4"><canvas id="rChart" height="110"></canvas></div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="text-sm font-bold">Mistake Trend</div>
          <div class="text-xs text-gray-500 mt-1">Counts by day (filtered)</div>
          <div class="mt-4"><canvas id="mistakeTrendChart" height="150"></canvas></div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Score Distribution</div>
            <div class="text-xs text-gray-400">A/B/C by pre score</div>
          </div>
          <div class="mt-4 space-y-3" id="distBars"></div>
        </div>

        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Avg R by Grade</div>
            <div class="text-xs text-gray-400">completed reviews</div>
          </div>
          <div class="mt-4 space-y-3" id="rBars"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="tab_settings" class="hidden max-w-7xl mx-auto px-4 pb-24 md:pb-8">
    <div class="rounded-3xl border border-gray-800 glass p-8 mt-8">
      <div class="flex items-start justify-between gap-4 flex-col md:flex-row">
        <div>
          <div class="text-2xl font-bold">Settings</div>
          <div class="text-sm text-gray-400 mt-1">Risk limits + notifications. Keep it boring. Boring is profitable.</div>
        </div>
        <button id="saveSettingsBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-bold w-full md:w-auto">Save</button>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg mb-4">Risk Management</div>
          <div class="space-y-4">
            <div>
              <label class="tc-label">Daily Loss Limit ($)</label>
              <input id="settingDailyLossLimit" type="number" step="10" class="tc-in mt-2" placeholder="500">
            </div>
            <div>
              <label class="tc-label">Max Trades Per Day</label>
              <input id="settingMaxTrades" type="number" step="1" class="tc-in mt-2" placeholder="5">
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Hard Stop Mode</div>
                <div class="tc-help">Block logging trades after hitting limits</div>
              </div>
              <input id="settingHardStop" type="checkbox" class="w-5 h-5">
            </div>
          </div>
        </div>

        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg mb-4">Notifications</div>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Daily Review Reminder</div>
                <div class="tc-help">Shows a reminder when you open the app after 8:00 PM</div>
              </div>
              <input id="notifDailyReview" type="checkbox" class="w-5 h-5">
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Risk Limit Warnings</div>
                <div class="tc-help">Toast warnings as you approach limits</div>
              </div>
              <input id="notifRiskLimit" type="checkbox" class="w-5 h-5">
            </div>
            <button id="requestNotifPermission" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">Enable Browser Notifications</button>
            <div class="tc-help">
              Real scheduled push requires a server or push service. This app stays simple.
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between gap-2">
        <button id="resetBtn" class="px-6 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-sm font-bold transition">Reset Local Cache</button>
        <button id="exportJsonBtn" class="px-6 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-bold transition">Export JSON</button>
      </div>

      <div class="mt-6 text-xs text-gray-500">
        Supabase sync: table <span class="font-semibold text-gray-300">app_state</span> with columns <span class="font-semibold text-gray-300">user_id</span>, <span class="font-semibold text-gray-300">state</span>, <span class="font-semibold text-gray-300">updated_at</span>.
        If your table differs, edit <span class="font-semibold text-gray-300">loadStateRemote/saveStateRemote</span> below.
      </div>
    </div>
  </section>

  <!-- MODALS -->

  <!-- Add Goal Modal -->
  <div id="modalGoal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-lg rounded-3xl glass p-8 modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Add Goal</div>
          <div class="text-sm text-gray-400 mt-1">Keep it measurable.</div>
        </div>
        <button id="goalClose" class="text-gray-300 hover:text-white text-2xl transition">✕</button>
      </div>

      <div class="mt-6 space-y-4">
        <div>
          <label class="tc-label">Goal Type</label>
          <select id="goalType" class="tc-in mt-2">
            <option value="monthly_r">Monthly R-Multiple</option>
            <option value="win_rate">Win Rate</option>
            <option value="pd_streak">PD Streak</option>
            <option value="a_grade_trades">A-Grade Trades</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div>
          <label class="tc-label">Target Value</label>
          <input id="goalTarget" type="number" step="0.1" class="tc-in mt-2" placeholder="e.g., 10">
        </div>
        <div>
          <label class="tc-label">Description</label>
          <input id="goalDesc" class="tc-in mt-2" placeholder="e.g., Hit 10R this month without revenge trades">
        </div>
      </div>

      <button id="addGoalBtn" class="mt-6 w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">Add Goal</button>
      <div id="goalMsg" class="text-xs text-red-300 mt-3 text-center"></div>
    </div>
  </div>

  <!-- Pre-trade Modal -->
  <div id="modalPre" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-3xl rounded-3xl glass p-8 modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Pre-trade Checklist</div>
          <div class="text-sm text-gray-400 mt-1">Score before saving.</div>
        </div>
        <button id="preClose" class="text-gray-300 hover:text-white text-2xl transition">✕</button>
      </div>

      <div id="preWarn" class="hidden mt-6 rounded-2xl border px-6 py-4 text-sm"></div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Checklist (weighted)</div>
          <div class="tc-help mt-1">Check what you truly have.</div>
          <div id="preRules" class="mt-4 space-y-3"></div>
        </div>

        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Predicted Score</div>
          <div class="mt-4">
            <div class="text-5xl font-black" id="preScore">0%</div>
            <div class="text-sm text-gray-400 mt-2" id="preGrade">Grade: C</div>
          </div>

          <div class="mt-6 text-sm text-gray-300 space-y-2">
            <div><span class="text-gray-400">Strategy:</span> <span id="preStrategy" class="font-semibold">—</span></div>
            <div><span class="text-gray-400">Confidence:</span> <span id="preConf" class="font-semibold">—</span></div>
          </div>

          <div class="mt-6 flex items-center gap-3">
            <button id="saveTradeBtn" class="flex-1 px-4 py-3 rounded-xl btn-primary text-sm font-bold">Save trade</button>
            <button id="preCancel" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">Cancel</button>
          </div>

          <div class="tc-help mt-4">
            If Hard Stop is enabled and you hit your limits, saving is blocked. Good.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-trade Review Modal -->
  <div id="modalPost" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-6xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Post-trade Review</div>
          <div id="postSub" class="text-sm text-gray-400 mt-1">Outcome + mistakes + one lesson.</div>
        </div>
        <button id="postClose" class="text-gray-300 hover:text-white text-2xl transition">✕</button>
      </div>

      <div id="postLockMsg" class="hidden mt-6 rounded-2xl border border-red-500/30 gradient-red px-6 py-4 text-sm text-red-200"></div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Trade Snapshot</div>
          <div class="tc-help mt-1" id="postMeta">—</div>
          <div class="mt-4">
            <img id="postImg" class="hidden rounded-xl border border-gray-800 max-h-80 object-contain w-full bg-black" alt="chart">
            <div id="postNoImg" class="text-sm text-gray-500">No screenshot saved for this trade.</div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl gradient-blue border border-blue-500/20 p-4">
              <div class="text-xs text-blue-300 font-semibold">Pre Score</div>
              <div class="text-2xl font-bold mt-1" id="postPreScore">—</div>
            </div>
            <div class="rounded-xl gradient-green border border-emerald-500/20 p-4">
              <div class="text-xs text-emerald-300 font-semibold">Post Score</div>
              <div class="text-2xl font-bold mt-1" id="postPostScore">—</div>
            </div>
          </div>
          <div class="tc-help mt-3" id="postDelta">—</div>
        </div>

        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Post Checklist</div>
          <div class="tc-help mt-1">What actually happened.</div>
          <div id="postRules" class="mt-4 space-y-3"></div>
        </div>

        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Outcome</div>
          <div class="tc-help mt-1">Structured input = usable analytics.</div>

          <div class="mt-4 space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="tc-label">Result</label>
                <select id="prResult" class="tc-in mt-2">
                  <option value="">Select</option>
                  <option value="win">Win</option>
                  <option value="loss">Loss</option>
                  <option value="be">Break-even</option>
                </select>
              </div>
              <div>
                <label class="tc-label">Realized R</label>
                <input id="prR" type="number" step="0.01" class="tc-in mt-2" placeholder="e.g., 1.50 or -1.00">
              </div>
            </div>

            <div>
              <div class="tc-label mb-2">Mistake tags</div>
              <div id="mistakeChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div>
              <label class="tc-label">One-sentence lesson (required)</label>
              <input id="prLesson" maxlength="120" class="tc-in mt-2" placeholder="Next time I will...">
              <div class="tc-help mt-1">Max 120 characters. No novels. No coping.</div>
            </div>

            <div class="flex items-center gap-3 pt-2">
              <button id="savePostBtn" class="flex-1 px-4 py-3 rounded-xl btn-primary text-sm font-bold">Save post review</button>
              <button id="postCancel" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">Cancel</button>
            </div>

            <div class="tc-help">
              Post review locks 24 hours after you save it.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Review Modal -->
  <div id="modalDaily" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-3xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Daily Review</div>
          <div class="text-sm text-gray-400 mt-1">One score. One sentence. Done.</div>
        </div>
        <button id="dailyClose" class="text-gray-300 hover:text-white text-2xl transition">✕</button>
      </div>

      <div class="mt-6 space-y-4">
        <div>
          <label class="tc-label">Date</label>
          <input id="drDate" type="date" class="tc-in mt-2">
        </div>
        <div>
          <label class="tc-label">Discipline score (0–100)</label>
          <input id="drScore" type="number" min="0" max="100" class="tc-in mt-2" placeholder="e.g., 78">
          <div class="tc-help mt-1">This is about process, not PnL.</div>
        </div>
        <div>
          <label class="tc-label">One lesson</label>
          <input id="drLesson" maxlength="120" class="tc-in mt-2" placeholder="Today I learned...">
        </div>
        <div>
          <label class="tc-label">Notes (optional)</label>
          <textarea id="drNotes" rows="3" class="tc-in mt-2" placeholder="Quick notes. Keep it short."></textarea>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button id="saveDailyBtn" class="flex-1 px-4 py-3 rounded-xl btn-primary text-sm font-bold">Save Daily Review</button>
        <button id="dailyCancel" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">Cancel</button>
      </div>
      <div id="dailyMsg" class="text-xs text-red-300 mt-3 text-center"></div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="modalExport" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-md rounded-3xl glass p-8 modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Export</div>
          <div class="text-sm text-gray-400 mt-1">Get your data out. Always.</div>
        </div>
        <button id="exportClose" class="text-gray-300 hover:text-white text-2xl transition">✕</button>
      </div>

      <div class="mt-6 space-y-3">
        <button id="exportAllCSV" class="w-full px-6 py-4 rounded-2xl bg-gray-800 hover:bg-gray-700 text-left transition">
          <div class="font-semibold">Export Trades (CSV)</div>
          <div class="text-xs text-gray-400 mt-1">Trades + reviews</div>
        </button>
        <button id="exportAllJSON" class="w-full px-6 py-4 rounded-2xl bg-gray-800 hover:bg-gray-700 text-left transition">
          <div class="font-semibold">Export Full State (JSON)</div>
          <div class="text-xs text-gray-400 mt-1">Everything in one file</div>
        </button>
      </div>
    </div>
  </div>

  <script>
  // -----------------------------
  // CONFIG: Paste your Supabase keys
  // -----------------------------
  const SUPABASE_URL = "https://hfnpqamhtxhhsrwmngtv.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_2im62kUUfZ_WLgaHuNmP7w_vFsuE0QV";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // -----------------------------
  // PWA: service worker
  // -----------------------------
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(console.warn);
  }

  // -----------------------------
  // DOM helpers
  // -----------------------------
  const $ = (id) => document.getElementById(id);
  const show = (el) => { if(!el) return; el.classList.remove("hidden"); el.classList.add("flex"); };
  const hide = (el) => { if(!el) return; el.classList.add("hidden"); el.classList.remove("flex"); };

  // Toast
  let toastTimer = null;
  function toast(title, msg, type="info"){
    const t = $("toast"), dot = $("toastDot"), tt = $("toastTitle"), tm = $("toastMsg");
    if(!t) return;
    tt.textContent = title || "";
    tm.textContent = msg || "";
    dot.className = "w-3 h-3 rounded-full mt-1.5 " + (type==="ok" ? "bg-emerald-500" : type==="bad" ? "bg-red-500" : "bg-blue-500");
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.classList.remove("show"), 3800);
  }
  $("toastX").onclick = () => $("toast").classList.remove("show");

  // -----------------------------
  // State model
  // -----------------------------
  const LS_KEY = "tradecheck_state_v3";
  let state = null;
  let currentUserId = "";
  let currentEmail = "";
  let currentUser = "Trader";

  const DEFAULT_STATE = () => ({
    version: 3,
    strategies: [],
    trades: [],
    dailyReviews: [],
    goals: [],
    achievements: [],
    settings: {
      dailyLossLimit: 500,
      maxTrades: 5,
      hardStop: true,
      notifDailyReview: true,
      notifRiskLimit: true
    }
  });

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return DEFAULT_STATE();
      const parsed = JSON.parse(raw);
      return mergeDefaults(parsed);
    }catch(e){
      return DEFAULT_STATE();
    }
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    // fire and forget remote
    if(currentUserId) saveStateRemote(state).catch(()=>{});
  }

  function mergeDefaults(s){
    const d = DEFAULT_STATE();
    const out = { ...d, ...(s||{}) };
    out.settings = { ...d.settings, ...(s?.settings||{}) };
    out.strategies = Array.isArray(out.strategies) ? out.strategies : [];
    out.trades = Array.isArray(out.trades) ? out.trades : [];
    out.dailyReviews = Array.isArray(out.dailyReviews) ? out.dailyReviews : [];
    out.goals = Array.isArray(out.goals) ? out.goals : [];
    out.achievements = Array.isArray(out.achievements) ? out.achievements : [];
    return out;
  }

  // -----------------------------
  // Supabase remote state (same pattern as your working file)
  // Table: app_state (user_id uuid PK, state jsonb, updated_at timestamptz)
  // -----------------------------
  async function loadStateRemote(){
    const { data, error } = await sb.from("app_state").select("state").eq("user_id", currentUserId).maybeSingle();
    if(error) throw error;
    return data?.state || null;
  }
  async function saveStateRemote(st){
    const payload = { user_id: currentUserId, state: st, updated_at: new Date().toISOString() };
    const { error } = await sb.from("app_state").upsert(payload);
    if(error) throw error;
  }

  async function bootSupabase(){
    try{
      const { data: { session } } = await sb.auth.getSession();
      if(!session){
        show($("authGate"));
        $("mainApp").classList.add("hidden");
        hide($("onboardingGate"));
        return;
      }
      hide($("authGate"));
      $("mainApp").classList.remove("hidden");

      currentUserId = session.user.id;
      currentEmail = session.user.email || "";
      currentUser = currentEmail ? currentEmail.split("@")[0] : "Trader";

      // Optional profile username
      try{
        const { data: prof } = await sb.from("profiles").select("username").eq("id", currentUserId).maybeSingle();
        if(prof?.username) currentUser = prof.username;
      }catch(e){}

      await loadUserState();
    }catch(e){
      show($("authGate"));
      $("authMsg").textContent = "Auth error. Refresh and try again.";
    }
  }

  async function loadUserState(){
    try{
      const remote = await loadStateRemote();
      const local = loadState();
      // simple merge rule: prefer remote if it has more trades (same as your working approach)
      if(remote && Array.isArray(remote.trades) && remote.trades.length > (local.trades?.length||0)){
        state = mergeDefaults(remote);
      }else{
        state = local;
      }
    }catch(e){
      state = loadState();
    }

    if(!state.strategies || state.strategies.length === 0){
      show($("onboardingGate"));
      $("mainApp").classList.add("hidden");
    }else{
      hide($("onboardingGate"));
      $("mainApp").classList.remove("hidden");
      renderAll();
      checkReminders();
    }
  }

  // -----------------------------
  // Auth UI
  // -----------------------------
  $("loginBtn").onclick = async () => {
    $("authMsg").textContent = "";
    const email = $("authEmail").value.trim();
    const password = $("authPass").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){ $("authMsg").textContent = error.message; return; }
    toast("Welcome back", "Now go be boring and consistent.", "ok");
    bootSupabase();
  };

  $("signupBtn").onclick = async () => {
    $("authMsg").textContent = "";
    const email = $("authEmail").value.trim();
    const password = $("authPass").value;
    const { error } = await sb.auth.signUp({ email, password });
    if(error){ $("authMsg").textContent = error.message; return; }
    $("authMsg").textContent = "Check your email to confirm, then login.";
  };

  async function doLogout(){
    await sb.auth.signOut();
    currentUserId = "";
    state = loadState(); // keep local cache
    show($("authGate"));
    $("mainApp").classList.add("hidden");
    hide($("onboardingGate"));
    toast("Logged out", "Local cache kept. Remote sync paused.", "info");
  }
  $("logoutBtn").onclick = doLogout;
  $("logoutBtnMobile").onclick = doLogout;
  $("onboardLogout").onclick = doLogout;

  // -----------------------------
  // Tabs
  // -----------------------------
  const tabIds = ["goals","review","analytics","settings"];
  function setTab(tab){
    // pills + mobile buttons
    document.querySelectorAll("[data-tab]").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-tab") === tab);
    });
    tabIds.forEach(t=>{
      const el = $("tab_"+t);
      if(!el) return;
      el.classList.toggle("hidden", t !== tab);
    });
    // hide main app when tab open (keeps "part 1-4" as main)
    $("mainApp").classList.toggle("hidden", tab !== ""); // if tab set -> hide main
    if(tab === "") $("mainApp").classList.remove("hidden");
    // render per tab
    if(tab === "goals") renderGoals();
    if(tab === "review") renderDailyTab();
    if(tab === "analytics") renderAnalytics();
    if(tab === "settings") renderSettings();
  }
  // default: show main app (not a tab)
  function closeTabs(){ tabIds.forEach(t=> $("tab_"+t).classList.add("hidden")); $("mainApp").classList.remove("hidden"); document.querySelectorAll("[data-tab]").forEach(b=>b.classList.remove("active")); }
  document.querySelectorAll("[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const t = btn.getAttribute("data-tab");
      setTab(t);
    });
  });

  // Jump buttons
  $("jumpStrategy").onclick = ()=> $("sectionStrategy").scrollIntoView({ behavior:"smooth", block:"start" });
  $("jumpTrade").onclick = ()=> $("sectionTrade").scrollIntoView({ behavior:"smooth", block:"start" });
  $("jumpPost").onclick = ()=> { toast("Post Review", "Open any trade and click Post Review.", "info"); };

  // -----------------------------
  // Onboarding builder
  // -----------------------------
  function ruleRowHTML(id, value="", weight=2){
    return `
      <div class="flex gap-2">
        <input data-ruletext="${id}" class="tc-in" placeholder="Rule text" value="${escapeHTML(value)}">
        <select data-rulew="${id}" class="tc-in" style="max-width:110px">
          <option value="3" ${weight==3?"selected":""}>3</option>
          <option value="2" ${weight==2?"selected":""}>2</option>
          <option value="1" ${weight==1?"selected":""}>1</option>
        </select>
        <button data-ruledel="${id}" type="button" class="px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-bold">✕</button>
      </div>
    `;
  }
  function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }

  let obRuleIds = [];
  function addObRule(text="", w=2){
    const id = crypto.randomUUID();
    obRuleIds.push(id);
    const wrap = document.createElement("div");
    wrap.innerHTML = ruleRowHTML(id, text, w);
    $("obRulesList").appendChild(wrap.firstElementChild);
    bindRuleDelete();
  }
  function bindRuleDelete(){
    document.querySelectorAll("[data-ruledel]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-ruledel");
        obRuleIds = obRuleIds.filter(x=>x!==id);
        btn.parentElement.remove();
      };
    });
  }
  $("obAddRuleBtn").onclick = ()=> addObRule("",2);

  // start with 3 rules
  addObRule("HTF bias aligned", 3);
  addObRule("At key level + rejection", 3);
  addObRule("VWAP not against me", 2);

  $("finishOnboardingBtn").onclick = async ()=>{
    $("obMsg").textContent = "";
    const name = $("obName").value.trim();
    const tf = $("obTF").value.trim();
    if(!name){ $("obMsg").textContent = "Strategy name required."; return; }
    if(!tf){ $("obMsg").textContent = "Timeframe required."; return; }

    const rules = [];
    obRuleIds.forEach(id=>{
      const t = document.querySelector(`[data-ruletext="${id}"]`)?.value?.trim() || "";
      const w = parseInt(document.querySelector(`[data-rulew="${id}"]`)?.value || "2", 10);
      if(t) rules.push({ text:t, w: isFinite(w)?w:2 });
    });
    if(rules.length === 0){ $("obMsg").textContent = "Add at least one rule."; return; }

    const strat = { id: crypto.randomUUID(), name, tf, rules, created_at: new Date().toISOString() };
    state = DEFAULT_STATE();
    state.strategies = [strat];
    saveState();
    hide($("onboardingGate"));
    $("mainApp").classList.remove("hidden");
    toast("Strategy created", "Now score entries before you donate.", "ok");
    renderAll();
  };

  // -----------------------------
  // Strategy builder (main)
  // -----------------------------
  let formRuleIds = [];
  function resetStrategyForm(){
    $("sName").value = "";
    $("sTF").value = "";
    $("rulesList").innerHTML = "";
    formRuleIds = [];
  }
  function addFormRule(text="", w=2){
    const id = crypto.randomUUID();
    formRuleIds.push(id);
    const wrap = document.createElement("div");
    wrap.innerHTML = ruleRowHTML(id, text, w);
    $("rulesList").appendChild(wrap.firstElementChild);
    bindRuleDelete();
  }

  $("newStrategyBtn").onclick = ()=>{
    $("strategyFormWrap").classList.remove("hidden");
    resetStrategyForm();
    addFormRule("",3);
    addFormRule("",2);
    addFormRule("",1);
  };
  $("cancelStrategyBtn").onclick = ()=> $("strategyFormWrap").classList.add("hidden");
  $("addRuleBtn").onclick = ()=> addFormRule("",2);

  $("saveStrategyBtn").onclick = ()=>{
    const name = $("sName").value.trim();
    const tf = $("sTF").value.trim();
    if(!name) return toast("Missing", "Strategy name required.", "bad");
    if(!tf) return toast("Missing", "Timeframe required.", "bad");

    const rules = [];
    formRuleIds.forEach(id=>{
      const t = document.querySelector(`[data-ruletext="${id}"]`)?.value?.trim() || "";
      const w = parseInt(document.querySelector(`[data-rulew="${id}"]`)?.value || "2", 10);
      if(t) rules.push({ text:t, w: isFinite(w)?w:2 });
    });
    if(!rules.length) return toast("Missing", "Add at least one rule.", "bad");

    const strat = { id: crypto.randomUUID(), name, tf, rules, created_at: new Date().toISOString() };
    state.strategies.unshift(strat);
    saveState();
    $("strategyFormWrap").classList.add("hidden");
    toast("Saved", "Strategy added.", "ok");
    renderAll();
  };

  function deleteStrategy(id){
    const used = state.trades.some(t=>t.strategy_id===id);
    if(used) return toast("Nope", "Strategy has trades. Delete trades first.", "bad");
    state.strategies = state.strategies.filter(s=>s.id!==id);
    saveState();
    renderAll();
  }

  function renderStrategies(){
    const wrap = $("strategyCards");
    wrap.innerHTML = "";
    (state.strategies||[]).forEach(s=>{
      const maxW = (s.rules||[]).reduce((a,r)=>a+(r.w||0),0) || 1;
      const card = document.createElement("div");
      card.className = "rounded-2xl border border-gray-800 bg-gray-950/50 p-5";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-bold text-lg">${escapeHTML(s.name)}</div>
            <div class="text-xs text-gray-400 mt-1">${escapeHTML(s.tf)} • ${s.rules.length} rules • max ${maxW} pts</div>
          </div>
          <button class="px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-bold" data-delstrat="${s.id}">✕</button>
        </div>
        <div class="mt-4 space-y-2">
          ${(s.rules||[]).slice(0,5).map(r=>`
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-200">${escapeHTML(r.text)}</span>
              <span class="text-xs text-gray-400">w${r.w||2}</span>
            </div>
          `).join("")}
          ${s.rules.length>5 ? `<div class="text-xs text-gray-500">+${s.rules.length-5} more…</div>`:""}
        </div>
      `;
      wrap.appendChild(card);
    });
    document.querySelectorAll("[data-delstrat]").forEach(b=>{
      b.onclick = ()=> deleteStrategy(b.getAttribute("data-delstrat"));
    });
  }

  // -----------------------------
  // Trade flow: pre-trade score then save
  // -----------------------------
  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }
  $("tDate").value = todayISO();

  function getStrategyById(id){ return state.strategies.find(s=>s.id===id) || null; }
  function gradeFromPct(p){
    if(p>=80) return "A";
    if(p>=65) return "B";
    return "C";
  }

  let preCtx = null; // filled before modal open
  $("preTradeBtn").onclick = ()=>{
    // validate core fields
    const strategy_id = $("tStrategy").value;
    const s = getStrategyById(strategy_id);
    if(!s) return toast("Missing", "Pick a strategy first.", "bad");

    const dt = $("tDate").value || todayISO();
    const risk = parseFloat($("tRisk").value || "0");
    const hardStop = !!state.settings.hardStop;
    if(hardStop && isHardStoppedForDate(dt)){
      return toast("Hard Stop", "You hit your daily limits. No more logging trades today.", "bad");
    }

    preCtx = {
      id: crypto.randomUUID(),
      strategy_id,
      setup: $("tSetup").value || "",
      symbol: ($("tSymbol").value || "").toUpperCase().trim(),
      session: $("tSession").value || "NY",
      date: dt,
      risk: isFinite(risk) ? risk : 0,
      confidence: parseInt($("tConfidence").value || "2", 10),
      notes: $("tNotes").value || "",
      screenshot: null,
      created_at: new Date().toISOString(),
      pre: { checked: {}, score: 0, grade: "C" },
      post: null
    };

    // screenshot -> base64
    const file = $("tShot").files && $("tShot").files[0] ? $("tShot").files[0] : null;
    if(file){
      const reader = new FileReader();
      reader.onload = ()=>{ preCtx.screenshot = reader.result; openPreModal(s); };
      reader.readAsDataURL(file);
    }else{
      openPreModal(s);
    }
  };

  function openPreModal(strategy){
    $("preRules").innerHTML = "";
    $("preWarn").classList.add("hidden");
    $("preScore").textContent = "0%";
    $("preGrade").textContent = "Grade: C";
    $("preStrategy").textContent = strategy.name;
    $("preConf").textContent = ["Low","Medium","High"][(preCtx.confidence||2)-1] || "Medium";

    strategy.rules.forEach((r, idx)=>{
      const id = "pre_rule_"+idx;
      const row = document.createElement("div");
      row.className = "flex items-center justify-between gap-3 rounded-xl border border-gray-800 bg-gray-900/40 px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start gap-3">
          <input type="checkbox" id="${id}" class="mt-1 w-5 h-5">
          <div>
            <div class="text-sm font-semibold text-gray-200">${escapeHTML(r.text)}</div>
            <div class="text-xs text-gray-500">weight ${r.w}</div>
          </div>
        </div>
      `;
      $("preRules").appendChild(row);
      row.querySelector("input").onchange = ()=> updatePreScore(strategy);
    });

    updatePreScore(strategy);
    show($("modalPre"));
  }

  function calcScore(strategy, checkedMap){
    const rules = strategy.rules || [];
    const maxPts = rules.reduce((a,r)=>a+(r.w||0),0) || 1;
    let got = 0;
    rules.forEach((r, idx)=>{
      if(checkedMap[idx]) got += (r.w||0);
    });
    const pct = Math.round((got / maxPts) * 100);
    return { pct, grade: gradeFromPct(pct), got, maxPts };
  }

  function updatePreScore(strategy){
    const checked = {};
    strategy.rules.forEach((r, idx)=>{
      const box = document.getElementById("pre_rule_"+idx);
      checked[idx] = !!box?.checked;
    });
    const sc = calcScore(strategy, checked);
    $("preScore").textContent = sc.pct + "%";
    $("preGrade").textContent = "Grade: " + sc.grade;

    preCtx.pre.checked = checked;
    preCtx.pre.score = sc.pct;
    preCtx.pre.grade = sc.grade;

    // warn if low
    const warn = sc.pct < 65;
    const btn = $("saveTradeBtn");
    btn.disabled = false;
    btn.classList.remove("disabled");
    if(warn){
      $("preWarn").classList.remove("hidden");
      $("preWarn").className = "mt-6 rounded-2xl border border-amber-500/30 gradient-amber px-6 py-4 text-sm text-amber-100";
      $("preWarn").textContent = "Score is low. If you still take it, at least admit you chose chaos.";
    }
  }

  $("preClose").onclick = ()=> hide($("modalPre"));
  $("preCancel").onclick = ()=> hide($("modalPre"));

  $("saveTradeBtn").onclick = ()=>{
    const dt = preCtx.date;
    if(state.settings.hardStop && isHardStoppedForDate(dt)){
      toast("Hard Stop", "Limits hit. Trade not saved.", "bad");
      return;
    }
    state.trades.unshift(preCtx);
    saveState();
    hide($("modalPre"));
    clearTradeForm();
    toast("Saved", `Trade logged (${preCtx.pre.grade}).`, "ok");
    renderAll();
  };

  function clearTradeForm(){
    $("tSetup").value = "";
    $("tSymbol").value = "";
    $("tSession").value = "NY";
    $("tRisk").value = "";
    $("tConfidence").value = "2";
    $("tShot").value = "";
    $("tNotes").value = "";
    $("tDate").value = todayISO();
  }

  function deleteTrade(id){
    state.trades = state.trades.filter(t=>t.id!==id);
    saveState();
    renderAll();
  }

  // -----------------------------
  // Post trade
  // -----------------------------
  const MISTAKES = [
    "FOMO", "Revenge", "No stop", "Early exit", "Late entry", "Oversize",
    "Ignored level", "Against VWAP", "No confirmation", "Chop", "News trade", "Moved stop"
  ];
  function renderMistakeChips(selected){
    $("mistakeChips").innerHTML = "";
    MISTAKES.forEach(m=>{
      const b = document.createElement("button");
      const on = selected.has(m);
      b.className = "chip px-3 py-2 rounded-xl text-xs font-semibold " + (on ? "bg-blue-600/30 text-blue-200 border-blue-500/40" : "bg-gray-800/60 text-gray-200");
      b.textContent = m;
      b.onclick = ()=>{
        if(selected.has(m)) selected.delete(m); else selected.add(m);
        renderMistakeChips(selected);
      };
      $("mistakeChips").appendChild(b);
    });
  }

  let postCtx = null;
  function openPostModal(trade){
    const strategy = getStrategyById(trade.strategy_id);
    if(!strategy) return toast("Missing", "Strategy not found for this trade.", "bad");

    postCtx = trade;
    const now = Date.now();
    const reviewedAt = trade.post?.reviewed_at ? new Date(trade.post.reviewed_at).getTime() : null;
    const locked = reviewedAt && (now - reviewedAt) > (24*60*60*1000);

    $("postMeta").textContent = `${trade.symbol||"—"} • ${trade.session||"—"} • ${trade.date} • ${strategy.name}`;
    $("postPreScore").textContent = (trade.pre?.score ?? "—") + "%";
    $("postPostScore").textContent = (trade.post?.score != null ? trade.post.score + "%" : "—");
    $("postDelta").textContent = trade.post?.score != null ? `Δ ${(trade.post.score - (trade.pre?.score||0))} pts` : "No post review yet.";

    if(trade.screenshot){
      $("postImg").src = trade.screenshot;
      $("postImg").classList.remove("hidden");
      $("postNoImg").classList.add("hidden");
    }else{
      $("postImg").classList.add("hidden");
      $("postNoImg").classList.remove("hidden");
    }

    // build post checklist
    $("postRules").innerHTML = "";
    strategy.rules.forEach((r, idx)=>{
      const id = "post_rule_"+idx;
      const row = document.createElement("div");
      row.className = "flex items-center justify-between gap-3 rounded-xl border border-gray-800 bg-gray-900/40 px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start gap-3">
          <input type="checkbox" id="${id}" class="mt-1 w-5 h-5">
          <div>
            <div class="text-sm font-semibold text-gray-200">${escapeHTML(r.text)}</div>
            <div class="text-xs text-gray-500">weight ${r.w}</div>
          </div>
        </div>
      `;
      $("postRules").appendChild(row);
      if(trade.post?.checked && trade.post.checked[idx]) row.querySelector("input").checked = true;
      row.querySelector("input").disabled = locked;
      row.querySelector("input").onchange = ()=> updatePostScore(strategy);
    });

    $("prResult").value = trade.post?.result || "";
    $("prR").value = trade.post?.realized_r ?? "";
    $("prLesson").value = trade.post?.lesson || "";
    const sel = new Set(trade.post?.mistakes || []);
    renderMistakeChips(sel);
    $("mistakeChips").dataset.selected = JSON.stringify([...sel]);

    // lock logic
    if(locked){
      $("postLockMsg").classList.remove("hidden");
      $("postLockMsg").textContent = "This review is locked (24h). If you want to change it, you wanted therapy, not journaling.";
      $("savePostBtn").disabled = true;
      $("savePostBtn").classList.add("disabled");
      $("prResult").disabled = true;
      $("prR").disabled = true;
      $("prLesson").disabled = true;
      // chips still clickable? disable:
      document.querySelectorAll("#mistakeChips button").forEach(b=>b.disabled=true);
    }else{
      $("postLockMsg").classList.add("hidden");
      $("savePostBtn").disabled = false;
      $("savePostBtn").classList.remove("disabled");
      $("prResult").disabled = false;
      $("prR").disabled = false;
      $("prLesson").disabled = false;
    }

    updatePostScore(strategy);
    show($("modalPost"));

    // store selected mistakes set in closure
    $("mistakeChips")._set = sel;
    $("mistakeChips")._locked = locked;
  }

  function updatePostScore(strategy){
    if(!postCtx) return;
    const checked = {};
    strategy.rules.forEach((r, idx)=>{
      const box = document.getElementById("post_rule_"+idx);
      checked[idx] = !!box?.checked;
    });
    const sc = calcScore(strategy, checked);
    $("postPostScore").textContent = sc.pct + "%";
    $("postDelta").textContent = `Δ ${(sc.pct - (postCtx.pre?.score||0))} pts`;
    // stash in temp until save
    postCtx._postTemp = { checked, score: sc.pct, grade: sc.grade };
  }

  $("postClose").onclick = ()=> hide($("modalPost"));
  $("postCancel").onclick = ()=> hide($("modalPost"));

  $("savePostBtn").onclick = ()=>{
    if(!postCtx) return;
    const strategy = getStrategyById(postCtx.strategy_id);
    if(!strategy) return;

    const result = $("prResult").value;
    const realized = parseFloat($("prR").value);
    const lesson = $("prLesson").value.trim();
    if(!result) return toast("Missing", "Pick Win/Loss/BE.", "bad");
    if(!isFinite(realized)) return toast("Missing", "Realized R required.", "bad");
    if(!lesson) return toast("Missing", "Lesson required.", "bad");

    const mistakes = Array.from($("mistakeChips")._set || []);
    const tmp = postCtx._postTemp || { checked:{}, score:0, grade:"C" };
    postCtx.post = {
      checked: tmp.checked,
      score: tmp.score,
      grade: tmp.grade,
      result,
      realized_r: realized,
      lesson,
      mistakes,
      reviewed_at: postCtx.post?.reviewed_at || new Date().toISOString() // first save sets reviewed_at
    };
    delete postCtx._postTemp;

    // achievement confetti on A-grade win
    if(postCtx.post.grade==="A" && result==="win"){
      try{ confetti({ particleCount: 90, spread: 62, origin:{ y: 0.8 } }); }catch(e){}
    }

    saveState();
    hide($("modalPost"));
    toast("Saved", "Post review locked in.", "ok");
    renderAll();
  };

  // -----------------------------
  // Analytics + filters
  // -----------------------------
  let rChart = null;
  let mistakeChart = null;

  function filteredTrades(){
    const strat = $("filterStrategy")?.value || "ALL";
    const setup = $("filterSetup")?.value || "ALL";
    const session = $("filterSession")?.value || "ALL";
    const dow = $("filterDOW")?.value || "ALL";

    return (state.trades||[]).filter(t=>{
      if(strat!=="ALL" && t.strategy_id!==strat) return false;
      if(setup!=="ALL" && (t.setup||"")!==setup) return false;
      if(session!=="ALL" && (t.session||"")!==session) return false;
      if(dow!=="ALL"){
        const d = new Date(t.date+"T00:00:00");
        const map = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        if(map[d.getDay()]!==dow) return false;
      }
      return true;
    });
  }

  function renderAnalytics(){
    // fill filter dropdowns
    const sSel = $("filterStrategy");
    if(sSel){
      const v = sSel.value || "ALL";
      sSel.innerHTML = `<option value="ALL">All strategies</option>` + state.strategies.map(s=>`<option value="${s.id}">${escapeHTML(s.name)}</option>`).join("");
      sSel.value = v;
    }
    // setup options from data
    const setups = Array.from(new Set((state.trades||[]).map(t=>t.setup).filter(Boolean))).sort();
    const setupSel = $("filterSetup");
    if(setupSel){
      const v = setupSel.value || "ALL";
      setupSel.innerHTML = `<option value="ALL">All setups</option>` + setups.map(x=>`<option>${escapeHTML(x)}</option>`).join("");
      setupSel.value = v;
    }

    // bind change events once
    ["filterStrategy","filterSetup","filterSession","filterDOW"].forEach(id=>{
      const el = $(id);
      if(el && !el._bound){
        el.onchange = ()=> renderAnalytics();
        el._bound = true;
      }
    });

    const trades = filteredTrades();
    const reviewed = trades.filter(t=>t.post && isFinite(t.post.realized_r));

    const total = trades.length;
    const avgPre = total ? Math.round(trades.reduce((a,t)=>a+(t.pre?.score||0),0)/total) : 0;
    const wins = reviewed.filter(t=>t.post.result==="win").length;
    const wr = reviewed.length ? Math.round((wins/reviewed.length)*100) : 0;
    const avgR = reviewed.length ? (reviewed.reduce((a,t)=>a+t.post.realized_r,0)/reviewed.length) : 0;

    $("statTotalTrades").textContent = String(total);
    $("statAvgScore").textContent = String(avgPre) + "%";
    $("statWinRate").textContent = String(wr) + "%";
    $("statAvgR").textContent = avgR.toFixed(2);

    // R curve
    const rPoints = reviewed.slice().reverse().map(t=>t.post.realized_r);
    let cum = 0;
    const series = rPoints.map(x=> (cum += x));
    const ctx = $("rChart").getContext("2d");
    if(rChart) rChart.destroy();
    rChart = new Chart(ctx, {
      type: "line",
      data: { labels: series.map((_,i)=>i+1), datasets: [{ label: "Cumulative R", data: series, tension: 0.25 }] },
      options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: "#9ca3af" } }, y: { ticks: { color: "#9ca3af" } } } }
    });

    // Mistake trend by date
    const byDate = {};
    reviewed.forEach(t=>{
      const d = t.date;
      byDate[d] = (byDate[d] || 0) + (t.post.mistakes?.length||0);
    });
    const dates = Object.keys(byDate).sort();
    const mSeries = dates.map(d=>byDate[d]);
    const mctx = $("mistakeTrendChart").getContext("2d");
    if(mistakeChart) mistakeChart.destroy();
    mistakeChart = new Chart(mctx, {
      type: "bar",
      data: { labels: dates, datasets: [{ label: "Mistakes", data: mSeries }] },
      options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: "#9ca3af" } }, y: { ticks: { color: "#9ca3af" } } } }
    });

    // Score distribution bars (A/B/C by pre score)
    const counts = { A:0, B:0, C:0 };
    trades.forEach(t=> counts[gradeFromPct(t.pre?.score||0)]++);
    const dist = $("distBars"); dist.innerHTML = "";
    ["A","B","C"].forEach(g=>{
      const n = counts[g] || 0;
      const pct = total ? Math.round((n/total)*100) : 0;
      dist.innerHTML += barRow(g, n, pct, g==="A"?"bg-emerald-500/30":g==="B"?"bg-amber-500/30":"bg-gray-500/30");
    });

    // Avg R by grade (use post reviews)
    const byG = { A:[], B:[], C:[] };
    reviewed.forEach(t=>{
      const g = gradeFromPct(t.pre?.score||0);
      byG[g].push(t.post.realized_r);
    });
    const rb = $("rBars"); rb.innerHTML = "";
    ["A","B","C"].forEach(g=>{
      const arr = byG[g];
      const av = arr.length ? (arr.reduce((a,x)=>a+x,0)/arr.length) : 0;
      const pct = Math.min(100, Math.round((Math.abs(av) / 3) * 100)); // visual scale
      rb.innerHTML += barRow(g, arr.length ? av.toFixed(2)+"R" : "—", pct, g==="A"?"bg-blue-500/30":g==="B"?"bg-amber-500/30":"bg-gray-500/30");
    });
  }

  function barRow(label, right, pct, bg){
    return `
      <div class="space-y-1">
        <div class="flex items-center justify-between text-xs text-gray-300">
          <div class="font-semibold">${label}</div>
          <div class="text-gray-400">${right}</div>
        </div>
        <div class="w-full h-3 rounded-full bg-gray-800 overflow-hidden">
          <div class="h-3 ${bg}" style="width:${pct}%"></div>
        </div>
      </div>
    `;
  }

  // -----------------------------
  // Goals + Achievements
  // -----------------------------
  $("addGoalOpen").onclick = ()=> show($("modalGoal"));
  $("goalClose").onclick = ()=> hide($("modalGoal"));

  $("addGoalBtn").onclick = ()=>{
    $("goalMsg").textContent = "";
    const type = $("goalType").value;
    const target = parseFloat($("goalTarget").value);
    const desc = $("goalDesc").value.trim();
    if(!isFinite(target)) { $("goalMsg").textContent = "Target required."; return; }
    if(!desc) { $("goalMsg").textContent = "Description required."; return; }
    state.goals.unshift({ id: crypto.randomUUID(), type, target, desc, created_at: new Date().toISOString() });
    saveState();
    hide($("modalGoal"));
    $("goalTarget").value = ""; $("goalDesc").value = "";
    toast("Goal added", "Now do the work.", "ok");
    renderGoals();
  };

  function deleteGoal(id){
    state.goals = state.goals.filter(g=>g.id!==id);
    saveState();
    renderGoals();
  }

  function monthKey(d){ return (d||todayISO()).slice(0,7); }

  function computeProgress(goal){
    const trades = state.trades || [];
    const reviewed = trades.filter(t=>t.post && isFinite(t.post.realized_r));
    const mk = monthKey();
    if(goal.type==="monthly_r"){
      const sum = reviewed.filter(t=>t.date.startsWith(mk)).reduce((a,t)=>a+t.post.realized_r,0);
      return { val: sum, pct: goal.target ? Math.max(0, Math.min(100, Math.round((sum/goal.target)*100))) : 0, suffix:"R" };
    }
    if(goal.type==="win_rate"){
      const w = reviewed.filter(t=>t.post.result==="win").length;
      const n = reviewed.length || 0;
      const wr = n ? (w/n)*100 : 0;
      return { val: wr, pct: Math.max(0, Math.min(100, Math.round((wr/goal.target)*100))), suffix:"%" };
    }
    if(goal.type==="pd_streak"){
      const s = calcPDStreak();
      return { val: s, pct: goal.target ? Math.round((s/goal.target)*100) : 0, suffix:" days" };
    }
    if(goal.type==="a_grade_trades"){
      const a = trades.filter(t=>gradeFromPct(t.pre?.score||0)==="A").length;
      return { val: a, pct: goal.target ? Math.round((a/goal.target)*100) : 0, suffix:" trades" };
    }
    // custom: treat as "count of daily reviews this month"
    const d = (state.dailyReviews||[]).filter(x=>x.date.startsWith(mk)).length;
    return { val: d, pct: goal.target ? Math.round((d/goal.target)*100) : 0, suffix:"" };
  }

  function renderGoals(){
    const wrap = $("goalsList");
    wrap.innerHTML = "";
    if(!state.goals.length){
      wrap.innerHTML = `<div class="text-sm text-gray-400">No goals yet. Add one. Your future self is tired of “soon”.</div>`;
    }else{
      state.goals.forEach(g=>{
        const pr = computeProgress(g);
        const pct = Math.max(0, Math.min(100, pr.pct));
        const card = document.createElement("div");
        card.className = "rounded-2xl border border-gray-800 bg-gray-950/50 p-6";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-bold text-lg">${escapeHTML(g.desc)}</div>
              <div class="text-xs text-gray-400 mt-1">Target: ${g.target}${g.type==="monthly_r"?"R":g.type==="win_rate"?"%":""}</div>
            </div>
            <button class="px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-bold" data-delgoal="${g.id}">✕</button>
          </div>
          <div class="mt-4 flex items-baseline justify-between">
            <div class="text-2xl font-black">${(typeof pr.val==="number" ? (g.type==="win_rate"? pr.val.toFixed(1): pr.val.toFixed(2)).replace(/\.00$/,"") : pr.val)}${pr.suffix||""}</div>
            <div class="text-sm text-gray-400">${pct}%</div>
          </div>
          <div class="mt-3 w-full h-3 rounded-full bg-gray-800 overflow-hidden">
            <div class="h-3 bg-blue-500/30" style="width:${pct}%"></div>
          </div>
        `;
        wrap.appendChild(card);
      });
      document.querySelectorAll("[data-delgoal]").forEach(b=> b.onclick = ()=> deleteGoal(b.getAttribute("data-delgoal")));
    }
    renderAchievements();
  }

  function renderAchievements(){
    // compute fresh
    const ach = [];
    const trades = state.trades||[];
    const reviewed = trades.filter(t=>t.post && isFinite(t.post.realized_r));
    const aTrades = trades.filter(t=>gradeFromPct(t.pre?.score||0)==="A").length;
    const winStreak = calcWinStreak();
    const pdStreak = calcPDStreak();
    const monthR = reviewed.filter(t=>t.date.startsWith(monthKey())).reduce((a,t)=>a+t.post.realized_r,0);

    if(trades.length >= 1) ach.push({ k:"first_trade", title:"First Log", desc:"You logged your first trade. Progress begins." });
    if(reviewed.length >= 5) ach.push({ k:"five_reviews", title:"5 Reviews", desc:"You reviewed five trades. Most people can’t handle truth." });
    if(aTrades >= 10) ach.push({ k:"ten_A", title:"10 A Grades", desc:"You took 10 A-grade setups. Consistency is a flex." });
    if(winStreak >= 3) ach.push({ k:"win_streak", title:"Win Streak", desc:`${winStreak} wins in a row. Stay humble.` });
    if(pdStreak >= 3) ach.push({ k:"pd_streak", title:"PD Streak", desc:`${pdStreak} disciplined profitable days. Rare species.` });
    if(monthR >= 10) ach.push({ k:"10R_month", title:"10R Month", desc:"You hit 10R this month. That’s not luck." });

    // store unique keys
    const known = new Set((state.achievements||[]).map(a=>a.k));
    ach.forEach(a=>{
      if(!known.has(a.k)){
        state.achievements.unshift({ ...a, unlocked_at: new Date().toISOString() });
        known.add(a.k);
      }
    });
    // keep last 20
    state.achievements = (state.achievements||[]).slice(0,20);
    saveState();

    const wrap = $("achievementsList");
    wrap.innerHTML = "";
    if(!state.achievements.length){
      wrap.innerHTML = `<div class="text-sm text-gray-400">No achievements yet. That’s fine. Start logging.</div>`;
      return;
    }
    state.achievements.slice(0,8).forEach(a=>{
      const div = document.createElement("div");
      div.className = "rounded-2xl border border-gray-800 bg-gray-950/50 p-5";
      div.innerHTML = `
        <div class="text-sm font-bold">${escapeHTML(a.title)}</div>
        <div class="text-xs text-gray-400 mt-1">${escapeHTML(a.desc)}</div>
        <div class="text-xs text-gray-500 mt-3">${(a.unlocked_at||"").slice(0,10)}</div>
      `;
      wrap.appendChild(div);
    });
  }

  // -----------------------------
  // Daily Review
  // -----------------------------
  $("openDailyModal").onclick = ()=> openDailyModal(todayISO());
  function openDailyModal(date){
    $("drDate").value = date;
    const existing = (state.dailyReviews||[]).find(x=>x.date===date) || null;
    $("drScore").value = existing?.score ?? "";
    $("drLesson").value = existing?.lesson ?? "";
    $("drNotes").value = existing?.notes ?? "";
    $("dailyMsg").textContent = "";
    show($("modalDaily"));
  }
  $("dailyClose").onclick = ()=> hide($("modalDaily"));
  $("dailyCancel").onclick = ()=> hide($("modalDaily"));

  $("saveDailyBtn").onclick = ()=>{
    $("dailyMsg").textContent = "";
    const date = $("drDate").value || todayISO();
    const score = parseFloat($("drScore").value);
    const lesson = $("drLesson").value.trim();
    const notes = $("drNotes").value || "";
    if(!isFinite(score) || score<0 || score>100){ $("dailyMsg").textContent = "Score must be 0–100."; return; }
    if(!lesson){ $("dailyMsg").textContent = "Lesson required."; return; }
    const idx = (state.dailyReviews||[]).findIndex(x=>x.date===date);
    const payload = { date, score, lesson, notes, saved_at: new Date().toISOString() };
    if(idx>=0) state.dailyReviews[idx] = payload; else state.dailyReviews.unshift(payload);
    saveState();
    hide($("modalDaily"));
    toast("Saved", "Daily Review done. Now log off.", "ok");
    renderAll();
  };

  function renderDailyTab(){
    const t = todayISO();
    const existing = (state.dailyReviews||[]).find(x=>x.date===t);
    $("dailyStatusCard").textContent = existing ? "Completed ✅" : "Not done";
    $("dailyStatusHint").textContent = existing ? `Score ${existing.score}/100 • ${existing.lesson}` : "Do it before you forget what you did wrong.";

    const recent = $("recentDaily");
    recent.innerHTML = "";
    (state.dailyReviews||[]).slice(0,7).forEach(r=>{
      const div = document.createElement("div");
      div.className = "rounded-2xl border border-gray-800 bg-gray-900/40 p-4";
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">${r.date}</div>
          <div class="text-xs text-gray-400">${r.score}/100</div>
        </div>
        <div class="text-xs text-gray-300 mt-1">${escapeHTML(r.lesson||"")}</div>
        <button class="mt-3 px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-xs font-bold" data-editdr="${r.date}">Edit</button>
      `;
      recent.appendChild(div);
    });
    document.querySelectorAll("[data-editdr]").forEach(b=> b.onclick = ()=> openDailyModal(b.getAttribute("data-editdr")));
  }

  // -----------------------------
  // Settings
  // -----------------------------
  function renderSettings(){
    $("settingDailyLossLimit").value = state.settings.dailyLossLimit;
    $("settingMaxTrades").value = state.settings.maxTrades;
    $("settingHardStop").checked = !!state.settings.hardStop;
    $("notifDailyReview").checked = !!state.settings.notifDailyReview;
    $("notifRiskLimit").checked = !!state.settings.notifRiskLimit;
  }

  $("saveSettingsBtn").onclick = ()=>{
    const dll = parseFloat($("settingDailyLossLimit").value);
    const mt = parseInt($("settingMaxTrades").value,10);
    state.settings.dailyLossLimit = isFinite(dll) ? dll : 500;
    state.settings.maxTrades = isFinite(mt) ? mt : 5;
    state.settings.hardStop = !!$("settingHardStop").checked;
    state.settings.notifDailyReview = !!$("notifDailyReview").checked;
    state.settings.notifRiskLimit = !!$("notifRiskLimit").checked;
    saveState();
    toast("Saved", "Settings updated.", "ok");
    renderAll();
  };

  $("requestNotifPermission").onclick = async ()=>{
    if(!("Notification" in window)) return toast("Nope", "Notifications not supported here.", "bad");
    const p = await Notification.requestPermission();
    toast("Notifications", p==="granted" ? "Enabled." : "Permission denied.", p==="granted"?"ok":"bad");
  };

  $("resetBtn").onclick = ()=>{
    localStorage.removeItem(LS_KEY);
    state = DEFAULT_STATE();
    saveState();
    toast("Reset", "Local cache cleared.", "info");
    renderAll();
  };

  $("exportJsonBtn").onclick = ()=>{
    downloadText("tradecheck_state.json", JSON.stringify(state,null,2), "application/json");
    toast("Exported", "JSON downloaded.", "ok");
  };

  // -----------------------------
  // Export
  // -----------------------------
  $("exportBtn").onclick = ()=> show($("modalExport"));
  $("exportClose").onclick = ()=> hide($("modalExport"));

  $("exportAllCSV").onclick = ()=>{
    const rows = [];
    rows.push(["date","symbol","session","setup","strategy","pre_score","pre_grade","result","realized_r","post_score","mistakes","lesson"].join(","));
    state.trades.slice().reverse().forEach(t=>{
      const s = getStrategyById(t.strategy_id)?.name || "";
      const row = [
        t.date||"",
        (t.symbol||"").replace(/,/g," "),
        (t.session||"").replace(/,/g," "),
        (t.setup||"").replace(/,/g," "),
        s.replace(/,/g," "),
        t.pre?.score ?? "",
        t.pre?.grade ?? "",
        t.post?.result ?? "",
        t.post?.realized_r ?? "",
        t.post?.score ?? "",
        (t.post?.mistakes||[]).join("|").replace(/,/g," "),
        (t.post?.lesson||"").replace(/,/g," ")
      ];
      rows.push(row.join(","));
    });
    downloadText("tradecheck_trades.csv", rows.join("\n"), "text/csv");
    toast("Exported", "CSV downloaded.", "ok");
  };

  $("exportAllJSON").onclick = ()=>{
    downloadText("tradecheck_state.json", JSON.stringify(state,null,2), "application/json");
    toast("Exported", "JSON downloaded.", "ok");
  };

  function downloadText(filename, text, mime){
    const blob = new Blob([text], { type: mime||"text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -----------------------------
  // Render core UI pieces
  // -----------------------------
  function renderAll(){
    renderStrategies();
    renderTradeSelectors();
    renderTrades();
    renderHeaderStats();
  }

  function renderTradeSelectors(){
    // strategy select
    const sel = $("tStrategy");
    const prev = sel.value;
    sel.innerHTML = `<option value="">Select</option>` + state.strategies.map(s=>`<option value="${s.id}">${escapeHTML(s.name)} (${escapeHTML(s.tf)})</option>`).join("");
    if(state.strategies.some(s=>s.id===prev)) sel.value = prev;
  }

  function tradeCardClass(t){
    const r = t.post?.result;
    if(r==="win") return "trade-card-win";
    if(r==="loss") return "trade-card-loss";
    if(r==="be") return "trade-card-pending";
    return "trade-card-pending";
  }

  function renderTrades(){
    const wrap = $("tradesList");
    wrap.innerHTML = "";
    const list = state.trades || [];
    $("emptyTrades").classList.toggle("hidden", list.length>0);

    list.forEach(t=>{
      const s = getStrategyById(t.strategy_id);
      const pre = t.pre?.score ?? 0;
      const grade = t.pre?.grade ?? gradeFromPct(pre);
      const hasPost = !!t.post;
      const div = document.createElement("div");
      div.className = `rounded-2xl border border-gray-800 bg-gray-950/50 p-5 ${tradeCardClass(t)}`;
      div.innerHTML = `
        <div class="flex items-start justify-between gap-3 flex-col md:flex-row">
          <div>
            <div class="flex items-center gap-2">
              <div class="font-bold text-lg">${escapeHTML(t.symbol||"—")}</div>
              <span class="text-xs px-2 py-1 rounded-full bg-gray-800 text-gray-200 font-bold">${escapeHTML(t.session||"")}</span>
              <span class="text-xs px-2 py-1 rounded-full bg-gray-800 text-gray-200 font-bold">${escapeHTML(t.setup||"")}</span>
              <span class="text-xs px-2 py-1 rounded-full ${grade==="A"?"bg-emerald-600/25 text-emerald-200":grade==="B"?"bg-amber-600/25 text-amber-200":"bg-gray-700/35 text-gray-200"} font-bold">${grade}</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">${t.date} • ${escapeHTML(s?.name||"—")}</div>
            <div class="text-xs text-gray-500 mt-2">Pre score: <span class="text-gray-200 font-bold">${pre}%</span> • Risk: <span class="text-gray-200 font-bold">$${(t.risk||0).toFixed(0)}</span></div>
            ${t.notes ? `<div class="text-xs text-gray-300 mt-3">${escapeHTML(t.notes)}</div>`:""}
            ${hasPost ? `<div class="text-xs text-gray-400 mt-3">Post: <span class="text-gray-200 font-bold">${t.post.score}%</span> • ${t.post.result.toUpperCase()} • ${t.post.realized_r.toFixed(2)}R</div>` : `<div class="text-xs text-gray-500 mt-3">Post review not done.</div>`}
          </div>
          <div class="flex gap-2 w-full md:w-auto">
            <button class="px-4 py-2 rounded-xl btn-primary text-sm font-bold flex-1 md:flex-none" data-post="${t.id}">${hasPost?"View Review":"Post Review"}</button>
            <button class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-bold flex-1 md:flex-none" data-deltrade="${t.id}">Delete</button>
          </div>
        </div>
      `;
      wrap.appendChild(div);
    });

    document.querySelectorAll("[data-deltrade]").forEach(b=> b.onclick = ()=> deleteTrade(b.getAttribute("data-deltrade")));
    document.querySelectorAll("[data-post]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-post");
        const t = state.trades.find(x=>x.id===id);
        if(t) openPostModal(t);
      };
    });
  }

  // -----------------------------
  // Risk + daily stats
  // -----------------------------
  function isHardStoppedForDate(date){
    const maxT = state.settings.maxTrades || 5;
    const dll = state.settings.dailyLossLimit || 500;
    const trades = (state.trades||[]).filter(t=>t.date===date);
    const n = trades.length;
    // estimate PnL from realized R * risk (only reviewed)
    const pnl = trades.reduce((a,t)=>{
      if(t.post && isFinite(t.post.realized_r)) return a + (t.post.realized_r * (t.risk||0));
      return a;
    }, 0);
    // loss limit: if pnl <= -dll
    const lossHit = pnl <= -Math.abs(dll);
    const countHit = n >= maxT;
    return lossHit || countHit;
  }

  function renderHeaderStats(){
    const d = todayISO();
    const maxT = state.settings.maxTrades || 5;
    const dll = state.settings.dailyLossLimit || 500;

    const todays = (state.trades||[]).filter(t=>t.date===d);
    const pnl = todays.reduce((a,t)=>{
      if(t.post && isFinite(t.post.realized_r)) return a + (t.post.realized_r * (t.risk||0));
      return a;
    }, 0);

    $("dailyPnL").textContent = "$" + Math.round(pnl);
    $("dailyPnLLimit").textContent = "/ $" + Math.round(dll);
    $("tradesToday").textContent = String(todays.length);
    $("tradesLimit").textContent = "/ " + maxT + " max";

    const pct = Math.max(0, Math.min(100, Math.round((Math.abs(pnl)/Math.abs(dll))*100)));
    $("riskMeterFill").style.width = pct + "%";
    const rm = $("riskMeterFill");
    rm.classList.remove("risk-low","risk-medium","risk-high");
    rm.classList.add(pct>=85 ? "risk-high" : pct>=60 ? "risk-medium" : "risk-low");

    $("currentStreak").textContent = String(calcPDStreak());

    // daily review status card
    const dr = (state.dailyReviews||[]).find(x=>x.date===d);
    $("dailyReviewStatus").textContent = dr ? "Completed ✅" : "Not done";
    $("dailyReviewHint").textContent = dr ? `Score ${dr.score}/100` : "Do it today.";

    // quote
    const quotes = [
      "Boring is a strategy.",
      "Rules first. Feelings later.",
      "If it’s not in your checklist, it’s not in your account.",
      "Discipline is cheaper than tuition.",
      "Trade the plan. Review the mess."
    ];
    $("quoteLine").textContent = "— " + quotes[(new Date()).getDay() % quotes.length];

    // notifications / risk warning toasts
    if(state.settings.notifRiskLimit){
      if(pct>=85) toast("Risk", "You’re near the loss limit. Stop trying to be a hero.", "bad");
      else if(pct>=60) toast("Risk", "Approaching daily limit. Tighten up.", "info");
      if(todays.length >= maxT) toast("Trades", "Max trades reached. Go touch grass.", "bad");
    }
  }

  function calcWinStreak(){
    const reviewed = (state.trades||[]).filter(t=>t.post && isFinite(t.post.realized_r)).slice().sort((a,b)=>a.date.localeCompare(b.date));
    let streak = 0;
    for(let i=reviewed.length-1;i>=0;i--){
      if(reviewed[i].post.result==="win") streak++;
      else break;
    }
    return streak;
  }

  function calcPDStreak(){
    // PD day = day with net positive R and daily review completed (simple & strict)
    const byDate = {};
    (state.trades||[]).forEach(t=>{
      if(!t.post || !isFinite(t.post.realized_r)) return;
      byDate[t.date] = (byDate[t.date] || 0) + t.post.realized_r;
    });
    const dates = Object.keys(byDate).sort();
    const haveDR = new Set((state.dailyReviews||[]).map(x=>x.date));
    let streak = 0;
    for(let i=dates.length-1;i>=0;i--){
      const d = dates[i];
      if(byDate[d] > 0 && haveDR.has(d)) streak++;
      else break;
    }
    return streak;
  }

  // -----------------------------
  // Reminders
  // -----------------------------
  function checkReminders(){
    if(!state.settings.notifDailyReview) return;
    const now = new Date();
    const hour = now.getHours();
    if(hour >= 20){
      const t = todayISO();
      const dr = (state.dailyReviews||[]).find(x=>x.date===t);
      if(!dr){
        toast("Daily Review", "It’s after 8 PM. Do the review. Your memory is not a database.", "bad");
        if(("Notification" in window) && Notification.permission==="granted"){
          try{ new Notification("TradeCheck", { body: "Daily Review is not done. Finish it." }); }catch(e){}
        }
      }
    }
  }

  // -----------------------------
  // Wire buttons that open modals
  // -----------------------------
  $("openDailyModal").onclick = ()=> openDailyModal(todayISO());

  // -----------------------------
  // Init bindings
  // -----------------------------
  function renderAllAndMaybeTab(){
    renderAll();
    // if analytics tab is open, rerender it too
    const open = tabIds.find(t=>!$("tab_"+t).classList.contains("hidden"));
    if(open) {
      if(open==="goals") renderGoals();
      if(open==="review") renderDailyTab();
      if(open==="analytics") renderAnalytics();
      if(open==="settings") renderSettings();
    }
  }
  // ensure renderAll triggers tab refresh via above wrapper when needed
  renderAll = renderAllAndMaybeTab;

  // On load
  window.addEventListener("DOMContentLoaded", bootSupabase);
  </script>
</body>
</html>
