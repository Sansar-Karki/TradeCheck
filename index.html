<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_self">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradeCheck | Discipline + Post-Trade Review</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .chip { border: 1px solid rgba(255,255,255,0.10); }
    .disabled { opacity: 0.55; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
  <!-- AUTH GATE -->
  <div id="authGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center font-bold">TC</div>
        <div>
          <div class="font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Sign in to continue</div>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="authUser" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Username" autocomplete="username">
        <input id="authPass" type="password" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Password (6+ chars)" autocomplete="current-password">
      </div>

      <button id="loginBtn" class="mt-4 w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Login</button>
      <button id="signupBtn" class="mt-2 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Sign up</button>

      <div id="authMsg" class="text-xs text-red-300 mt-2"></div>
      <div class="text-xs text-gray-500 mt-3">Client-side only. For a real product, use a real backend.</div>
    </div>
  </div>

  <!-- ONBOARDING GATE -->
  <div id="onboardingGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-lg font-semibold">Create your first strategy</div>
          <div class="text-sm text-gray-400">No strategies, no trades. Build the rules first.</div>
        </div>
        <button id="onboardLogout" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Logout</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5">
        <div>
          <label class="text-xs text-gray-400">Strategy name</label>
          <input id="obName" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., NY ORB Reversal">
        </div>
        <div>
          <label class="text-xs text-gray-400">Timeframe</label>
          <select id="obTF" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            <option value="">Select</option>
            <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <div class="mt-4">
  <label class="text-xs text-gray-400">Checklist rules</label>

  <div id="obRulesList" class="mt-2 space-y-2"></div>

  <button type="button" id="obAddRuleBtn" class="mt-2 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">
    + Add rule
  </button>

  <div class="text-xs text-gray-500 mt-2">Each rule has a weight (Core, Confluence, Filter).</div>
</div>

      </div>

      <div class="mt-5 flex items-center gap-2">
        <button id="finishOnboardingBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Create strategy & continue</button>
      </div>

      <div id="obMsg" class="text-xs text-red-300 mt-2"></div>
    </div>
  </div>

  <header class="sticky top-0 z-10 bg-gray-950/80 backdrop-blur border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center font-bold">TC</div>
        <div>
          <div class="font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Discipline + Post-Trade Review</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="resetBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Reset Data</button>
        <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">

    <!-- Drift alert -->
    <div id="driftAlert" class="hidden rounded-xl border px-4 py-3"></div>

    <!-- Stats -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Total Trades (filtered)</div>
        <div id="statTotalTrades" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Avg Post Score (weighted)</div>
        <div id="statAvgScore" class="text-3xl font-bold mt-2">0%</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Win Rate (filtered)</div>
        <div id="statWinRate" class="text-3xl font-bold mt-2">0%</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Avg Realized R (filtered)</div>
        <div id="statAvgR" class="text-3xl font-bold mt-2">0.00</div>
      </div>
    </section>

    <!-- Filters + visuals -->
    <section class="card rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <div class="text-lg font-semibold">Analytics Filters</div>
          <div class="text-sm text-gray-400">Slice by strategy/session/day. The truth hurts, but it’s cheaper.</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-gray-400">Strategy</label>
            <select id="filterStrategy" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All strategies</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400">Session</label>
            <select id="filterSession" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All</option>
              <option value="Asia">Asia</option>
              <option value="London">London</option>
              <option value="NY">NY</option>
              <option value="ORB">ORB</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400">Day of week</label>
            <select id="filterDOW" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All</option>
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Score Distribution (A/B/C)</div>
            <div class="text-xs text-gray-400">post score</div>
          </div>
          <div class="mt-4 space-y-3" id="distBars"></div>
        </div>

        <div class="rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Avg R by Grade</div>
            <div class="text-xs text-gray-400">completed reviews</div>
          </div>
          <div class="mt-4 space-y-3" id="rBars"></div>
        </div>
      </div>
    </section>

    <!-- Strategy builder + locks -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">Strategy Builder (weighted rules)</div>
            <div class="text-sm text-gray-400">Each checklist item has a weight 1–3.</div>
          </div>
          <button id="newStrategyBtn" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">New Strategy</button>
        </div>

        <div id="strategyCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5"></div>

        <div id="strategyFormWrap" class="hidden mt-6 rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Create Strategy</div>
            <button id="cancelStrategyBtn" class="text-sm text-gray-300 hover:text-white">Cancel</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="text-xs text-gray-400">Strategy name</label>
              <input id="sName" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., ORB Reversal"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Timeframe</label>
              <select id="sTF" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">Select</option>
                <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">Checklist items</div>
                <div class="text-xs text-gray-400">Rule text + weight (1–3)</div>
              </div>
              <button id="addRuleBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Add rule</button>
            </div>
            <div id="rulesList" class="mt-3 space-y-2"></div>
          </div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="saveStrategyBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save</button>
          </div>
        </div>
      </div>

      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div class="text-lg font-semibold">Rule Locks</div>
        <div class="text-sm text-gray-400 mt-1">Warn or block low-quality trades in pre-trade mode.</div>

        <div class="mt-4 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Enable warning</div>
              <div class="text-xs text-gray-400">Show warning if predicted score is low</div>
            </div>
            <input id="lockWarn" type="checkbox" class="w-5 h-5">
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Enable hard block</div>
              <div class="text-xs text-gray-400">Prevent saving trade under threshold</div>
            </div>
            <input id="lockBlock" type="checkbox" class="w-5 h-5">
          </div>

          <div>
            <label class="text-xs text-gray-400">Score threshold (%)</label>
            <input id="lockThreshold" type="number" min="0" max="100" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 70">
          </div>

          <button id="saveLocksBtn" class="w-full mt-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Save Locks</button>

          <div class="text-xs text-gray-400">
            Tip: warn + 70%. When you’re ready to stop donating to the market, enable block.
          </div>
        </div>
      </div>
    </section>

    <!-- Trade entry + Trades list -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div>
          <div class="text-lg font-semibold">Trade Entry</div>
          <div class="text-sm text-gray-400">Pre-trade checklist + confidence. Post-trade review is separate.</div>
        </div>

        <form id="tradeForm" class="mt-4 space-y-3">
          <div>
            <label class="text-xs text-gray-400">Strategy (required)</label>
            <select id="tStrategy" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="">Select</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400">Symbol</label>
              <input id="tSymbol" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="AAPL / EURUSD / MNQ"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Session</label>
              <select id="tSession" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option>Asia</option><option>London</option><option>NY</option><option>ORB</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Date</label>
            <input id="tDate" type="date" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-gray-400">Entry</label>
              <input id="tEntry" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Stop</label>
              <input id="tStop" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Target</label>
              <input id="tTarget" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400">Risk ($)</label>
              <input id="tRisk" type="number" step="0.01" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Confidence (1–5)</label>
              <select id="tConfidence" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="1">1 (low)</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5 (high)</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Screenshot (optional in prototype)</label>
            <input id="tShot" type="file" accept="image/*" class="mt-1 w-full text-sm text-gray-300">
            <div class="text-xs text-gray-500 mt-1">Prototype stores a data URL in localStorage.</div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Notes</label>
            <textarea id="tNotes" rows="2" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Reasoning, mistakes, etc."></textarea>
          </div>

          <button type="button" id="preTradeBtn" class="w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">
            Pre-trade checklist
          </button>
        </form>
      </div>

      <div class="lg:col-span-2 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div>
          <div class="text-lg font-semibold">Trades</div>
          <div class="text-sm text-gray-400">Complete a post-trade review to unlock the best analytics.</div>
        </div>

        <div id="tradesList" class="mt-4 space-y-4"></div>
      </div>
    </section>
  </main>

  <!-- Pre-trade modal -->
  <div id="modalPre" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Pre-trade Checklist</div>
          <div class="text-sm text-gray-400">Predict score before saving.</div>
        </div>
        <button id="preClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div id="preWarn" class="hidden mt-4 rounded-xl border px-4 py-3 text-sm"></div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">Check what you truly have, not what you want.</div>
          <div id="preRules" class="mt-3 space-y-2"></div>
        </div>

        <div class="rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Predicted Score</div>
          <div class="mt-3">
            <div class="text-4xl font-bold" id="preScore">0%</div>
            <div class="text-sm text-gray-400 mt-1" id="preGrade">Grade: C</div>
          </div>

          <div class="mt-4 text-sm text-gray-300 space-y-1">
            <div><span class="text-gray-400">Unweighted:</span> <span id="preUnweighted">0%</span></div>
            <div><span class="text-gray-400">Strategy:</span> <span id="preStrategy">—</span></div>
            <div><span class="text-gray-400">Confidence:</span> <span id="preConf">—</span></div>
          </div>

          <div class="mt-5 flex items-center gap-2">
            <button id="saveTradeBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save trade</button>
            <button id="preCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancel</button>
          </div>

          <div class="text-xs text-gray-500 mt-3">
            Rule locks apply here. If block is enabled and score is under threshold, saving is disabled.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-trade review modal -->
  <div id="modalPost" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-4xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Post-trade Review</div>
          <div id="postSub" class="text-sm text-gray-400">Complete review to lock in truth.</div>
        </div>
        <button id="postClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div id="postLockMsg" class="hidden mt-4 rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-200"></div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left: screenshot + summary -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Trade Snapshot</div>
          <div class="text-xs text-gray-400 mt-1" id="postMeta">—</div>
          <div class="mt-3">
            <img id="postImg" class="hidden rounded-xl border border-gray-800 max-h-80 object-contain w-full bg-black" alt="chart">
            <div id="postNoImg" class="text-sm text-gray-500">No screenshot saved for this trade.</div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Pre Score</div>
              <div class="text-lg font-semibold" id="postPreScore">—</div>
            </div>
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Post Score</div>
              <div class="text-lg font-semibold" id="postPostScore">—</div>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400" id="postDelta">—</div>
        </div>

        <!-- Middle: post checklist -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Post Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">What actually happened.</div>
          <div id="postRules" class="mt-3 space-y-2"></div>
        </div>

        <!-- Right: outcome + mistakes -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Outcome & Review</div>
          <div class="text-xs text-gray-400 mt-1">Keep it structured so analytics work.</div>

          <div class="mt-3 space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-400">Result</label>
                <select id="prResult" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                  <option value="">Select</option>
                  <option value="win">Win</option>
                  <option value="loss">Loss</option>
                  <option value="be">Break-even</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-gray-400">Realized R</label>
                <input id="prR" type="number" step="0.01" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 1.50 or -1.00">
              </div>
            </div>

            <div>
              <label class="text-xs text-gray-400">Exit reason</label>
              <select id="prExit" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">Select</option>
                <option>TP hit</option>
                <option>SL hit</option>
                <option>Manual exit</option>
                <option>Time stop</option>
                <option>Rule violation exit</option>
                <option>Other</option>
              </select>
            </div>

            <div>
              <div class="text-xs text-gray-400 mb-2">Mistake tags</div>
              <div id="mistakeChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div>
              <label class="text-xs text-gray-400">One-sentence lesson (required)</label>
              <input id="prLesson" maxlength="120" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Next time I will...">
              <div class="text-xs text-gray-500 mt-1">Max 120 characters. No essays. No coping.</div>
            </div>

            <div class="flex items-center gap-2 pt-1">
              <button id="savePostBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save post review</button>
              <button id="postCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancel</button>
            </div>

            <div class="text-xs text-gray-500">
              Post review locks 24 hours after you save it.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Storage + helpers
  // -----------------------------
  // -----------------------------
  // -----------------------------
  // Supabase Auth + user-scoped storage
  // -----------------------------
  // 1) Put these two values from Supabase -> Project Settings -> API
  const SUPABASE_URL = "https://hfnpqamhtxhhsrwmngtv.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_2im62kUUfZ_WLgaHuNmP7w_vFsuE0QV";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 2) We store the entire app state as a JSON blob per-user in table: tc_user_data
  // Run the SQL I gave you earlier to create tc_user_data + RLS policies.
  const CLOUD_TABLE = "tc_user_data";

  let currentUserId = null;
  let currentUserLabel = null; // what you typed (username/email), used for greeting only
  let LS_KEY = "tradecheck_v3__blocked";

  let cloudSaveTimer = null;
  let lastCloudHash = "";

  const normalizeLoginToEmail = (raw) => {
    const v = (raw || "").trim();
    if (!v) return "";
    if (v.includes("@")) return v.toLowerCase();
    // If you type a username, we map it to a pseudo-email. You can change the domain later.
    return v.toLowerCase().replace(/[^a-z0-9._-]/g, "") + "@tradecheck.app";
  };

  async function cloudLoad(uid){
    try{
      const { data, error } = await sb.from(CLOUD_TABLE).select("data").eq("user_id", uid).maybeSingle();
      if (error) throw error;
      return data?.data || null;
    } catch (e){
      console.warn("Cloud load failed:", e?.message || e);
      return null;
    }
  }

  async function cloudUpsert(uid, blob){
    const payload = { user_id: uid, data: blob };
    const { error } = await sb.from(CLOUD_TABLE).upsert(payload, { onConflict: "user_id" });
    if (error) throw error;
  }

  function scheduleCloudSave(getStateFn){
    if (!currentUserId) return;
    clearTimeout(cloudSaveTimer);
    cloudSaveTimer = setTimeout(async () => {
      try{
        const st = getStateFn();
        const hash = JSON.stringify(st);
        if (hash === lastCloudHash) return;
        await cloudUpsert(currentUserId, st);
        lastCloudHash = hash;
      } catch (e){
        console.warn("Cloud save failed:", e?.message || e);
      }
    }, 500);
  }

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  async function login(){
    authMsg.textContent = "";
    const rawUser = authUser.value;
    const email = normalizeLoginToEmail(rawUser);
    const pass = (authPass.value || "").trim();
    if(!email || pass.length < 6){ authMsg.textContent = "Enter a username/email and a 6+ character password."; return; }

    currentUserLabel = rawUser?.trim() || email;
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if(error){ authMsg.textContent = error.message; return; }
    // onAuthStateChange will finish boot
  }

  async function signup(){
    authMsg.textContent = "";
    const rawUser = authUser.value;
    const email = normalizeLoginToEmail(rawUser);
    const pass = (authPass.value || "").trim();
    if(!email || pass.length < 6){ authMsg.textContent = "Enter a username/email and a 6+ character password."; return; }

    currentUserLabel = rawUser?.trim() || email;
    const { data, error } = await sb.auth.signUp({ email, password: pass, options: { emailRedirectTo: window.location.href }});
    if(error){ authMsg.textContent = error.message; return; }
    authMsg.textContent = "Signed up. If email confirmation is ON, verify and then login.";
  }

  async function logout(){
    await sb.auth.signOut();
    currentUserId = null;
    LS_KEY = "tradecheck_v3__blocked";
    lastCloudHash = "";
    show(authGate);
    hide(onboardingGate);
  }

  loginBtn.addEventListener("click", login);
  signupBtn.addEventListener("click", signup);
  if (logoutBtn) logoutBtn.addEventListener("click", logout);
  if (onboardLogout) onboardLogout.addEventListener("click", logout);

  // Auth gate is controlled by session (see init section at bottom)
  const MS_24H = 24 * 60 * 60 * 1000;

  const todayISO = () => new Date().toISOString().slice(0,10);
  const dowShort = (isoDate) => {
    const d = new Date(isoDate + "T00:00:00");
    return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
  };
  const gradeFromPct = (pct) => pct >= 80 ? "A" : (pct >= 60 ? "B" : "C");

  const mistakeOptions = [
    "Early entry","Late entry","No confirmation","Moved stop","Cut winner early","Let loser run",
    "Revenge trade","Overrisked","FOMO","None"
  ];

  const defaultState = {
    locks: { warn:false, block:false, threshold:70 },
    strategies: [],
    trades: []
  };

  const loadState = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredClone(defaultState);
      return JSON.parse(raw);
    } catch(e) {
      return structuredClone(defaultState);
    }
  };
  const saveState = (st) => { localStorage.setItem(LS_KEY, JSON.stringify(st)); scheduleCloudSave(()=>state); };

  let state = structuredClone(defaultState);
const numOrNull = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };
  const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const escapeAttr = (s) => escapeHtml(s).replaceAll("\n"," ");

  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // -----------------------------
  // DOM refs
  // -----------------------------
  const driftAlert = document.getElementById("driftAlert");

  const statTotalTrades = document.getElementById("statTotalTrades");
  const statAvgScore = document.getElementById("statAvgScore");
  const statWinRate = document.getElementById("statWinRate");
  const statAvgR = document.getElementById("statAvgR");

  const filterStrategy = document.getElementById("filterStrategy");
  const filterSession = document.getElementById("filterSession");
  const filterDOW = document.getElementById("filterDOW");

  const distBars = document.getElementById("distBars");
  const rBars = document.getElementById("rBars");

  const strategyCards = document.getElementById("strategyCards");
  const newStrategyBtn = document.getElementById("newStrategyBtn");
  const strategyFormWrap = document.getElementById("strategyFormWrap");
  const cancelStrategyBtn = document.getElementById("cancelStrategyBtn");
  const sName = document.getElementById("sName");
  const sTF = document.getElementById("sTF");
  const addRuleBtn = document.getElementById("addRuleBtn");
  const rulesList = document.getElementById("rulesList");
  const saveStrategyBtn = document.getElementById("saveStrategyBtn");

  const lockWarn = document.getElementById("lockWarn");
  const lockBlock = document.getElementById("lockBlock");
  const lockThreshold = document.getElementById("lockThreshold");
  const saveLocksBtn = document.getElementById("saveLocksBtn");

  const tStrategy = document.getElementById("tStrategy");
  const tSymbol = document.getElementById("tSymbol");
  const tSession = document.getElementById("tSession");
  const tDate = document.getElementById("tDate");
  const tEntry = document.getElementById("tEntry");
  const tStop = document.getElementById("tStop");
  const tTarget = document.getElementById("tTarget");
  const tRisk = document.getElementById("tRisk");
  const tConfidence = document.getElementById("tConfidence");
  const tShot = document.getElementById("tShot");
  const tNotes = document.getElementById("tNotes");
  const preTradeBtn = document.getElementById("preTradeBtn");
  const tradesList = document.getElementById("tradesList");

  const modalPre = document.getElementById("modalPre");
  const preClose = document.getElementById("preClose");
  const preCancel = document.getElementById("preCancel");
  const preWarn = document.getElementById("preWarn");
  const preRules = document.getElementById("preRules");
  const preScore = document.getElementById("preScore");
  const preGrade = document.getElementById("preGrade");
  const preUnweighted = document.getElementById("preUnweighted");
  const preStrategy = document.getElementById("preStrategy");
  const preConf = document.getElementById("preConf");
  const saveTradeBtn = document.getElementById("saveTradeBtn");

  const modalPost = document.getElementById("modalPost");
  const postClose = document.getElementById("postClose");
  const postCancel = document.getElementById("postCancel");
  const postLockMsg = document.getElementById("postLockMsg");
  const postMeta = document.getElementById("postMeta");
  const postImg = document.getElementById("postImg");
  const postNoImg = document.getElementById("postNoImg");
  const postPreScore = document.getElementById("postPreScore");
  const postPostScore = document.getElementById("postPostScore");
  const postDelta = document.getElementById("postDelta");
  const postRules = document.getElementById("postRules");
  const prResult = document.getElementById("prResult");
  const prR = document.getElementById("prR");
  const prExit = document.getElementById("prExit");
  const mistakeChips = document.getElementById("mistakeChips");
  const prLesson = document.getElementById("prLesson");
  const savePostBtn = document.getElementById("savePostBtn");

  const resetBtn = document.getElementById("resetBtn");

  // -----------------------------
  // Scoring
  // -----------------------------
  const computeWeightedPct = (strategy, checks) => {
    const weights = strategy.rules.map(r => Math.max(1, Math.min(3, Number(r.w) || 1)));
    const totalW = weights.reduce((a,b)=>a+b,0) || 1;
    const gotW = weights.reduce((sum,w,i)=> sum + (checks[i] ? w : 0), 0);
    return Math.round((gotW/totalW)*100);
  };
  const computeUnweightedPct = (checks) => {
    const total = checks.length || 1;
    const got = checks.filter(Boolean).length;
    return Math.round((got/total)*100);
  };

  // -----------------------------
  // Filters
  // -----------------------------
  function applyFilters(trades) {
    let out = [...trades];
    const s = filterStrategy.value;
    const sess = filterSession.value;
    const dow = filterDOW.value;
    if (s !== "ALL") out = out.filter(t => String(t.strategyId) === String(s));
    if (sess !== "ALL") out = out.filter(t => t.session === sess);
    if (dow !== "ALL") out = out.filter(t => dowShort(t.date) === dow);
    return out;
  }

  // -----------------------------
  // Render: selects + locks
  // -----------------------------
  function syncFiltersAndSelects() {
    tStrategy.innerHTML = `<option value="">Select</option>` + state.strategies.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
    filterStrategy.innerHTML = `<option value="ALL">All strategies</option>` + state.strategies.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
  }

  function renderLocks() {
    lockWarn.checked = !!state.locks.warn;
    lockBlock.checked = !!state.locks.block;
    lockThreshold.value = state.locks.threshold ?? 70;
  }

  // -----------------------------
  // Render: strategies
  // -----------------------------
  function renderStrategies() {
    strategyCards.innerHTML = "";
    state.strategies.forEach(s => {
      const rulesPreview = s.rules.slice(0,3).map(r => `<li class="text-sm text-gray-300">• ${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></li>`).join("");
      const more = s.rules.length > 3 ? `<li class="text-xs text-gray-500 mt-1">+${s.rules.length-3} more</li>` : "";
      const card = document.createElement("div");
      card.className = "rounded-2xl bg-gray-950 border border-gray-800 p-4";
      card.innerHTML = `
        <div class="flex items-start justify-between">
          <div>
            <div class="font-semibold">${escapeHtml(s.name)}</div>
            <div class="text-xs text-gray-500 mt-1">Timeframe: ${escapeHtml(s.tf || "")}</div>
          </div>
          <button class="useStrategy px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-xs" data-id="${s.id}">Use</button>
        </div>
        <ul class="mt-3">${rulesPreview}${more}</ul>
      `;
      strategyCards.appendChild(card);
    });

    document.querySelectorAll(".useStrategy").forEach(btn => {
      btn.addEventListener("click", () => {
        tStrategy.value = btn.dataset.id;
        window.scrollTo({ top: document.getElementById("tradeForm").getBoundingClientRect().top + window.scrollY - 90, behavior:"smooth" });
      });
    });
  }

  // -----------------------------
  // Strategy form UI
  // -----------------------------
  function openStrategyForm() {
    strategyFormWrap.classList.remove("hidden");
    rulesList.innerHTML = "";
    sName.value = "";
    sTF.value = "";
    addRuleRow();
    addRuleRow();
    addRuleRow();
  }

  function closeStrategyForm() {
    strategyFormWrap.classList.add("hidden");
  }

  function addRuleRow(text="", w=1) {
    const row = document.createElement("div");
    row.className = "grid grid-cols-12 gap-2";
    row.innerHTML = `
      <input class="ruleText col-span-9 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Rule text" value="${escapeAttr(text)}">
      <select class="ruleW col-span-2 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
        <option value="1" ${String(w)==="1"?"selected":""}>Filter</option>
        <option value="2" ${String(w)==="2"?"selected":""}>Confluence</option>
        <option value="3" ${String(w)==="3"?"selected":""}>Core</option>
      </select>
      <button type="button" class="delRule col-span-1 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">✕</button>
    `;
    rulesList.appendChild(row);
    row.querySelector(".delRule").addEventListener("click", () => row.remove());
  }

  newStrategyBtn.addEventListener("click", () => openStrategyForm());
  cancelStrategyBtn.addEventListener("click", () => closeStrategyForm());
  addRuleBtn.addEventListener("click", () => addRuleRow());

  saveStrategyBtn.addEventListener("click", () => {
    const name = (sName.value || "").trim();
    const tf = (sTF.value || "").trim();
    const texts = Array.from(document.querySelectorAll(".ruleText")).map(x => (x.value||"").trim()).filter(Boolean);
    const ws = Array.from(document.querySelectorAll(".ruleW")).map(x => Number(x.value)||1);
    if(!name) { alert("Strategy name is required."); return; }
    if(!tf) { alert("Timeframe is required."); return; }
    if(texts.length === 0) { alert("Add at least one rule."); return; }

    const rules = texts.map((t,i)=>({ text:t, w: Math.max(1, Math.min(3, ws[i] || 1)) }));
    state.strategies.push({ id: Date.now(), name, tf, rules });
    saveState(state);
    closeStrategyForm();
    renderAll();
  });

  // -----------------------------
  // Locks save
  // -----------------------------
  saveLocksBtn.addEventListener("click", () => {
    state.locks.warn = !!lockWarn.checked;
    state.locks.block = !!lockBlock.checked;
    state.locks.threshold = Math.max(0, Math.min(100, Number(lockThreshold.value) || 0));
    saveState(state);
    alert("Locks saved.");
    renderAll(false);
  });

  function driftStyle(ok) {
    driftAlert.classList.remove("hidden");
    driftAlert.className = "rounded-xl border px-4 py-3 " + (ok
      ? "border-emerald-500/30 bg-emerald-500/10 text-emerald-200"
      : "border-red-500/30 bg-red-500/10 text-red-200");
  }

  function renderDrift(){
    // Placeholder: can add more drift logic later.
    driftAlert.classList.add("hidden");
  }

  // -----------------------------
  // Stats + charts
  // -----------------------------
  function renderStatsAndCharts() {
    const filtered = applyFilters(state.trades);

    statTotalTrades.textContent = String(filtered.length);

    const reviewed = filtered.filter(t => t.postReview && Number.isFinite(t.postReview.realizedR));
    const avgScore = reviewed.length
      ? Math.round(reviewed.reduce((a,t)=>a+(t.post?.weightedPct||0),0)/reviewed.length)
      : 0;
    statAvgScore.textContent = `${avgScore}%`;

    const wins = reviewed.filter(t => t.postReview.result === "win").length;
    const winRate = reviewed.length ? Math.round((wins/reviewed.length)*100) : 0;
    statWinRate.textContent = `${winRate}%`;

    const avgR = reviewed.length
      ? (reviewed.reduce((a,t)=>a+(Number(t.postReview.realizedR)||0),0)/reviewed.length)
      : 0;
    statAvgR.textContent = avgR.toFixed(2);

    // Distribution A/B/C by post weighted score
    const dist = { A:0, B:0, C:0 };
    reviewed.forEach(t => dist[gradeFromPct(t.post?.weightedPct ?? 0)]++);
    const total = reviewed.length || 1;

    distBars.innerHTML = ["A","B","C"].map(g=>{
      const pct = Math.round((dist[g]/total)*100);
      const barColor = g==="A" ? "bg-emerald-500/40" : (g==="B" ? "bg-amber-500/40" : "bg-red-500/40");
      return `
        <div>
          <div class="flex items-center justify-between text-sm">
            <div class="text-gray-300">${g}-grade</div>
            <div class="text-gray-400">${dist[g]} (${pct}%)</div>
          </div>
          <div class="mt-2 w-full bg-gray-950 border border-gray-800 rounded-full h-3 overflow-hidden">
            <div class="${barColor} h-3" style="width:${pct}%"></div>
          </div>
        </div>
      `;
    }).join("");

    // Avg R by grade
    const by = { A:[], B:[], C:[] };
    reviewed.forEach(t => {
      const g = gradeFromPct(t.post?.weightedPct ?? 0);
      by[g].push(Number(t.postReview.realizedR));
    });
    rBars.innerHTML = ["A","B","C"].map(g=>{
      const arr = by[g];
      const avg = arr.length ? (arr.reduce((a,x)=>a+x,0)/arr.length) : 0;
      const pct = Math.max(0, Math.min(100, Math.round(((avg+3)/6)*100))); // goofy scale, purely visual
      const barColor = g==="A" ? "bg-emerald-500/40" : (g==="B" ? "bg-amber-500/40" : "bg-red-500/40");
      return `
        <div>
          <div class="flex items-center justify-between text-sm">
            <div class="text-gray-300">${g}-grade avg R</div>
            <div class="text-gray-400">${avg.toFixed(2)} (n=${arr.length})</div>
          </div>
          <div class="mt-2 w-full bg-gray-950 border border-gray-800 rounded-full h-3 overflow-hidden">
            <div class="${barColor} h-3" style="width:${pct}%"></div>
          </div>
        </div>
      `;
    }).join("");
  }

  // -----------------------------
  // Trade flow: pre-trade modal
  // -----------------------------
  let preChecks = [];
  function openPreModal() {
    const sid = tStrategy.value;
    if(!sid){ alert("Select a strategy."); return; }
    const strategy = state.strategies.find(x => String(x.id) === String(sid));
    if(!strategy) { alert("Strategy not found."); return; }

    preChecks = strategy.rules.map(()=>false);
    preRules.innerHTML = strategy.rules.map((r,i)=>`
      <label class="flex items-start gap-3 text-sm">
        <input type="checkbox" data-i="${i}" class="mt-1 w-4 h-4">
        <span class="text-gray-200">${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></span>
      </label>
    `).join("");

    preRules.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const i = Number(cb.dataset.i);
        preChecks[i] = cb.checked;
        refreshPreScore();
      });
    });

    preStrategy.textContent = strategy.name;
    preConf.textContent = tConfidence.value;
    refreshPreScore();
    modalPre.classList.remove("hidden");
    modalPre.classList.add("flex");
  }

  function closePreModal() {
    modalPre.classList.add("hidden");
    modalPre.classList.remove("flex");
  }

  function refreshPreScore(){
    const sid = tStrategy.value;
    const strategy = state.strategies.find(x => String(x.id) === String(sid));
    const weightedPct = computeWeightedPct(strategy, preChecks);
    const unweightedPct = computeUnweightedPct(preChecks);
    preScore.textContent = `${weightedPct}%`;
    preUnweighted.textContent = `${unweightedPct}%`;
    preGrade.textContent = `Grade: ${gradeFromPct(weightedPct)}`;

    // lock warning/block
    const th = Number(state.locks.threshold ?? 70);
    const warnOn = !!state.locks.warn;
    const blockOn = !!state.locks.block;

    preWarn.classList.add("hidden");
    preWarn.className = "hidden mt-4 rounded-xl border px-4 py-3 text-sm";

    if((warnOn || blockOn) && weightedPct < th){
      preWarn.classList.remove("hidden");
      preWarn.className = "mt-4 rounded-xl border px-4 py-3 text-sm border-amber-500/30 bg-amber-500/10 text-amber-200";
      preWarn.textContent = `Predicted score ${weightedPct}% is under threshold ${th}%.`;
    }

    if(blockOn && weightedPct < th){
      saveTradeBtn.disabled = true;
      saveTradeBtn.classList.add("disabled");
      saveTradeBtn.textContent = "Blocked by lock";
    } else {
      saveTradeBtn.disabled = false;
      saveTradeBtn.classList.remove("disabled");
      saveTradeBtn.textContent = "Save trade";
    }
  }

  preTradeBtn.addEventListener("click", openPreModal);
  preClose.addEventListener("click", closePreModal);
  preCancel.addEventListener("click", closePreModal);

  // -----------------------------
  // Save trade
  // -----------------------------
  saveTradeBtn.addEventListener("click", async () => {
    const sid = tStrategy.value;
    const strategy = state.strategies.find(x => String(x.id) === String(sid));
    if(!strategy) return;

    const weightedPct = computeWeightedPct(strategy, preChecks);
    const th = Number(state.locks.threshold ?? 70);
    if(state.locks.block && weightedPct < th) return;

    const symbol = (tSymbol.value || "").trim();
    const date = tDate.value || todayISO();
    const entry = numOrNull(tEntry.value);
    const stop = numOrNull(tStop.value);
    const target = numOrNull(tTarget.value);
    const risk = numOrNull(tRisk.value);
    const confidence = Number(tConfidence.value) || 3;
    const notes = (tNotes.value || "").trim();

    let shot = null;
    if (tShot.files && tShot.files[0]) {
      try { shot = await fileToDataURL(tShot.files[0]); } catch(e) { shot = null; }
    }

    const trade = {
      id: Date.now(),
      strategyId: Number(sid),
      symbol, session: tSession.value,
      date,
      entry, stop, target, risk,
      confidence,
      notes,
      screenshot: shot,
      createdAt: Date.now(),
      pre: { checks:[...preChecks], weightedPct, unweightedPct: computeUnweightedPct(preChecks) },
      post: null,
      postReview: null
    };

    state.trades.unshift(trade);
    saveState(state);

    // reset form bits
    tSymbol.value = "";
    tEntry.value = "";
    tStop.value = "";
    tTarget.value = "";
    tRisk.value = "";
    tNotes.value = "";
    tShot.value = "";
    closePreModal();
    renderAll();
  });

  // -----------------------------
  // Post-trade review modal
  // -----------------------------
  let postTradeId = null;
  let postChecks = [];
  let postMistakes = new Set(["None"]);

  function postReviewLocked(t){
    if(!t.postReview?.completedAt) return false;
    return (Date.now() - t.postReview.completedAt) > MS_24H;
  }
  function addRuleRowTo(listEl, text="", w=1){
  const row = document.createElement("div");
  row.className = "grid grid-cols-12 gap-2";
  row.innerHTML = `
    <input class="col-span-9 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm ruleText" placeholder="Rule" value="${escapeAttr(text)}">
    <select class="col-span-2 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm ruleW">
<option value="1" ${String(w)==="1" ? "selected" : ""}>Filter</option>
<option value="2" ${String(w)==="2" ? "selected" : ""}>Confluence</option>
<option value="3" ${String(w)==="3" ? "selected" : ""}>Core</option>

    </select>
    <button type="button" class="col-span-1 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm delRule">✕</button>
  `;
  row.querySelector(".delRule").addEventListener("click", () => row.remove());
  listEl.appendChild(row);
}

function readRuleRows(listEl){
  const rows = Array.from(listEl.querySelectorAll("div"));
  const out = [];
  rows.forEach(r=>{
    const t = (r.querySelector(".ruleText")?.value || "").trim();
    const w = Number(r.querySelector(".ruleW")?.value || 1);
    if(t) out.push({ text: t, w: Math.max(1, Math.min(3, w)) });
  });
  return out;
}
const obRulesList = document.getElementById("obRulesList");
const obAddRuleBtn = document.getElementById("obAddRuleBtn");

if(obAddRuleBtn){
  obAddRuleBtn.addEventListener("click", () => addRuleRowTo(obRulesList, "", 1));
}
if(obRulesList && obRulesList.children.length === 0){
  addRuleRowTo(obRulesList, "HTF bias aligned", 3);
  addRuleRowTo(obRulesList, "Entry at key level", 3);
  addRuleRowTo(obRulesList, "Confirmation candle", 2);
  addRuleRowTo(obRulesList, "Risk within limit", 2);
  addRuleRowTo(obRulesList, "Session allowed", 1);
}


  function openPostModal(tradeId){
    const t = state.trades.find(x=>x.id===tradeId);
    if(!t) return;
    postTradeId = tradeId;

    const strat = state.strategies.find(s=>s.id===t.strategyId);
    const locked = postReviewLocked(t);

    // left meta
    postMeta.textContent = `${t.symbol || "—"} • ${t.session} • ${t.date} • ${strat?.name || "Strategy"}`;
    postPreScore.textContent = `${t.pre?.weightedPct ?? 0}% (${gradeFromPct(t.pre?.weightedPct ?? 0)})`;
    postPostScore.textContent = t.post ? `${t.post.weightedPct}% (${gradeFromPct(t.post.weightedPct)})` : "—";
    const d = (t.post?.weightedPct ?? 0) - (t.pre?.weightedPct ?? 0);
    postDelta.innerHTML = `Delta: <span class="${d>=0?"text-emerald-300":"text-red-300"} font-medium">${d>=0?"+":""}${d}%</span>`;

    // screenshot
    if(t.screenshot){
      postImg.src = t.screenshot;
      postImg.classList.remove("hidden");
      postNoImg.classList.add("hidden");
    } else {
      postImg.classList.add("hidden");
      postNoImg.classList.remove("hidden");
    }

    // lock message
    postLockMsg.classList.add("hidden");
    if(locked){
      postLockMsg.textContent = "This review is locked (24h passed since saving).";
      postLockMsg.classList.remove("hidden");
    }

    // checks
    const rules = strat?.rules || [];
    postChecks = (t.post?.checks && t.post.checks.length===rules.length) ? [...t.post.checks] : rules.map(()=>false);

    postRules.innerHTML = rules.map((r,i)=>`
      <label class="flex items-start gap-3 text-sm">
        <input type="checkbox" data-i="${i}" class="mt-1 w-4 h-4" ${postChecks[i]?"checked":""} ${locked?"disabled":""}>
        <span class="text-gray-200">${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></span>
      </label>
    `).join("");

    postRules.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        if(locked) return;
        const i = Number(cb.dataset.i);
        postChecks[i] = cb.checked;
        // refresh score view in modal
        const weightedPct = computeWeightedPct(strat, postChecks);
        const unweightedPct = computeUnweightedPct(postChecks);
        t.post = { checks:[...postChecks], weightedPct, unweightedPct };
        saveState(state);
        postPostScore.textContent = `${weightedPct}% (${gradeFromPct(weightedPct)})`;
        const preW = t.pre?.weightedPct ?? 0;
        const d2 = weightedPct - preW;
        postDelta.innerHTML = `Delta: <span class="${d2>=0?"text-emerald-300":"text-red-300"} font-medium">${d2>=0?"+":""}${d2}%</span>`;
        renderAll(false);
      });
    });

    // outcome fields
    prResult.value = t.postReview?.result || "";
    prR.value = (t.postReview?.realizedR ?? "");
    prExit.value = (t.postReview?.exitReason ?? "");
    prLesson.value = (t.postReview?.lesson ?? "");
    postMistakes = new Set((t.postReview?.mistakes && t.postReview.mistakes.length) ? t.postReview.mistakes : ["None"]);
    renderMistakeChips(locked);

    modalPost.classList.remove("hidden");
    modalPost.classList.add("flex");
  }

  function closePostModal(){
    modalPost.classList.add("hidden");
    modalPost.classList.remove("flex");
    postTradeId = null;
  }

  postClose.addEventListener("click", closePostModal);
  postCancel.addEventListener("click", closePostModal);

  function renderMistakeChips(locked) {
    mistakeChips.innerHTML = "";
    mistakeOptions.forEach(label => {
      const isOn = postMistakes.has(label);
      const chip = document.createElement("button");
      chip.type = "button";
      chip.disabled = locked;
      chip.className = `chip px-3 py-1.5 rounded-full text-xs ${isOn ? "bg-blue-600/20 border-blue-500/30 text-blue-200" : "bg-gray-950 border-gray-800 text-gray-300"} ${locked ? "disabled" : "hover:bg-gray-900"}`;
      chip.textContent = label;

      chip.addEventListener("click", () => {
        if (locked) return;

        if (label === "None") {
          postMistakes = new Set(["None"]);
        } else {
          postMistakes.delete("None");
          if (postMistakes.has(label)) postMistakes.delete(label);
          else postMistakes.add(label);
          if (postMistakes.size === 0) postMistakes.add("None");
        }
        renderMistakeChips(false);
      });

      mistakeChips.appendChild(chip);
    });
  }

  savePostBtn.addEventListener("click", () => {
    const t = state.trades.find(x => x.id === postTradeId);
    if (!t) return;
    if (postReviewLocked(t)) return;

    const result = prResult.value;
    const realizedR = numOrNull(prR.value);
    const exitReason = prExit.value;
    const lesson = (prLesson.value || "").trim();
    const mistakes = Array.from(postMistakes);

    if (!result) { alert("Select result (Win/Loss/BE)."); return; }
    if (!Number.isFinite(Number(realizedR))) { alert("Enter realized R (number)."); return; }
    if (!exitReason) { alert("Select exit reason."); return; }
    if (!lesson) { alert("Lesson is required."); return; }

    t.postReview = {
      result,
      realizedR: Number(realizedR),
      exitReason,
      mistakes: mistakes.length ? mistakes : ["None"],
      lesson,
      completedAt: Date.now()
    };

    saveState(state);
    closePostModal();
    renderAll();
  });

  // -----------------------------
  // Trades list
  // -----------------------------
  function tradeCard(t){
    const strat = state.strategies.find(s=>s.id===t.strategyId);
    const preW = t.pre?.weightedPct ?? 0;
    const postW = t.post?.weightedPct ?? null;
    const grade = gradeFromPct(postW ?? preW);
    const hasReview = !!t.postReview?.completedAt;
    const r = hasReview ? Number(t.postReview.realizedR) : null;

    const badge = grade==="A" ? "bg-emerald-500/15 border-emerald-500/25 text-emerald-200"
      : grade==="B" ? "bg-amber-500/15 border-amber-500/25 text-amber-200"
      : "bg-red-500/15 border-red-500/25 text-red-200";

    return `
      <div class="rounded-2xl bg-gray-950 border border-gray-800 p-4">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="font-semibold truncate">${escapeHtml(t.symbol || "—")}</div>
              <div class="text-xs text-gray-500">${escapeHtml(t.session)} • ${escapeHtml(t.date)}</div>
              <div class="px-2 py-0.5 text-xs rounded-full border ${badge}">Grade ${grade}</div>
              ${hasReview ? `<div class="px-2 py-0.5 text-xs rounded-full border border-gray-700 text-gray-300">R ${r.toFixed(2)}</div>` : `<div class="px-2 py-0.5 text-xs rounded-full border border-gray-700 text-gray-400">Post review pending</div>`}
            </div>
            <div class="text-xs text-gray-400 mt-1 truncate">${escapeHtml(strat?.name || "Strategy")} • Pre ${preW}% ${postW!=null?` • Post ${postW}%`:""}</div>
            ${t.notes ? `<div class="text-sm text-gray-300 mt-2">${escapeHtml(t.notes)}</div>` : ""}
          </div>

          <div class="flex items-center gap-2">
            <button class="openPost px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-id="${t.id}">Post review</button>
            <button class="delTrade px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-id="${t.id}">Delete</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderTrades(){
    const filtered = applyFilters(state.trades);
    if(filtered.length === 0){
      tradesList.innerHTML = `<div class="rounded-xl border border-gray-800 p-4 text-sm text-gray-400">No trades yet. Start with a pre-trade checklist.</div>`;
      return;
    }
    tradesList.innerHTML = filtered.map(tradeCard).join("");

    document.querySelectorAll(".openPost").forEach(btn=>{
      btn.addEventListener("click", ()=> openPostModal(Number(btn.dataset.id)));
    });
    document.querySelectorAll(".delTrade").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = Number(btn.dataset.id);
        state.trades = state.trades.filter(x=>x.id!==id);
        saveState(state);
        renderAll(false);
      });
    });
  }

  // -----------------------------
  // Reset
  // -----------------------------
  resetBtn.addEventListener("click", () => {
    localStorage.removeItem(LS_KEY);
    state = loadState();
    // After reset, force onboarding again
    show(onboardingGate);
  });

  // -----------------------------
  // Onboarding
  // -----------------------------
  function parseWeightedLines(text){
    const lines = (text || "").split("\n").map(x=>x.trim()).filter(Boolean);
    return lines.map(line=>{
      const m = line.match(/^w([1-3])\s+(.*)$/i);
      if(m) return { text: m[2].trim(), w: Number(m[1]) };
      return { text: line, w: 1 };
    }).filter(r=>r.text);
  }

  function finishOnboarding(){
    setObMessage("");
    const name = (obName.value || "").trim();
    const tf = (obTF.value || "").trim();
const rules = readRuleRows(obRulesList);

    if(!name){ setObMessage("Strategy name is required."); return; }
    if(!tf){ setObMessage("Timeframe is required."); return; }
    if(!rules.length){ setObMessage("Add at least one rule."); return; }

    state.strategies.push({ id: Date.now(), name, tf, rules });
    saveState(state);
    localStorage.removeItem("tc_new_user_flag_v1");
    hide(onboardingGate);
    renderAll();
  }

  finishOnboardingBtn.addEventListener("click", finishOnboarding);

  // -----------------------------
  // Render all
  // -----------------------------
  function renderAll(scrollTop=true) {
    syncFiltersAndSelects();
    renderLocks();
    renderStrategies();
    renderStatsAndCharts();
    renderTrades();
    renderDrift();
    if (scrollTop) tDate.value = tDate.value || todayISO();
  }

  // Init (Supabase session -> load cloud state -> boot UI)
  // -----------------------------
  async function bootAfterAuth(){
    if(!currentUserId){ show(authGate); hide(onboardingGate); return; }

    // user-scoped local key
    LS_KEY = `tradecheck_v3_${currentUserId}`;

    // Load local first (fast), then overwrite with cloud if present
    state = loadState();

    const cloud = await cloudLoad(currentUserId);
    if(cloud && typeof cloud === "object"){
      state = cloud;
      // keep local in sync
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      lastCloudHash = JSON.stringify(state);
    } else {
      // First-time user: ensure a row exists in cloud
      try{ await cloudUpsert(currentUserId, state); lastCloudHash = JSON.stringify(state); } catch(e){ console.warn(e); }
    }

    hide(authGate);

    // Standard boot path (same as your POC)
    tDate.value = todayISO();
    if ((state.strategies?.length || 0) === 0){
      show(onboardingGate);
    } else {
      hide(onboardingGate);
      renderAll();
    }
  }

  // Session bootstrap
  (async () => {
    // PWA SW (GitHub Pages safe path)
    if ("serviceWorker" in navigator){
      window.addEventListener("load", () => { navigator.serviceWorker.register("./sw.js"); });
    }

    const { data: { session } } = await sb.auth.getSession();
    if(session?.user){
      currentUserId = session.user.id;
      await bootAfterAuth();
    } else {
      show(authGate);
      hide(onboardingGate);
    }

    sb.auth.onAuthStateChange(async (event, session2) => {
      if(session2?.user){
        currentUserId = session2.user.id;
        await bootAfterAuth();
      } else {
        currentUserId = null;
        show(authGate);
        hide(onboardingGate);
      }
    });
  })();

</script>
</body>
</html>
