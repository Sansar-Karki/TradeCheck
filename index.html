<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_self">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradeCheck | Discipline + Post-Trade Review</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .chip { border: 1px solid rgba(255,255,255,0.10); }
    .disabled { opacity: 0.55; cursor: not-allowed; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#030712">
  
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TradeCheck">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">
  <!-- AUTH GATE -->
  <div id="authGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center font-bold">TC</div>
        <div>
          <div class="font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Sign in to continue</div>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="authEmail" type="email" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Email" autocomplete="email">
        <input id="authPass" type="password" class="w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Password (6+ chars)" autocomplete="current-password">
      </div>

      <button id="loginBtn" class="mt-4 w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Login</button>
      <button id="signupBtn" class="mt-2 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Sign up</button>

      <div id="authMsg" class="text-xs text-red-300 mt-2"></div>
      
      
    </div>
  </div>

  <!-- ONBOARDING GATE -->
  <div id="onboardingGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-lg font-semibold">Create your first strategy</div>
          <div class="text-sm text-gray-400">No strategies, no trades. Build the rules first.</div>
        </div>
        <button id="onboardLogout" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Logout</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5">
        <div>
          <label class="text-xs text-gray-400">Strategy name</label>
          <input id="obName" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., NY ORB Reversal">
        </div>
        <div>
          <label class="text-xs text-gray-400">Timeframe</label>
          <select id="obTF" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            <option value="">Select</option>
            <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-xs text-gray-400">Checklist rules</label>
        <div id="obRulesList" class="mt-2 space-y-2"></div>
        <button type="button" id="obAddRuleBtn" class="mt-2 w-full px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">
          + Add rule
        </button>
        <div class="text-xs text-gray-500 mt-2">Each rule has a weight (Core=3, Confluence=2, Filter=1).</div>
      </div>

      <div class="mt-5 flex items-center gap-2">
        <button id="finishOnboardingBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Create strategy & continue</button>
      </div>

      <div id="obMsg" class="text-xs text-red-300 mt-2"></div>
    </div>
  </div>

  <header class="sticky top-0 z-10 bg-gray-950/80 backdrop-blur border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center font-bold">TC</div>
        <div>
          <div class="font-semibold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Discipline + Post-Trade Review</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="dailyReviewBtn" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Daily Review</button>
        <button id="journalBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm font-medium">Journal</button>
        <button id="resetBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Reset Data</button>
        <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">

    <!-- Drift alert -->
    <div id="driftAlert" class="hidden rounded-xl border px-4 py-3"></div>

    <!-- Hero -->
    <section class="rounded-2xl border border-gray-800 bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 p-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <div id="greetingLine" class="text-2xl font-semibold">Good morning</div>
          <div id="subGreeting" class="text-sm text-gray-400 mt-1">Trade your plan, not your feelings.</div>
          <div id="quoteLine" class="text-sm text-gray-500 mt-2 italic">—</div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="rounded-xl border border-gray-800 bg-gray-950 px-4 py-3 min-w-[220px]">
            <div class="text-xs text-gray-400">Market open</div>
            <div id="marketOpenLine" class="text-lg font-semibold">—</div>
            <div id="marketCountdown" class="text-xs text-gray-500 mt-1">—</div>
          </div>
          <div class="rounded-xl border border-gray-800 bg-gray-950 px-4 py-3 min-w-[220px]">
            <div class="text-xs text-gray-400">Today's focus</div>
            <div id="todayFocusLine" class="text-sm text-gray-200 mt-1">Finish your Daily Review.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Performance -->
    <section class="rounded-2xl border border-gray-800 bg-gray-900 p-6">
      <div class="flex items-start justify-between gap-4 flex-col lg:flex-row">
        <div>
          <div class="text-lg font-semibold">Your dashboard</div>
          <div class="text-sm text-gray-400">Streaks, weekly summary, and your R-curve.</div>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-400">Week</label>
          <select id="weekSelect" class="bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm"></select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
          <div class="text-xs text-gray-400">Daily Review streak</div>
          <div id="streakReview" class="text-2xl font-semibold mt-1">0</div>
          <div class="text-xs text-gray-500 mt-1">Consecutive days you saved a review.</div>
        </div>
        <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
          <div class="text-xs text-gray-400">Disciplined streak</div>
          <div id="streakDisciplined" class="text-2xl font-semibold mt-1">0</div>
          <div class="text-xs text-gray-500 mt-1">Consecutive PD days (profitable + disciplined).</div>
        </div>
        <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
          <div class="text-xs text-gray-400">This week's Avg R</div>
          <div id="weekAvgR" class="text-2xl font-semibold mt-1">—</div>
          <div id="weekMini" class="text-xs text-gray-500 mt-1">—</div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-1 rounded-xl bg-gray-950 border border-gray-800 p-4">
          <div class="text-sm font-medium">Weekly summary</div>
          <div id="weeklySummary" class="text-sm text-gray-300 mt-3">—</div>
        </div>
        <div class="lg:col-span-2 rounded-xl bg-gray-950 border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">P&L curve (R)</div>
            <div class="text-xs text-gray-500">Updates as you log trades</div>
          </div>
          <div class="mt-3">
            <canvas id="rChart" height="110"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Total Trades (filtered)</div>
        <div id="statTotalTrades" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Avg Post Score (weighted)</div>
        <div id="statAvgScore" class="text-3xl font-bold mt-2">0%</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Win Rate (filtered)</div>
        <div id="statWinRate" class="text-3xl font-bold mt-2">0%</div>
      </div>
      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-5">
        <div class="text-sm text-gray-400">Avg Realized R (filtered)</div>
        <div id="statAvgR" class="text-3xl font-bold mt-2">0.00</div>
      </div>
    </section>

    <!-- Filters + visuals -->
    <section class="card rounded-2xl bg-gray-900 border border-gray-800 p-6">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <div class="text-lg font-semibold">Analytics Filters</div>
          <div class="text-sm text-gray-400">Slice by strategy/session/day. The truth hurts, but it's cheaper.</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-gray-400">Strategy</label>
            <select id="filterStrategy" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All strategies</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400">Session</label>
            <select id="filterSession" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All</option>
              <option value="Asia">Asia</option>
              <option value="London">London</option>
              <option value="NY">NY</option>
              <option value="ORB">ORB</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400">Day of week</label>
            <select id="filterDOW" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="ALL">All</option>
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Score Distribution (A/B/C)</div>
            <div class="text-xs text-gray-400">post score</div>
          </div>
          <div class="mt-4 space-y-3" id="distBars"></div>
        </div>

        <div class="rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Avg R by Grade</div>
            <div class="text-xs text-gray-400">completed reviews</div>
          </div>
          <div class="mt-4 space-y-3" id="rBars"></div>
        </div>
      </div>
    </section>

    <!-- Strategy builder + locks -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">Strategy Builder (weighted rules)</div>
            <div class="text-sm text-gray-400">Each checklist item has a weight 1–3.</div>
          </div>
          <button id="newStrategyBtn" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">New Strategy</button>
        </div>

        <div id="strategyCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5"></div>

        <div id="strategyFormWrap" class="hidden mt-6 rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Create Strategy</div>
            <button id="cancelStrategyBtn" class="text-sm text-gray-300 hover:text-white">Cancel</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="text-xs text-gray-400">Strategy name</label>
              <input id="sName" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., ORB Reversal"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Timeframe</label>
              <select id="sTF" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">Select</option>
                <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">Checklist items</div>
                <div class="text-xs text-gray-400">Rule text + weight (1–3)</div>
              </div>
              <button id="addRuleBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Add rule</button>
            </div>
            <div id="rulesList" class="mt-3 space-y-2"></div>
          </div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="saveStrategyBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save</button>
          </div>
        </div>
      </div>

      <div class="card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div class="text-lg font-semibold">Rule Locks</div>
        <div class="text-sm text-gray-400 mt-1">Warn or block low-quality trades in pre-trade mode.</div>

        <div class="mt-4 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Enable warning</div>
              <div class="text-xs text-gray-400">Show warning if predicted score is low</div>
            </div>
            <input id="lockWarn" type="checkbox" class="w-5 h-5">
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Enable hard block</div>
              <div class="text-xs text-gray-400">Prevent saving trade under threshold</div>
            </div>
            <input id="lockBlock" type="checkbox" class="w-5 h-5">
          </div>

          <div>
            <label class="text-xs text-gray-400">Score threshold (%)</label>
            <input id="lockThreshold" type="number" min="0" max="100" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 70">
          </div>

          <button id="saveLocksBtn" class="w-full mt-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Save Locks</button>

          <div class="text-xs text-gray-400">
            Tip: warn + 70%. When you're ready to stop donating to the market, enable block.
          </div>
        </div>
      </div>
    </section>

    <!-- Trade entry + Trades list -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div>
          <div class="text-lg font-semibold">Trade Entry</div>
          <div class="text-sm text-gray-400">Pre-trade checklist + confidence. Post-trade review is separate.</div>
        </div>

        <form id="tradeForm" class="mt-4 space-y-3">
          <div>
            <label class="text-xs text-gray-400">Strategy (required)</label>
            <select id="tStrategy" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
              <option value="">Select</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400">Symbol</label>
              <input id="tSymbol" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="AAPL / EURUSD / MNQ"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Session</label>
              <select id="tSession" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option>Asia</option><option>London</option><option>NY</option><option>ORB</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Date</label>
            <input id="tDate" type="date" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-gray-400">Entry</label>
              <input id="tEntry" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Stop</label>
              <input id="tStop" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Target</label>
              <input id="tTarget" type="number" step="0.00001" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400">Risk ($)</label>
              <input id="tRisk" type="number" step="0.01" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-400">Confidence (1–5)</label>
              <select id="tConfidence" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="1">1 (low)</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5 (high)</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Screenshot (optional in prototype)</label>
            <input id="tShot" type="file" accept="image/*" class="mt-1 w-full text-sm text-gray-300">
            <div class="text-xs text-gray-500 mt-1">Prototype stores a data URL in localStorage.</div>
          </div>

          <div>
            <label class="text-xs text-gray-400">Notes</label>
            <textarea id="tNotes" rows="2" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Reasoning, mistakes, etc."></textarea>
          </div>

          <button type="button" id="preTradeBtn" class="w-full px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">
            Pre-trade checklist
          </button>
        </form>
      </div>

      <div class="lg:col-span-2 card rounded-2xl bg-gray-900 border border-gray-800 p-6">
        <div>
          <div class="text-lg font-semibold">Trades</div>
          <div class="text-sm text-gray-400">Complete a post-trade review to unlock the best analytics.</div>
        </div>

        <!-- Quick add -->
        <div class="mt-4 rounded-2xl border border-gray-800 bg-gray-950 p-4">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <div class="text-sm font-medium">Quick add trade</div>
              <div class="text-xs text-gray-500">Minimal fields. You're journaling rules, not pretending you're a market maker.</div>
            </div>
          </div>

          <form id="quickTradeForm" class="mt-3 grid grid-cols-2 lg:grid-cols-6 gap-3">
            <div class="lg:col-span-2">
              <label class="text-xs text-gray-400">Symbol</label>
              <input id="qSymbol" class="mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="AAPL / MNQ / EURUSD"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Strategy</label>
              <select id="qStrategy" class="mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">Select</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400">Dir</label>
              <select id="qDir" class="mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="Long">Long</option>
                <option value="Short">Short</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400">Realized R</label>
              <input id="qR" type="number" step="0.1" class="mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="1.0"/>
            </div>
            <div>
              <label class="text-xs text-gray-400">Emotion tag (optional)</label>
              <select id="qEmotion" class="mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">None</option>
                <option>Revenge trade</option>
                <option>Overrisked</option>
                <option>FOMO</option>
                <option>Moved stop</option>
                <option>Let loser run</option>
                <option>Cut winner early</option>
              </select>
            </div>

            <div class="col-span-2 lg:col-span-6 flex items-center justify-end gap-2">
              <input id="qNote" class="flex-1 bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Optional note (one sentence)"/>
              <button id="qAddBtn" type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-medium">Add</button>
            </div>
          </form>
        </div>

        <div id="tradesList" class="mt-4 space-y-4"></div>
      </div>
    </section>
  </main>

  <!-- Pre-trade modal -->
  <div id="modalPre" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Pre-trade Checklist</div>
          <div class="text-sm text-gray-400">Predict score before saving.</div>
        </div>
        <button id="preClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div id="preWarn" class="hidden mt-4 rounded-xl border px-4 py-3 text-sm"></div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">Check what you truly have, not what you want.</div>
          <div id="preRules" class="mt-3 space-y-2"></div>
        </div>

        <div class="rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Predicted Score</div>
          <div class="mt-3">
            <div class="text-4xl font-bold" id="preScore">0%</div>
            <div class="text-sm text-gray-400 mt-1" id="preGrade">Grade: C</div>
          </div>

          <div class="mt-4 text-sm text-gray-300 space-y-1">
            <div><span class="text-gray-400">Unweighted:</span> <span id="preUnweighted">0%</span></div>
            <div><span class="text-gray-400">Strategy:</span> <span id="preStrategy">—</span></div>
            <div><span class="text-gray-400">Confidence:</span> <span id="preConf">—</span></div>
          </div>

          <div class="mt-5 flex items-center gap-2">
            <button id="saveTradeBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save trade</button>
            <button id="preCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancel</button>
          </div>

          <div class="text-xs text-gray-500 mt-3">
            Rule locks apply here. If block is enabled and score is under threshold, saving is disabled.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-trade review modal -->
  <div id="modalPost" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-4xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Post-trade Review</div>
          <div id="postSub" class="text-sm text-gray-400">Complete review to lock in truth.</div>
        </div>
        <button id="postClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div id="postLockMsg" class="hidden mt-4 rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-200"></div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left: screenshot + summary -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Trade Snapshot</div>
          <div class="text-xs text-gray-400 mt-1" id="postMeta">—</div>
          <div class="mt-3">
            <img id="postImg" class="hidden rounded-xl border border-gray-800 max-h-80 object-contain w-full bg-black" alt="chart">
            <div id="postNoImg" class="text-sm text-gray-500">No screenshot saved for this trade.</div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Pre Score</div>
              <div class="text-lg font-semibold" id="postPreScore">—</div>
            </div>
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Post Score</div>
              <div class="text-lg font-semibold" id="postPostScore">—</div>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400" id="postDelta">—</div>
        </div>

        <!-- Middle: post checklist -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Post Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">What actually happened.</div>
          <div id="postRules" class="mt-3 space-y-2"></div>
        </div>

        <!-- Right: outcome + mistakes -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="font-medium">Outcome & Review</div>
          <div class="text-xs text-gray-400 mt-1">Keep it structured so analytics work.</div>

          <div class="mt-3 space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-400">Result</label>
                <select id="prResult" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                  <option value="">Select</option>
                  <option value="win">Win</option>
                  <option value="loss">Loss</option>
                  <option value="be">Break-even</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-gray-400">Realized R</label>
                <input id="prR" type="number" step="0.01" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="e.g., 1.50 or -1.00">
              </div>
            </div>

            <div>
              <label class="text-xs text-gray-400">Exit reason</label>
              <select id="prExit" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
                <option value="">Select</option>
                <option>TP hit</option>
                <option>SL hit</option>
                <option>Manual exit</option>
                <option>Time stop</option>
                <option>Rule violation exit</option>
                <option>Other</option>
              </select>
            </div>

            <div>
              <div class="text-xs text-gray-400 mb-2">Mistake tags</div>
              <div id="mistakeChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div>
              <label class="text-xs text-gray-400">One-sentence lesson (required)</label>
              <input id="prLesson" maxlength="120" class="mt-1 w-full bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Next time I will...">
              <div class="text-xs text-gray-500 mt-1">Max 120 characters. No essays. No coping.</div>
            </div>

            <div class="flex items-center gap-2 pt-1">
              <button id="savePostBtn" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save post review</button>
              <button id="postCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancel</button>
            </div>

            <div class="text-xs text-gray-500">
              Post review locks 24 hours after you save it.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily review modal -->
  <div id="modalDaily" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-4xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Daily Review</div>
          <div id="dailySub" class="text-sm text-gray-400">A 5-minute truth session. Your excuses can wait.</div>
        </div>
        <button id="dailyClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left: date + summary -->
        <div class="lg:col-span-1 rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div class="font-medium">Day</div>
            <input id="dailyDate" type="date" class="bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
          </div>

          <div class="mt-4 rounded-xl bg-gray-950 border border-gray-800 p-4">
            <div class="text-xs text-gray-400">Auto summary</div>
            <div id="dailySummary" class="text-sm text-gray-200 mt-2">—</div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Trades</div>
              <div class="text-lg font-semibold" id="dailyTrades">0</div>
            </div>
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Avg R</div>
              <div class="text-lg font-semibold" id="dailyAvgR">0.00</div>
            </div>
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Win rate</div>
              <div class="text-lg font-semibold" id="dailyWinRate">0%</div>
            </div>
            <div class="rounded-lg bg-gray-950 border border-gray-800 p-3">
              <div class="text-xs text-gray-400">Reviews done</div>
              <div class="text-lg font-semibold" id="dailyReviewRate">0%</div>
            </div>
          </div>
        </div>

        <!-- Right: prompts -->
        <div class="lg:col-span-2 rounded-xl border border-gray-800 p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">Tonight's prompts</div>
              <div class="text-xs text-gray-400 mt-1">Generated from today's behavior. Not your intentions.</div>
            </div>
            <button id="dailyRegenerate" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Regenerate</button>
          </div>

          <div id="dailyPrompts" class="mt-4 space-y-4"></div>

          <div class="mt-5 flex items-center justify-end gap-2">
            <button id="dailySave" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-medium">Save daily review</button>
            <button id="dailyCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancel</button>
          </div>

          <div id="dailyMsg" class="text-xs text-red-300 mt-2"></div>
          <div class="text-xs text-gray-500 mt-3">Saved reviews stay editable. If you want "lock after 24h," we can add it.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Journal history modal -->
  <div id="modalJournal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-5xl rounded-2xl bg-gray-900 border border-gray-800 p-5">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Journal</div>
          <div class="text-sm text-gray-400">Your daily prompt, your answer, and the receipts.</div>
        </div>
        <button id="journalClose" class="text-gray-300 hover:text-white">✕</button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-1 rounded-xl border border-gray-800 overflow-hidden">
          <div class="flex items-center justify-between px-4 py-3 bg-gray-950 border-b border-gray-800">
            <div class="text-sm font-medium">Entries</div>
            <button id="journalExport" class="text-xs px-2 py-1 rounded-lg bg-gray-800 hover:bg-gray-700">Export</button>
          </div>
          <div id="journalList" class="max-h-[55vh] overflow-auto divide-y divide-gray-800"></div>
        </div>

        <div class="lg:col-span-2 rounded-xl border border-gray-800 p-4">
          <div class="rounded-xl bg-gray-950 border border-gray-800 p-4 mb-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm font-medium">Free write</div>
                <div class="text-xs text-gray-500 mt-1">No prompt. No judgment. Just text.</div>
              </div>
              <button id="freeWriteSave" class="text-xs px-2 py-1 rounded-lg bg-gray-800 hover:bg-gray-700">Save</button>
            </div>
            <textarea id="freeWriteText" rows="4" class="mt-3 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Dump the thoughts here..."></textarea>
          </div>

          <div id="journalDetail" class="text-sm text-gray-300">Select a date on the left.</div>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-end gap-2">
        <button id="journalDone" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Done</button>
      </div>
    </div>
  </div>

<script>
// =====================================================================
// SUPABASE CONFIGURATION
// =====================================================================
// TODO: Replace these with YOUR Supabase project credentials
// Get them from: https://supabase.com/dashboard/project/YOUR_PROJECT/settings/api
//
// 1. Go to your Supabase project settings
// 2. Copy "Project URL" → paste below as SUPABASE_URL
// 3. Copy "anon public" key → paste below as SUPABASE_ANON_KEY
// =====================================================================

const SUPABASE_URL = "https://hfnpqamhtxhhsrwmngtv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_2im62kUUfZ_WLgaHuNmP7w_vFsuE0QV";

// =====================================================================
// IMPORTANT: After updating credentials above, create these tables:
// =====================================================================
// Run this SQL in your Supabase SQL Editor:
/*

-- 1. Create profiles table
create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  username text,
  created_at timestamptz not null default now()
);

alter table public.profiles enable row level security;

create policy "profiles_select_own" on public.profiles 
  for select using (id = auth.uid());

create policy "profiles_insert_own" on public.profiles 
  for insert with check (id = auth.uid());

create policy "profiles_update_own" on public.profiles 
  for update using (id = auth.uid()) with check (id = auth.uid());

-- 2. Create app_state table
create table if not exists public.app_state (
  user_id uuid primary key references auth.users(id) on delete cascade,
  state jsonb not null default '{}'::jsonb,
  updated_at timestamptz not null default now()
);

alter table public.app_state enable row level security;

create policy "app_state_select_own" on public.app_state 
  for select using (user_id = auth.uid());

create policy "app_state_upsert_own" on public.app_state 
  for insert with check (user_id = auth.uid());

create policy "app_state_update_own" on public.app_state 
  for update using (user_id = auth.uid()) with check (user_id = auth.uid());

*/
// =====================================================================

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentEmail = "";
let currentUsername = "";
let currentUser = null;

const MS_24H = 24 * 60 * 60 * 1000;

// Helper functions
const todayISO = () => new Date().toISOString().slice(0,10);
const dowShort = (isoDate) => {
  const d = new Date(isoDate + "T00:00:00");
  return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
};
const gradeFromPct = (pct) => pct >= 80 ? "A" : (pct >= 60 ? "B" : "C");

const mistakeOptions = [
  "Early entry","Late entry","No confirmation","Moved stop","Cut winner early","Let loser run",
  "Revenge trade","Overrisked","FOMO","None"
];

const defaultState = {
  locks: { warn:false, block:false, threshold:70 },
  strategies: [],
  trades: [],
  journals: [],
  freeWrites: []
};

const getLSKey = () => currentUserId ? `tradecheck_v4_${currentUserId}` : `tradecheck_v4__blocked`;

const loadState = () => {
  try {
    const raw = localStorage.getItem(getLSKey());
    if (!raw) return structuredClone(defaultState);
    return JSON.parse(raw);
  } catch(e) {
    return structuredClone(defaultState);
  }
};

const saveState = (st) => localStorage.setItem(getLSKey(), JSON.stringify(st));

async function loadStateRemote(){
  const { data, error } = await sb.from("app_state").select("state").eq("user_id", currentUserId).maybeSingle();
  if(error) throw error;
  return data?.state || null;
}

async function saveStateRemote(st){
  const payload = { user_id: currentUserId, state: st, updated_at: new Date().toISOString() };
  const { error } = await sb.from("app_state").upsert(payload);
  if(error) throw error;
}

let _remoteSaveTimer = null;
const saveStateSmart = (st) => {
  saveState(st);
  if(!currentUserId) return;
  clearTimeout(_remoteSaveTimer);
  _remoteSaveTimer = setTimeout(async ()=>{
    try { await saveStateRemote(st); } catch(e){ console.warn("Remote save failed:", e); }
  }, 500);
};

let state = structuredClone(defaultState);

const numOrNull = (v) => {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
};

const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const escapeAttr = (s) => escapeHtml(s).replaceAll("\n"," ");

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function show(el){ if(!el) return; el.classList.remove("hidden"); el.classList.add("flex"); }
function hide(el){ if(!el) return; el.classList.add("hidden"); el.classList.remove("flex"); }

// DOM refs
const authGate = document.getElementById("authGate");
const onboardingGate = document.getElementById("onboardingGate");
const authEmail = document.getElementById("authEmail");
const authPass = document.getElementById("authPass");
const authMsg = document.getElementById("authMsg");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const logoutBtn = document.getElementById("logoutBtn");
const onboardLogout = document.getElementById("onboardLogout");

const obName = document.getElementById("obName");
const obTF = document.getElementById("obTF");
const obRulesList = document.getElementById("obRulesList");
const obAddRuleBtn = document.getElementById("obAddRuleBtn");
const finishOnboardingBtn = document.getElementById("finishOnboardingBtn");
const obMsg = document.getElementById("obMsg");

const driftAlert = document.getElementById("driftAlert");
const statTotalTrades = document.getElementById("statTotalTrades");
const statAvgScore = document.getElementById("statAvgScore");
const statWinRate = document.getElementById("statWinRate");
const statAvgR = document.getElementById("statAvgR");

const filterStrategy = document.getElementById("filterStrategy");
const filterSession = document.getElementById("filterSession");
const filterDOW = document.getElementById("filterDOW");

const distBars = document.getElementById("distBars");
const rBars = document.getElementById("rBars");

const strategyCards = document.getElementById("strategyCards");
const newStrategyBtn = document.getElementById("newStrategyBtn");
const strategyFormWrap = document.getElementById("strategyFormWrap");
const cancelStrategyBtn = document.getElementById("cancelStrategyBtn");
const sName = document.getElementById("sName");
const sTF = document.getElementById("sTF");
const addRuleBtn = document.getElementById("addRuleBtn");
const rulesList = document.getElementById("rulesList");
const saveStrategyBtn = document.getElementById("saveStrategyBtn");

const lockWarn = document.getElementById("lockWarn");
const lockBlock = document.getElementById("lockBlock");
const lockThreshold = document.getElementById("lockThreshold");
const saveLocksBtn = document.getElementById("saveLocksBtn");

const tStrategy = document.getElementById("tStrategy");
const tSymbol = document.getElementById("tSymbol");
const tSession = document.getElementById("tSession");
const tDate = document.getElementById("tDate");
const tEntry = document.getElementById("tEntry");
const tStop = document.getElementById("tStop");
const tTarget = document.getElementById("tTarget");
const tRisk = document.getElementById("tRisk");
const tConfidence = document.getElementById("tConfidence");
const tShot = document.getElementById("tShot");
const tNotes = document.getElementById("tNotes");
const preTradeBtn = document.getElementById("preTradeBtn");
const tradesList = document.getElementById("tradesList");

const modalPre = document.getElementById("modalPre");
const preClose = document.getElementById("preClose");
const preCancel = document.getElementById("preCancel");
const preWarn = document.getElementById("preWarn");
const preRules = document.getElementById("preRules");
const preScore = document.getElementById("preScore");
const preGrade = document.getElementById("preGrade");
const preUnweighted = document.getElementById("preUnweighted");
const preStrategy = document.getElementById("preStrategy");
const preConf = document.getElementById("preConf");
const saveTradeBtn = document.getElementById("saveTradeBtn");

const modalPost = document.getElementById("modalPost");
const postClose = document.getElementById("postClose");
const postCancel = document.getElementById("postCancel");
const postLockMsg = document.getElementById("postLockMsg");
const postMeta = document.getElementById("postMeta");
const postImg = document.getElementById("postImg");
const postNoImg = document.getElementById("postNoImg");
const postPreScore = document.getElementById("postPreScore");
const postPostScore = document.getElementById("postPostScore");
const postDelta = document.getElementById("postDelta");
const postRules = document.getElementById("postRules");
const prResult = document.getElementById("prResult");
const prR = document.getElementById("prR");
const prExit = document.getElementById("prExit");
const mistakeChips = document.getElementById("mistakeChips");
const prLesson = document.getElementById("prLesson");
const savePostBtn = document.getElementById("savePostBtn");

const resetBtn = document.getElementById("resetBtn");

const dailyReviewBtn = document.getElementById("dailyReviewBtn");
const modalDaily = document.getElementById("modalDaily");
const dailyClose = document.getElementById("dailyClose");
const dailyCancel = document.getElementById("dailyCancel");
const dailyDate = document.getElementById("dailyDate");
const dailySummary = document.getElementById("dailySummary");
const dailyTrades = document.getElementById("dailyTrades");
const dailyAvgR = document.getElementById("dailyAvgR");
const dailyWinRate = document.getElementById("dailyWinRate");
const dailyReviewRate = document.getElementById("dailyReviewRate");
const dailyPrompts = document.getElementById("dailyPrompts");
const dailyRegenerate = document.getElementById("dailyRegenerate");
const dailySave = document.getElementById("dailySave");
const dailyMsg = document.getElementById("dailyMsg");

const journalBtn = document.getElementById("journalBtn");
const modalJournal = document.getElementById("modalJournal");
const journalClose = document.getElementById("journalClose");
const journalDone = document.getElementById("journalDone");
const journalList = document.getElementById("journalList");
const journalDetail = document.getElementById("journalDetail");
const journalExport = document.getElementById("journalExport");

const greetingLine = document.getElementById("greetingLine");
const marketOpenLine = document.getElementById("marketOpenLine");
const marketCountdown = document.getElementById("marketCountdown");
const todayFocusLine = document.getElementById("todayFocusLine");

const weekSelect = document.getElementById("weekSelect");
const streakReview = document.getElementById("streakReview");
const streakDisciplined = document.getElementById("streakDisciplined");
const weekAvgR = document.getElementById("weekAvgR");
const weekMini = document.getElementById("weekMini");
const weeklySummary = document.getElementById("weeklySummary");
const rChartCanvas = document.getElementById("rChart");
const quoteLine = document.getElementById("quoteLine");

const quickTradeForm = document.getElementById("quickTradeForm");
const qSymbol = document.getElementById("qSymbol");
const qStrategy = document.getElementById("qStrategy");
const qDir = document.getElementById("qDir");
const qR = document.getElementById("qR");
const qEmotion = document.getElementById("qEmotion");
const qNote = document.getElementById("qNote");

const freeWriteText = document.getElementById("freeWriteText");
const freeWriteSave = document.getElementById("freeWriteSave");

function setAuthMessage(t){ if(authMsg) authMsg.textContent = t || ""; }
function setObMessage(t){ if(obMsg) obMsg.textContent = t || ""; }
function setDailyMessage(t){ if(dailyMsg) dailyMsg.textContent = t || ""; }

// Auth functions
async function sbSignUp(email, password){
  const { data, error } = await sb.auth.signUp({ email, password });
  if(error) throw error;
  return data;
}

async function sbLogin(email, password){
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) throw error;
  return data;
}

async function sbLogout(){
  const { error } = await sb.auth.signOut();
  if(error) throw error;
}

// Scoring
const computeWeightedPct = (strategy, checks) => {
  const weights = strategy.rules.map(r => Math.max(1, Math.min(3, Number(r.w) || 1)));
  const totalW = weights.reduce((a,b)=>a+b,0) || 1;
  const gotW = weights.reduce((sum,w,i)=> sum + (checks[i] ? w : 0), 0);
  return Math.round((gotW/totalW)*100);
};

const computeUnweightedPct = (checks) => {
  const total = checks.length || 1;
  const got = checks.filter(Boolean).length;
  return Math.round((got/total)*100);
};

// Filters
function applyFilters(trades) {
  let out = [...trades];
  const s = filterStrategy.value;
  const sess = filterSession.value;
  const dow = filterDOW.value;
  if (s !== "ALL") out = out.filter(t => String(t.strategyId) === String(s));
  if (sess !== "ALL") out = out.filter(t => t.session === sess);
  if (dow !== "ALL") out = out.filter(t => dowShort(t.date) === dow);
  return out;
}

function syncFiltersAndSelects() {
  tStrategy.innerHTML = `<option value="">Select</option>` + state.strategies.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
  if(qStrategy) qStrategy.innerHTML = tStrategy.innerHTML;
  filterStrategy.innerHTML = `<option value="ALL">All strategies</option>` + state.strategies.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
}

function renderLocks() {
  lockWarn.checked = !!state.locks.warn;
  lockBlock.checked = !!state.locks.block;
  lockThreshold.value = state.locks.threshold ?? 70;
}

function renderStrategies() {
  strategyCards.innerHTML = "";
  state.strategies.forEach(s => {
    const rulesPreview = s.rules.slice(0,3).map(r => `<li class="text-sm text-gray-300">• ${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></li>`).join("");
    const more = s.rules.length > 3 ? `<li class="text-xs text-gray-500 mt-1">+${s.rules.length-3} more</li>` : "";
    const card = document.createElement("div");
    card.className = "rounded-2xl bg-gray-950 border border-gray-800 p-4";
    card.innerHTML = `
      <div class="flex items-start justify-between">
        <div>
          <div class="font-semibold">${escapeHtml(s.name)}</div>
          <div class="text-xs text-gray-500 mt-1">Timeframe: ${escapeHtml(s.tf || "")}</div>
        </div>
        <button class="useStrategy px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-xs" data-id="${s.id}">Use</button>
      </div>
      <ul class="mt-3">${rulesPreview}${more}</ul>
    `;
    strategyCards.appendChild(card);
  });

  document.querySelectorAll(".useStrategy").forEach(btn => {
    btn.addEventListener("click", () => {
      tStrategy.value = btn.dataset.id;
      window.scrollTo({ top: document.getElementById("tradeForm").getBoundingClientRect().top + window.scrollY - 90, behavior:"smooth" });
    });
  });
}

function openStrategyForm() {
  strategyFormWrap.classList.remove("hidden");
  rulesList.innerHTML = "";
  sName.value = "";
  sTF.value = "";
  addRuleRow();
  addRuleRow();
  addRuleRow();
}

function closeStrategyForm() {
  strategyFormWrap.classList.add("hidden");
}

function addRuleRow(text="", w=1) {
  const row = document.createElement("div");
  row.className = "grid grid-cols-12 gap-2";
  row.innerHTML = `
    <input class="ruleText col-span-9 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Rule text" value="${escapeAttr(text)}">
    <select class="ruleW col-span-2 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm">
      <option value="1" ${String(w)==="1"?"selected":""}>Filter</option>
      <option value="2" ${String(w)==="2"?"selected":""}>Confluence</option>
      <option value="3" ${String(w)==="3"?"selected":""}>Core</option>
    </select>
    <button type="button" class="delRule col-span-1 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">✕</button>
  `;
  rulesList.appendChild(row);
  row.querySelector(".delRule").addEventListener("click", () => row.remove());
}

newStrategyBtn.addEventListener("click", () => openStrategyForm());
cancelStrategyBtn.addEventListener("click", () => closeStrategyForm());
addRuleBtn.addEventListener("click", () => addRuleRow());

saveStrategyBtn.addEventListener("click", () => {
  const name = (sName.value || "").trim();
  const tf = (sTF.value || "").trim();
  const texts = Array.from(document.querySelectorAll(".ruleText")).map(x => (x.value||"").trim()).filter(Boolean);
  const ws = Array.from(document.querySelectorAll(".ruleW")).map(x => Number(x.value)||1);
  if(!name) { alert("Strategy name is required."); return; }
  if(!tf) { alert("Timeframe is required."); return; }
  if(texts.length === 0) { alert("Add at least one rule."); return; }

  const rules = texts.map((t,i)=>({ text:t, w: Math.max(1, Math.min(3, ws[i] || 1)) }));
  state.strategies.push({ id: Date.now(), name, tf, rules });
  saveStateSmart(state);
  closeStrategyForm();
  renderAll();
});

saveLocksBtn.addEventListener("click", () => {
  state.locks.warn = !!lockWarn.checked;
  state.locks.block = !!lockBlock.checked;
  state.locks.threshold = Math.max(0, Math.min(100, Number(lockThreshold.value) || 0));
  saveStateSmart(state);
  alert("Locks saved.");
  renderAll(false);
});

function renderDrift(){
  driftAlert.classList.add("hidden");
}

function renderStatsAndCharts() {
  const filtered = applyFilters(state.trades);

  statTotalTrades.textContent = String(filtered.length);

  const reviewed = filtered.filter(t => t.postReview && Number.isFinite(t.postReview.realizedR));
  const avgScore = reviewed.length
    ? Math.round(reviewed.reduce((a,t)=>a+(t.post?.weightedPct||0),0)/reviewed.length)
    : 0;
  statAvgScore.textContent = `${avgScore}%`;

  const wins = reviewed.filter(t => t.postReview.result === "win").length;
  const winRate = reviewed.length ? Math.round((wins/reviewed.length)*100) : 0;
  statWinRate.textContent = `${winRate}%`;

  const avgR = reviewed.length
    ? (reviewed.reduce((a,t)=>a+(Number(t.postReview.realizedR)||0),0)/reviewed.length)
    : 0;
  statAvgR.textContent = avgR.toFixed(2);

  const dist = { A:0, B:0, C:0 };
  reviewed.forEach(t => dist[gradeFromPct(t.post?.weightedPct ?? 0)]++);
  const total = reviewed.length || 1;

  distBars.innerHTML = ["A","B","C"].map(g=>{
    const pct = Math.round((dist[g]/total)*100);
    const barColor = g==="A" ? "bg-emerald-500/40" : (g==="B" ? "bg-amber-500/40" : "bg-red-500/40");
    return `
      <div>
        <div class="flex items-center justify-between text-sm">
          <div class="text-gray-300">${g}-grade</div>
          <div class="text-gray-400">${dist[g]} (${pct}%)</div>
        </div>
        <div class="mt-2 w-full bg-gray-950 border border-gray-800 rounded-full h-3 overflow-hidden">
          <div class="${barColor} h-3" style="width:${pct}%"></div>
        </div>
      </div>
    `;
  }).join("");

  const by = { A:[], B:[], C:[] };
  reviewed.forEach(t => {
    const g = gradeFromPct(t.post?.weightedPct ?? 0);
    by[g].push(Number(t.postReview.realizedR));
  });
  
  rBars.innerHTML = ["A","B","C"].map(g=>{
    const arr = by[g];
    const avg = arr.length ? (arr.reduce((a,x)=>a+x,0)/arr.length) : 0;
    const pct = Math.max(0, Math.min(100, Math.round(((avg+3)/6)*100)));
    const barColor = g==="A" ? "bg-emerald-500/40" : (g==="B" ? "bg-amber-500/40" : "bg-red-500/40");
    return `
      <div>
        <div class="flex items-center justify-between text-sm">
          <div class="text-gray-300">${g}-grade avg R</div>
          <div class="text-gray-400">${avg.toFixed(2)} (n=${arr.length})</div>
        </div>
        <div class="mt-2 w-full bg-gray-950 border border-gray-800 rounded-full h-3 overflow-hidden">
          <div class="${barColor} h-3" style="width:${pct}%"></div>
        </div>
      </div>
    `;
  }).join("");
}

// Pre-trade modal
let preChecks = [];

function openPreModal() {
  const sid = tStrategy.value;
  if(!sid){ alert("Select a strategy."); return; }
  const strategy = state.strategies.find(x => String(x.id) === String(sid));
  if(!strategy) { alert("Strategy not found."); return; }

  preChecks = strategy.rules.map(()=>false);
  preRules.innerHTML = strategy.rules.map((r,i)=>`
    <label class="flex items-start gap-3 text-sm">
      <input type="checkbox" data-i="${i}" class="mt-1 w-4 h-4">
      <span class="text-gray-200">${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></span>
    </label>
  `).join("");

  preRules.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const i = Number(cb.dataset.i);
      preChecks[i] = cb.checked;
      refreshPreScore();
    });
  });

  preStrategy.textContent = strategy.name;
  preConf.textContent = tConfidence.value;
  refreshPreScore();
  modalPre.classList.remove("hidden");
  modalPre.classList.add("flex");
}

function closePreModal() {
  modalPre.classList.add("hidden");
  modalPre.classList.remove("flex");
}

function refreshPreScore(){
  const sid = tStrategy.value;
  const strategy = state.strategies.find(x => String(x.id) === String(sid));
  const weightedPct = computeWeightedPct(strategy, preChecks);
  const unweightedPct = computeUnweightedPct(preChecks);
  preScore.textContent = `${weightedPct}%`;
  preUnweighted.textContent = `${unweightedPct}%`;
  preGrade.textContent = `Grade: ${gradeFromPct(weightedPct)}`;

  const th = Number(state.locks.threshold ?? 70);
  const warnOn = !!state.locks.warn;
  const blockOn = !!state.locks.block;

  preWarn.classList.add("hidden");
  preWarn.className = "hidden mt-4 rounded-xl border px-4 py-3 text-sm";

  if((warnOn || blockOn) && weightedPct < th){
    preWarn.classList.remove("hidden");
    preWarn.className = "mt-4 rounded-xl border px-4 py-3 text-sm border-amber-500/30 bg-amber-500/10 text-amber-200";
    preWarn.textContent = `Predicted score ${weightedPct}% is under threshold ${th}%.`;
  }

  if(blockOn && weightedPct < th){
    saveTradeBtn.disabled = true;
    saveTradeBtn.classList.add("disabled");
    saveTradeBtn.textContent = "Blocked by lock";
  } else {
    saveTradeBtn.disabled = false;
    saveTradeBtn.classList.remove("disabled");
    saveTradeBtn.textContent = "Save trade";
  }
}

preTradeBtn.addEventListener("click", openPreModal);
preClose.addEventListener("click", closePreModal);
preCancel.addEventListener("click", closePreModal);

saveTradeBtn.addEventListener("click", async () => {
  const sid = tStrategy.value;
  const strategy = state.strategies.find(x => String(x.id) === String(sid));
  if(!strategy) return;

  const weightedPct = computeWeightedPct(strategy, preChecks);
  const th = Number(state.locks.threshold ?? 70);
  if(state.locks.block && weightedPct < th) return;

  const symbol = (tSymbol.value || "").trim();
  const date = tDate.value || todayISO();
  const entry = numOrNull(tEntry.value);
  const stop = numOrNull(tStop.value);
  const target = numOrNull(tTarget.value);
  const risk = numOrNull(tRisk.value);
  const confidence = Number(tConfidence.value) || 3;
  const notes = (tNotes.value || "").trim();

  let shot = null;
  if (tShot.files && tShot.files[0]) {
    try { shot = await fileToDataURL(tShot.files[0]); } catch(e) { shot = null; }
  }

  const trade = {
    id: Date.now(),
    strategyId: Number(sid),
    symbol, 
    session: tSession.value,
    date,
    entry, stop, target, risk,
    confidence,
    notes,
    screenshot: shot,
    createdAt: Date.now(),
    pre: { checks:[...preChecks], weightedPct, unweightedPct: computeUnweightedPct(preChecks) },
    post: null,
    postReview: null
  };

  state.trades.unshift(trade);
  saveStateSmart(state);

  tSymbol.value = "";
  tEntry.value = "";
  tStop.value = "";
  tTarget.value = "";
  tRisk.value = "";
  tNotes.value = "";
  tShot.value = "";
  closePreModal();
  renderAll();
});

// Post-trade review modal
let postTradeId = null;
let postChecks = [];
let postMistakes = new Set(["None"]);

function postReviewLocked(t){
  if(!t.postReview?.completedAt) return false;
  return (Date.now() - t.postReview.completedAt) > MS_24H;
}

function openPostModal(tradeId){
  const t = state.trades.find(x=>x.id===tradeId);
  if(!t) return;
  postTradeId = tradeId;

  const strat = state.strategies.find(s=>s.id===t.strategyId);
  const locked = postReviewLocked(t);

  postMeta.textContent = `${t.symbol || "—"} • ${t.session} • ${t.date} • ${strat?.name || "Strategy"}`;
  postPreScore.textContent = `${t.pre?.weightedPct ?? 0}% (${gradeFromPct(t.pre?.weightedPct ?? 0)})`;
  postPostScore.textContent = t.post ? `${t.post.weightedPct}% (${gradeFromPct(t.post.weightedPct)})` : "—";
  const d = (t.post?.weightedPct ?? 0) - (t.pre?.weightedPct ?? 0);
  postDelta.innerHTML = `Delta: <span class="${d>=0?"text-emerald-300":"text-red-300"} font-medium">${d>=0?"+":""}${d}%</span>`;

  if(t.screenshot){
    postImg.src = t.screenshot;
    postImg.classList.remove("hidden");
    postNoImg.classList.add("hidden");
  } else {
    postImg.classList.add("hidden");
    postNoImg.classList.remove("hidden");
  }

  postLockMsg.classList.add("hidden");
  if(locked){
    postLockMsg.textContent = "This review is locked (24h passed since saving).";
    postLockMsg.classList.remove("hidden");
  }

  const rules = strat?.rules || [];
  postChecks = (t.post?.checks && t.post.checks.length===rules.length) ? [...t.post.checks] : rules.map(()=>false);

  postRules.innerHTML = rules.map((r,i)=>`
    <label class="flex items-start gap-3 text-sm">
      <input type="checkbox" data-i="${i}" class="mt-1 w-4 h-4" ${postChecks[i]?"checked":""} ${locked?"disabled":""}>
      <span class="text-gray-200">${escapeHtml(r.text)} <span class="text-xs text-gray-500">(w${r.w})</span></span>
    </label>
  `).join("");

  postRules.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      if(locked) return;
      const i = Number(cb.dataset.i);
      postChecks[i] = cb.checked;
      const weightedPct = computeWeightedPct(strat, postChecks);
      const unweightedPct = computeUnweightedPct(postChecks);
      t.post = { checks:[...postChecks], weightedPct, unweightedPct };
      saveStateSmart(state);
      postPostScore.textContent = `${weightedPct}% (${gradeFromPct(weightedPct)})`;
      const preW = t.pre?.weightedPct ?? 0;
      const d2 = weightedPct - preW;
      postDelta.innerHTML = `Delta: <span class="${d2>=0?"text-emerald-300":"text-red-300"} font-medium">${d2>=0?"+":""}${d2}%</span>`;
      renderAll(false);
    });
  });

  prResult.value = t.postReview?.result || "";
  prR.value = (t.postReview?.realizedR ?? "");
  prExit.value = (t.postReview?.exitReason ?? "");
  prLesson.value = (t.postReview?.lesson ?? "");
  postMistakes = new Set((t.postReview?.mistakes && t.postReview.mistakes.length) ? t.postReview.mistakes : ["None"]);
  renderMistakeChips(locked);

  modalPost.classList.remove("hidden");
  modalPost.classList.add("flex");
}

function closePostModal(){
  modalPost.classList.add("hidden");
  modalPost.classList.remove("flex");
  postTradeId = null;
}

postClose.addEventListener("click", closePostModal);
postCancel.addEventListener("click", closePostModal);

function renderMistakeChips(locked) {
  mistakeChips.innerHTML = "";
  mistakeOptions.forEach(label => {
    const isOn = postMistakes.has(label);
    const chip = document.createElement("button");
    chip.type = "button";
    chip.disabled = locked;
    chip.className = `chip px-3 py-1.5 rounded-full text-xs ${isOn ? "bg-blue-600/20 border-blue-500/30 text-blue-200" : "bg-gray-950 border-gray-800 text-gray-300"} ${locked ? "disabled" : "hover:bg-gray-900"}`;
    chip.textContent = label;

    chip.addEventListener("click", () => {
      if (locked) return;

      if (label === "None") {
        postMistakes = new Set(["None"]);
      } else {
        postMistakes.delete("None");
        if (postMistakes.has(label)) postMistakes.delete(label);
        else postMistakes.add(label);
        if (postMistakes.size === 0) postMistakes.add("None");
      }
      renderMistakeChips(false);
    });

    mistakeChips.appendChild(chip);
  });
}

savePostBtn.addEventListener("click", () => {
  const t = state.trades.find(x => x.id === postTradeId);
  if (!t) return;
  if (postReviewLocked(t)) return;

  const result = prResult.value;
  const realizedR = numOrNull(prR.value);
  const exitReason = prExit.value;
  const lesson = (prLesson.value || "").trim();
  const mistakes = Array.from(postMistakes);

  if (!result) { alert("Select result (Win/Loss/BE)."); return; }
  if (!Number.isFinite(Number(realizedR))) { alert("Enter realized R (number)."); return; }
  if (!exitReason) { alert("Select exit reason."); return; }
  if (!lesson) { alert("Lesson is required."); return; }

  t.postReview = {
    result,
    realizedR: Number(realizedR),
    exitReason,
    mistakes: mistakes.length ? mistakes : ["None"],
    lesson,
    completedAt: Date.now()
  };

  saveStateSmart(state);
  closePostModal();
  renderAll();
});

function tradeCard(t){
  const strat = state.strategies.find(s=>s.id===t.strategyId);
  const preW = t.pre?.weightedPct ?? 0;
  const postW = t.post?.weightedPct ?? null;
  const grade = gradeFromPct(postW ?? preW);
  const hasReview = !!t.postReview?.completedAt;
  const r = hasReview ? Number(t.postReview.realizedR) : null;

  const badge = grade==="A" ? "bg-emerald-500/15 border-emerald-500/25 text-emerald-200"
    : grade==="B" ? "bg-amber-500/15 border-amber-500/25 text-amber-200"
    : "bg-red-500/15 border-red-500/25 text-red-200";

  return `
    <div class="rounded-2xl bg-gray-950 border border-gray-800 p-4">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="font-semibold truncate">${escapeHtml(t.symbol || "—")}</div>
            <div class="text-xs text-gray-500">${escapeHtml(t.session)} • ${escapeHtml(t.date)}</div>
            <div class="px-2 py-0.5 text-xs rounded-full border ${badge}">Grade ${grade}</div>
            ${hasReview ? `<div class="px-2 py-0.5 text-xs rounded-full border border-gray-700 text-gray-300">R ${r.toFixed(2)}</div>` : `<div class="px-2 py-0.5 text-xs rounded-full border border-gray-700 text-gray-400">Post review pending</div>`}
          </div>
          <div class="text-xs text-gray-400 mt-1 truncate">${escapeHtml(strat?.name || "Strategy")} • Pre ${preW}% ${postW!=null?` • Post ${postW}%`:""}</div>
          ${t.notes ? `<div class="text-sm text-gray-300 mt-2">${escapeHtml(t.notes)}</div>` : ""}
        </div>

        <div class="flex items-center gap-2">
          <button class="openPost px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-id="${t.id}">Post review</button>
          <button class="delTrade px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-id="${t.id}">Delete</button>
        </div>
      </div>
    </div>
  `;
}

function renderTrades(){
  const filtered = applyFilters(state.trades);
  if(filtered.length === 0){
    tradesList.innerHTML = `<div class="rounded-xl border border-gray-800 p-4 text-sm text-gray-400">No trades yet. Start with a pre-trade checklist.</div>`;
    return;
  }
  tradesList.innerHTML = filtered.map(tradeCard).join("");

  document.querySelectorAll(".openPost").forEach(btn=>{
    btn.addEventListener("click", ()=> openPostModal(Number(btn.dataset.id)));
  });
  
  document.querySelectorAll(".delTrade").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = Number(btn.dataset.id);
      state.trades = state.trades.filter(x=>x.id!==id);
      saveStateSmart(state);
      renderAll(false);
    });
  });
}

resetBtn.addEventListener("click", () => {
  if(!confirm("This will delete ALL local data. Are you sure?")) return;
  localStorage.removeItem(getLSKey());
  state = structuredClone(defaultState);
  if(currentUserId){
    saveStateRemote(state).catch(e => console.warn("Remote reset failed:", e));
  }
  renderAll();
});

// Onboarding
function addRuleRowTo(listEl, text="", w=1){
  const row = document.createElement("div");
  row.className = "grid grid-cols-12 gap-2";
  row.innerHTML = `
    <input class="col-span-9 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm ruleText" placeholder="Rule" value="${escapeAttr(text)}">
    <select class="col-span-2 bg-gray-950 border border-gray-800 rounded-lg px-3 py-2 text-sm ruleW">
      <option value="1" ${String(w)==="1" ? "selected" : ""}>Filter</option>
      <option value="2" ${String(w)==="2" ? "selected" : ""}>Confluence</option>
      <option value="3" ${String(w)==="3" ? "selected" : ""}>Core</option>
    </select>
    <button type="button" class="col-span-1 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm delRule">✕</button>
  `;
  row.querySelector(".delRule").addEventListener("click", () => row.remove());
  listEl.appendChild(row);
}

function readRuleRows(listEl){
  const rows = Array.from(listEl.querySelectorAll("div"));
  const out = [];
  rows.forEach(r=>{
    const t = (r.querySelector(".ruleText")?.value || "").trim();
    const w = Number(r.querySelector(".ruleW")?.value || 1);
    if(t) out.push({ text: t, w: Math.max(1, Math.min(3, w)) });
  });
  return out;
}

if(obAddRuleBtn){
  obAddRuleBtn.addEventListener("click", () => addRuleRowTo(obRulesList, "", 1));
}

function initOnboardingRules(){
  if(obRulesList && obRulesList.children.length === 0){
    addRuleRowTo(obRulesList, "HTF bias aligned", 3);
    addRuleRowTo(obRulesList, "Entry at key level", 3);
    addRuleRowTo(obRulesList, "Confirmation candle", 2);
    addRuleRowTo(obRulesList, "Risk within limit", 2);
    addRuleRowTo(obRulesList, "Session allowed", 1);
  }
}

function finishOnboarding(){
  setObMessage("");
  const name = (obName.value || "").trim();
  const tf = (obTF.value || "").trim();
  const rules = readRuleRows(obRulesList);

  if(!name){ setObMessage("Strategy name is required."); return; }
  if(!tf){ setObMessage("Timeframe is required."); return; }
  if(!rules.length){ setObMessage("Add at least one rule."); return; }

  state.strategies.push({ id: Date.now(), name, tf, rules });
  saveStateSmart(state);
  localStorage.removeItem("tc_new_user_flag_v1");
  hide(onboardingGate);
  renderAll();
}

if(finishOnboardingBtn){
  finishOnboardingBtn.addEventListener("click", finishOnboarding);
}

// Daily Review
const EMO_MISTAKES = new Set(["Revenge trade","Overrisked","FOMO","Moved stop","Let loser run","Cut winner early"]);

const promptLibrary = [
  { id:"ue_1", quad:"UE", title:"Stop donating", text:"Today was unprofitable and emotional. Name the exact trigger that started the spiral. What is your one circuit-breaker rule (timer, walk, flat) for next time?" },
  { id:"ue_2", quad:"UE", title:"Tilt timeline", text:"Write a 5-line timeline: first bad decision, second bad decision, and the moment you could have stopped. Where do you install the stop button tomorrow?" },
  { id:"ue_3", quad:"UE", title:"Size is not therapy", text:"If you oversized or chased, what were you trying to fix with size? Define your max risk and the automatic action when you hit it." },
  { id:"ue_4", quad:"UE", title:"The rule you negotiated", text:"Which rule did you negotiate today? Write the exact wording. Now write the consequence if you break it tomorrow (reduced size or no trading)." },
  { id:"ue_5", quad:"UE", title:"Review avoidance", text:"If you skipped post reviews, what were you avoiding: shame, boredom, or accountability? Design a 2-minute review template you can't dodge." },

  { id:"ud_1", quad:"UD", title:"Good process, bad outcome", text:"You traded with discipline but lost money. What did you execute correctly, and what part of the edge needs refinement (selection, trigger, stop, target)?" },
  { id:"ud_2", quad:"UD", title:"Selection audit", text:"List each trade and its grade. Which one was the weakest and why did it still pass? Tighten one filter rule." },
  { id:"ud_3", quad:"UD", title:"Acceptable losses", text:"Define an 'acceptable loss' trade: what must be true for you to be proud even when it loses?" },
  { id:"ud_4", quad:"UD", title:"Next improvement", text:"Pick the smallest change that would have improved today's expectancy (better level, better timing, fewer trades). Make it measurable." },
  { id:"ud_5", quad:"UD", title:"Edge reality check", text:"Pick one rule-following loser. If you took it 50 times, would it be profitable? If not, what condition is missing from your strategy?" },

  { id:"pe_1", quad:"PE", title:"Profit doesn't pardon chaos", text:"You made money but traded emotionally. Which emotional behavior paid today, and why will it punish you later? Write the rule that bans it." },
  { id:"pe_2", quad:"PE", title:"Lucky vs clean", text:"Pick your biggest winner. Was it A-grade or a lucky C-grade? If it was lucky, what rule would have blocked it and saved you long-term?" },
  { id:"pe_3", quad:"PE", title:"Post-win overtrading", text:"After your first win, did your behavior change? Describe it. What is your post-win routine to prevent overtrading?" },
  { id:"pe_4", quad:"PE", title:"Confidence vs reality", text:"Where did you feel 'sure' today and what was the evidence? Define the proof you require before calling a setup high confidence." },
  { id:"pe_5", quad:"PE", title:"Clean day challenge", text:"Tomorrow you're only allowed A/B-grade trades. What do you refuse to do even if it 'works' again?" },

  { id:"pd_1", quad:"PD", title:"Keep it boring", text:"Describe your best trade. Why was it boring? Identify the 2–3 conditions that made it high quality so you can repeat it." },
  { id:"pd_2", quad:"PD", title:"Scale the process", text:"What part of today is worth scaling (size, frequency, markets) and what guardrail prevents you from rushing it?" },
  { id:"pd_3", quad:"PD", title:"Rule reinforcement", text:"Which rule protected you the most today? How can you make it more automatic (checklist order, hard lock, pre-commitment)?" },
  { id:"pd_4", quad:"PD", title:"Remove the weakest trade", text:"If you took multiple trades, which one was lowest quality and why did you still take it? Remove that permission tomorrow." },
  { id:"pd_5", quad:"PD", title:"One focus for tomorrow", text:"Pick one thing to focus on tomorrow to stay disciplined (patience, confirmation, risk). Make it binary and measurable." }
];

function dayTrades(dateIso){
  return state.trades.filter(t => (t.date || "") === dateIso);
}

function computeEmotionScore(dateIso){
  const trades = dayTrades(dateIso);
  const reviewed = trades.filter(t => t.postReview && Array.isArray(t.postReview.mistakes));
  if(!reviewed.length) return { emoPct:0, emoCount:0, reviewedCount:0, topEmo:null };

  const emoCounts = {};
  let emoCount = 0;

  reviewed.forEach(t=>{
    const ms = t.postReview.mistakes || [];
    let emoThis = false;
    ms.forEach(m=>{
      if(!m || m==="None") return;
      if(EMO_MISTAKES.has(m)){
        emoThis = true;
        emoCounts[m] = (emoCounts[m] || 0) + 1;
      }
    });
    if(emoThis) emoCount++;
  });

  const emoPct = Math.round((emoCount / reviewed.length) * 100);
  const topEmo = Object.entries(emoCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
  return { emoPct, emoCount, reviewedCount: reviewed.length, topEmo };
}

function computeDailySignals(dateIso){
  const trades = dayTrades(dateIso);
  const reviewed = trades.filter(t => t.postReview && Number.isFinite(Number(t.postReview.realizedR)));
  const tradeCount = trades.length;
  const reviewRate = tradeCount ? Math.round((reviewed.length / tradeCount) * 100) : 0;

  const avgR = reviewed.length ? (reviewed.reduce((a,t)=>a+(Number(t.postReview.realizedR)||0),0) / reviewed.length) : 0;
  const wins = reviewed.filter(t => t.postReview.result === "win").length;
  const winRate = reviewed.length ? Math.round((wins / reviewed.length) * 100) : 0;

  const gradeCounts = { A:0, B:0, C:0 };
  trades.forEach(t=>{
    const s = (t.post?.weightedPct ?? t.pre?.weightedPct ?? 0);
    gradeCounts[gradeFromPct(s)]++;
  });

  const emo = computeEmotionScore(dateIso);

  const profitable = reviewed.length ? (avgR > 0) : false;
  const emotional = (emo.emoPct >= 34) || (tradeCount > 0 && reviewRate < 100);

  const quadrant = profitable
    ? (emotional ? "PE" : "PD")
    : (emotional ? "UE" : "UD");

  return {
    dateIso,
    tradeCount,
    reviewedCount: reviewed.length,
    reviewRate,
    avgR,
    winRate,
    gradeCounts,
    emoPct: emo.emoPct,
    topEmo: emo.topEmo,
    quadrant
  };
}

function quadrantLabel(q){
  return q==="PD" ? "Profitable + Disciplined"
    : q==="PE" ? "Profitable + Emotional"
    : q==="UD" ? "Unprofitable + Disciplined"
    : "Unprofitable + Emotional";
}

function summarizeSignals(sig){
  if(sig.tradeCount === 0) return "No trades logged. Either you were disciplined, or you forgot to log. Only one of those is flattering.";
  const parts = [];
  parts.push(`${sig.tradeCount} trade${sig.tradeCount===1?"":"s"} logged.`);
  parts.push(`Quadrant: ${quadrantLabel(sig.quadrant)}.`);
  if(sig.reviewedCount) parts.push(`Win rate ${sig.winRate}%, avg R ${sig.avgR.toFixed(2)}.`);
  parts.push(`Reviews done: ${sig.reviewRate}%. Emotion rate: ${sig.emoPct}%.`);
  parts.push(`Grades A/B/C: ${sig.gradeCounts.A}/${sig.gradeCounts.B}/${sig.gradeCounts.C}.`);
  if(sig.topEmo) parts.push(`Top emotional trigger: ${sig.topEmo}.`);
  return parts.join(" ");
}

function promptScore(p, sig){
  let s = 0;
  if(p.quad === sig.quadrant) s += 10;

  if(sig.topEmo === "Revenge trade" && (p.id === "ue_1" || p.id === "ue_2" || p.id === "pe_1")) s += 3;
  if(sig.topEmo === "FOMO" && (p.id === "ue_2" || p.id === "ue_3" || p.id === "pe_5")) s += 3;
  if(sig.topEmo === "Overrisked" && (p.id === "ue_3" || p.id === "ue_4" || p.id === "pe_1")) s += 3;

  const reviewGap = sig.tradeCount > 0 && sig.reviewRate < 100;
  if(reviewGap && p.id === "ue_5") s += 6;

  const seed = Number((sig.dateIso || "").split("-").join("")) || 0;
  const jitter = (seed % 9) * 0.08;
  return s + jitter;
}

function selectDailyPrompt(sig){
  const scored = promptLibrary.map(p => ({...p, _s: promptScore(p, sig)})).sort((a,b)=>b._s-a._s);
  const q = scored.find(p => p.quad === sig.quadrant);
  return q || scored[0];
}

function getJournal(dateIso){
  return (state.journals || []).find(j => j.date === dateIso) || null;
}

function upsertJournal(dateIso, sig, promptIds, responses){
  state.journals = state.journals || [];
  const existing = getJournal(dateIso);
  const entry = {
    date: dateIso,
    createdAt: existing?.createdAt || Date.now(),
    updatedAt: Date.now(),
    signals: sig,
    promptIds,
    responses
  };
  state.journals = [entry, ...state.journals.filter(j=>j.date!==dateIso)];
  saveStateSmart(state);
}

let dailyPromptSet = [];

function renderDailyPrompts(dateIso, forceNew=false){
  const sig = computeDailySignals(dateIso);
  const existing = getJournal(dateIso);

  if(existing && !forceNew){
    dailyPromptSet = existing.promptIds.map(id => promptLibrary.find(p=>p.id===id)).filter(Boolean);
  } else {
    dailyPromptSet = [ selectDailyPrompt(sig) ];
  }

  const respMap = (existing && !forceNew) ? (existing.responses || {}) : {};

  dailyPrompts.innerHTML = dailyPromptSet.map((p, idx)=>`
    <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="font-medium">${escapeHtml(p.title)}</div>
        <div class="text-xs text-gray-500">Prompt ${idx+1}/${dailyPromptSet.length}</div>
      </div>
      <div class="text-sm text-gray-300 mt-2">${escapeHtml(p.text)}</div>
      <textarea data-pid="${escapeAttr(p.id)}" rows="3" class="mt-3 w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="Write it straight...">${escapeHtml(respMap[p.id] || "")}</textarea>
    </div>
  `).join("");

  dailyTrades.textContent = String(sig.tradeCount);
  dailyAvgR.textContent = sig.avgR.toFixed(2);
  dailyWinRate.textContent = `${sig.winRate}%`;
  dailyReviewRate.textContent = `${sig.reviewRate}%`;
  dailySummary.textContent = summarizeSignals(sig);
}

function openDailyModal(){
  if(!currentUser) return;
  setDailyMessage("");
  const d = todayISO();
  dailyDate.value = d;
  renderDailyPrompts(d, false);
  modalDaily.classList.remove("hidden");
  modalDaily.classList.add("flex");
}

function closeDailyModal(){
  modalDaily.classList.add("hidden");
  modalDaily.classList.remove("flex");
}

if(dailyReviewBtn) dailyReviewBtn.addEventListener("click", openDailyModal);
if(dailyClose) dailyClose.addEventListener("click", closeDailyModal);
if(dailyCancel) dailyCancel.addEventListener("click", closeDailyModal);

if(dailyDate){
  dailyDate.addEventListener("change", () => {
    setDailyMessage("");
    renderDailyPrompts(dailyDate.value || todayISO(), false);
  });
}

if(dailyRegenerate){
  dailyRegenerate.addEventListener("click", () => {
    setDailyMessage("");
    renderDailyPrompts(dailyDate.value || todayISO(), true);
  });
}

if(dailySave){
  dailySave.addEventListener("click", () => {
    setDailyMessage("");
    const dateIso = dailyDate.value || todayISO();
    const sig = computeDailySignals(dateIso);

    const responses = {};
    const boxes = Array.from(dailyPrompts.querySelectorAll("textarea[data-pid]"));
    boxes.forEach(t=>{
      const pid = t.getAttribute("data-pid");
      responses[pid] = (t.value || "").trim();
    });

    const answered = Object.values(responses).filter(v=>v.length>0).length;
    if(answered === 0){
      setDailyMessage("Write at least one answer before saving.");
      return;
    }

    const promptIds = dailyPromptSet.map(p=>p.id);
    upsertJournal(dateIso, sig, promptIds, responses);
    closeDailyModal();
    alert("Daily review saved.");
  });
}

// Journal
function formatDatePretty(iso){
  try{
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(Date.UTC(y,m-1,d,12,0,0));
    return new Intl.DateTimeFormat("en-US", { timeZone:"America/New_York", weekday:"short", month:"short", day:"numeric", year:"numeric" }).format(dt);
  }catch(e){ return iso; }
}

function journalEntries(){
  return (state.journals || []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
}

function journalEntryLabel(j){
  const q = j.signals?.quadrant ? quadrantLabel(j.signals.quadrant) : "—";
  const avgR = (j.signals && Number.isFinite(Number(j.signals.avgR))) ? Number(j.signals.avgR).toFixed(2) : "—";
  return `${q} • Avg R ${avgR}`;
}

function upsertFreeWrite(dateIso, text){
  state.freeWrites = state.freeWrites || [];
  const entry = { id: String(Date.now()), type:"free", date: dateIso, createdAt: Date.now(), text: text.trim() };
  state.freeWrites = [entry, ...state.freeWrites];
  saveStateSmart(state);
}

if(freeWriteSave){
  freeWriteSave.addEventListener("click", ()=>{
    if(!currentUser) return;
    const t = (freeWriteText?.value || "").trim();
    if(!t) return;
    upsertFreeWrite(todayISO(), t);
    if(freeWriteText) freeWriteText.value = "";
    renderJournalList();
    alert("Free write saved.");
  });
}

function journalEntriesAll(){
  const a = journalEntries();
  const b = (state.freeWrites || []).map(x=>({ ...x, type:"free" }));
  return [...a.map(x=>({ ...x, type:"review" })), ...b].sort((x,y)=> (y.date||"").localeCompare(x.date||"") || (y.createdAt||0)-(x.createdAt||0));
}

function openJournalModal(){
  if(!currentUser) return;
  renderJournalList();
  modalJournal.classList.remove("hidden");
  modalJournal.classList.add("flex");
}

function closeJournalModal(){
  modalJournal.classList.add("hidden");
  modalJournal.classList.remove("flex");
}

function renderJournalList(selectedKey){
  const entries = journalEntriesAll();
  if(!journalList) return;

  if(entries.length === 0){
    journalList.innerHTML = `<div class="p-4 text-sm text-gray-400">No journal entries yet. Do a Daily Review or add a free write.</div>`;
    if(journalDetail) journalDetail.innerHTML = `<div class="text-sm text-gray-400">No entries to show.</div>`;
    return;
  }

  const keyOf = (e)=> e.type==="review" ? `review:${e.date}` : `free:${e.id}`;
  const current = selectedKey || keyOf(entries[0]);

  journalList.innerHTML = entries.map(e=>{
    const key = keyOf(e);
    const active = key === current;
    const label = e.type==="review" ? journalEntryLabel(e) : "Free write";
    return `
      <button data-jkey="${escapeAttr(key)}" class="w-full text-left px-4 py-3 ${active ? "bg-gray-950" : "bg-gray-900 hover:bg-gray-950"}">
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-medium">${escapeHtml(formatDatePretty(e.date))}</div>
          <div class="text-[10px] px-2 py-0.5 rounded-full border border-gray-700 text-gray-400">${e.type==="review" ? "Review" : "Free"}</div>
        </div>
        <div class="text-xs text-gray-500 mt-1">${escapeHtml(label)}</div>
      </button>
    `;
  }).join("");

  function renderKey(key){
    const [typ, val] = key.split(":");
    if(typ==="review") return renderJournalDetail(val);
    const fw = (state.freeWrites || []).find(x=>String(x.id)===String(val));
    if(!fw || !journalDetail) return;
    journalDetail.innerHTML = `
      <div class="text-xs text-gray-500">Free write</div>
      <div class="text-lg font-semibold mb-3">${escapeHtml(formatDatePretty(fw.date))}</div>
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
        <div class="text-sm text-gray-200 whitespace-pre-wrap">${escapeHtml(fw.text || "—")}</div>
      </div>
    `;
  }

  renderKey(current);

  Array.from(journalList.querySelectorAll("button[data-jkey]")).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = btn.getAttribute("data-jkey");
      renderJournalList(k);
    });
  });
}

function renderJournalDetail(dateIso){
  const j = getJournal(dateIso);
  if(!j || !journalDetail) return;

  const promptId = (j.promptIds && j.promptIds[0]) ? j.promptIds[0] : null;
  const prompt = promptId ? promptLibrary.find(p=>p.id===promptId) : null;
  const answer = promptId ? (j.responses?.[promptId] || "") : "";

  const sig = j.signals || {};
  journalDetail.innerHTML = `
    <div class="text-xs text-gray-500">Date</div>
    <div class="text-lg font-semibold mb-3">${escapeHtml(formatDatePretty(j.date))}</div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-3"><div class="text-xs text-gray-400">Quadrant</div><div class="text-sm font-semibold mt-1">${escapeHtml(sig.quadrant || "—")}</div><div class="text-xs text-gray-500">${escapeHtml(sig.quadrant ? quadrantLabel(sig.quadrant) : "—")}</div></div>
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-3"><div class="text-xs text-gray-400">Trades</div><div class="text-sm font-semibold mt-1">${escapeHtml(String(sig.tradeCount ?? "—"))}</div></div>
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-3"><div class="text-xs text-gray-400">Avg R</div><div class="text-sm font-semibold mt-1">${escapeHtml(Number.isFinite(Number(sig.avgR)) ? Number(sig.avgR).toFixed(2) : "—")}</div></div>
      <div class="rounded-xl bg-gray-950 border border-gray-800 p-3"><div class="text-xs text-gray-400">Emotion rate</div><div class="text-sm font-semibold mt-1">${escapeHtml(sig.emoPct!=null ? (sig.emoPct + "%") : "—")}</div></div>
    </div>

    <div class="rounded-xl bg-gray-950 border border-gray-800 p-4">
      <div class="text-xs text-gray-400">Daily prompt</div>
      <div class="text-sm text-gray-200 mt-2 font-medium">${escapeHtml(prompt ? prompt.title : "—")}</div>
      <div class="text-sm text-gray-300 mt-2">${escapeHtml(prompt ? prompt.text : "—")}</div>
    </div>

    <div class="rounded-xl bg-gray-950 border border-gray-800 p-4 mt-4">
      <div class="text-xs text-gray-400">Your answer</div>
      <div class="text-sm text-gray-200 mt-2 whitespace-pre-wrap">${escapeHtml(answer || "—")}</div>
    </div>
  `;
}

if(journalBtn) journalBtn.addEventListener("click", openJournalModal);
if(journalClose) journalClose.addEventListener("click", closeJournalModal);
if(journalDone) journalDone.addEventListener("click", closeJournalModal);

if(journalExport){
  journalExport.addEventListener("click", ()=>{
    const data = JSON.stringify({ journals: journalEntries() }, null, 2);
    const blob = new Blob([data], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "tradecheck_journal_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
}

// Hero / greeting / market open countdown
function nyNow(){
  const parts = new Intl.DateTimeFormat("en-US", { timeZone:"America/New_York", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false }).formatToParts(new Date());
  const get = (t)=>parts.find(p=>p.type===t)?.value;
  return { y:+get("year"), mo:+get("month"), d:+get("day"), h:+get("hour"), mi:+get("minute"), s:+get("second") };
}

function nextMarketOpenParts(){
  const now = new Date();
  for(let i=0;i<8;i++){
    const tryDate = new Date(now.getTime() + i*24*3600*1000);
    const p = new Intl.DateTimeFormat("en-US", { timeZone:"America/New_York", weekday:"short", year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(tryDate);
    const wd = p.find(x=>x.type==="weekday")?.value || "";
    const y = +p.find(x=>x.type==="year")?.value;
    const mo = +p.find(x=>x.type==="month")?.value;
    const d = +p.find(x=>x.type==="day")?.value;
    if(wd==="Sat" || wd==="Sun") continue;

    if(i===0){
      const n = nyNow();
      const afterOpen = (n.h > 9) || (n.h === 9 && n.mi >= 30);
      if(!afterOpen) return { y, mo, d, h:9, mi:30 };
    } else return { y, mo, d, h:9, mi:30 };
  }
  const n = nyNow();
  return { y:n.y, mo:n.mo, d:n.d, h:9, mi:30 };
}

function countdownText(target){
  const n = nyNow();
  const nowMs = Date.UTC(n.y, n.mo-1, n.d, n.h, n.mi, n.s);
  const tgtMs = Date.UTC(target.y, target.mo-1, target.d, target.h, target.mi, 0);
  let diff = tgtMs - nowMs; 
  if(diff < 0) diff = 0;
  const sec = Math.floor(diff/1000);
  const hh = Math.floor(sec/3600);
  const mm = Math.floor((sec%3600)/60);
  const ss = sec%60;
  return { diff, text:`${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}` };
}

let heroTimer = null;

function updateHero(){
  if(!greetingLine) return;
  const hr = nyNow().h;
  const greet = hr < 12 ? "Good morning" : (hr < 18 ? "Good afternoon" : "Good evening");
  greetingLine.textContent = `${greet}${currentUser ? ", " + currentUser : ""}`;

  const target = nextMarketOpenParts();
  const iso = `${target.y}-${String(target.mo).padStart(2,"0")}-${String(target.d).padStart(2,"0")}`;
  const pretty = formatDatePretty(iso);
  if(marketOpenLine) marketOpenLine.textContent = `9:30 AM ET • ${pretty}`;

  const cd = countdownText(target);
  if(marketCountdown) marketCountdown.textContent = cd.diff===0 ? "Market is open (or you missed it)." : `Opens in ${cd.text}`;

  const today = todayISO();
  const j = getJournal(today);
  if(todayFocusLine){
    if(j && j.promptIds && j.promptIds[0]){
      const p = promptLibrary.find(x=>x.id===j.promptIds[0]);
      todayFocusLine.textContent = p ? p.title : "Daily Review saved.";
    } else todayFocusLine.textContent = "Do your Daily Review. One prompt. One answer.";
  }
}

function startHeroTimer(){
  if(heroTimer) clearInterval(heroTimer);
  heroTimer = setInterval(updateHero, 1000);
  updateHero();
}

const QUOTES = [
  "Discipline is a profit multiplier.",
  "One good trade beats five emotional ones.",
  "The market pays patience, not opinions.",
  "Your job is execution. The market handles results.",
  "If it's not A-grade, it's a donation.",
  "Size comes after consistency, not before.",
  "Boredom is usually the edge.",
  "Plan the trade. Trade the plan. Shocking, I know.",
  "Protect your mind like you protect your account.",
  "Small losses are tuition. Big losses are arrogance."
];

function dailyQuote(dateIso){
  const seed = Number((dateIso || "").split("-").join("")) || 1;
  return QUOTES[seed % QUOTES.length];
}

// Quick add trade
function addQuickTrade(){
  const sym = (qSymbol?.value || "").trim().toUpperCase();
  const strat = (qStrategy?.value || "").trim();
  const dir = (qDir?.value || "Long").trim();
  const r = Number(qR?.value);
  
  if(!sym || !strat || !Number.isFinite(r)){
    alert("Symbol, strategy, and Realized R are required.");
    return;
  }

  const emo = (qEmotion?.value || "").trim();
  const mistakes = emo ? [emo] : [];
  const result = r > 0 ? "win" : (r < 0 ? "loss" : "breakeven");

  const strategy = state.strategies.find(s => String(s.id) === String(strat));
  if(!strategy){
    alert("Strategy not found.");
    return;
  }

  const trade = {
    id: Date.now(),
    strategyId: Number(strat),
    date: todayISO(),
    createdAt: Date.now(),
    symbol: sym,
    session: "NY",
    direction: dir,
    pre: { checks: [], weightedPct: 0 },
    post: { weightedPct: 0 },
    postReview: {
      realizedR: r,
      result,
      mistakes,
      notes: (qNote?.value || "").trim(),
      exitReason: "Manual exit",
      lesson: "Quick add trade",
      completedAt: Date.now()
    }
  };

  state.trades.unshift(trade);
  saveStateSmart(state);

  if(qSymbol) qSymbol.value = "";
  if(qR) qR.value = "";
  if(qEmotion) qEmotion.value = "";
  if(qNote) qNote.value = "";

  renderAll();
}

if(quickTradeForm){
  quickTradeForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    addQuickTrade();
  });
}

// Weekly stats
function isoToNum(iso){ return Number((iso||"").split("-").join("")); }

function computeReviewStreak(){
  const today = todayISO();
  const set = new Set((state.journals || []).map(j=>j.date));
  let streak = 0;

  let [y,m,d] = today.split("-").map(Number);
  let dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));

  while(true){
    const iso = new Intl.DateTimeFormat("en-CA", { timeZone:"America/New_York", year:"numeric", month:"2-digit", day:"2-digit" }).format(dt);
    if(!set.has(iso)) break;
    streak++;
    dt = new Date(dt.getTime() - 24*3600*1000);
  }
  return streak;
}

function computeDisciplinedStreak(){
  const today = todayISO();
  const map = new Map((state.journals || []).map(j=>[j.date, j.signals?.quadrant || null]));
  let streak = 0;

  let [y,m,d] = today.split("-").map(Number);
  let dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  while(true){
    const iso = new Intl.DateTimeFormat("en-CA", { timeZone:"America/New_York", year:"numeric", month:"2-digit", day:"2-digit" }).format(dt);
    if(map.get(iso) !== "PD") break;
    streak++;
    dt = new Date(dt.getTime() - 24*3600*1000);
  }
  return streak;
}

function weekStartISO(iso){
  const [y,m,d] = iso.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  const wd = new Intl.DateTimeFormat("en-US", { timeZone:"America/New_York", weekday:"short" }).format(dt);
  const order = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
  const back = order[wd] ?? 0;
  const start = new Date(dt.getTime() - back*24*3600*1000);
  return new Intl.DateTimeFormat("en-CA", { timeZone:"America/New_York", year:"numeric", month:"2-digit", day:"2-digit" }).format(start);
}

function addDaysISO(iso, n){
  const [y,m,d] = iso.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  const out = new Date(dt.getTime() + n*24*3600*1000);
  return new Intl.DateTimeFormat("en-CA", { timeZone:"America/New_York", year:"numeric", month:"2-digit", day:"2-digit" }).format(out);
}

function weekRange(weekStart){
  const end = addDaysISO(weekStart, 6);
  return { start: weekStart, end };
}

function tradesInRange(startIso, endIso){
  const a = isoToNum(startIso), b = isoToNum(endIso);
  return (state.trades || []).filter(t=>{
    const n = isoToNum(t.date);
    return n>=a && n<=b;
  });
}

function reviewedTrades(trades){
  return trades.filter(t => t.postReview && Number.isFinite(Number(t.postReview.realizedR)));
}

function weeklyStats(startIso){
  const { start, end } = weekRange(startIso);
  const trades = tradesInRange(start, end);
  const rev = reviewedTrades(trades);
  const rs = rev.map(t=>Number(t.postReview.realizedR)||0);
  const sumR = rs.reduce((a,x)=>a+x,0);
  const avgR = rs.length ? sumR/rs.length : 0;
  const wins = rev.filter(t=>t.postReview.result==="win").length;
  const winRate = rev.length ? Math.round((wins/rev.length)*100) : 0;

  const emoCounts = {};
  rev.forEach(t=>{
    (t.postReview.mistakes||[]).forEach(m=>{
      if(!m || m==="None") return;
      emoCounts[m]=(emoCounts[m]||0)+1;
    });
  });
  const topMistake = Object.entries(emoCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";

  const stratCounts = {};
  trades.forEach(t=>{
    const strat = state.strategies.find(s=>s.id===t.strategyId);
    const name = strat?.name || "Unknown";
    stratCounts[name]=(stratCounts[name]||0)+1;
  });
  const topStrat = Object.entries(stratCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";

  return { start, end, trades, rev, sumR, avgR, winRate, topMistake, topStrat };
}

function buildWeekSelect(){
  if(!weekSelect) return;
  const today = todayISO();
  const thisStart = weekStartISO(today);
  const options = [];
  for(let i=0;i<8;i++){
    const s = addDaysISO(thisStart, -7*i);
    const r = weekRange(s);
    options.push({ value:s, label:`${r.start} → ${r.end}` });
  }
  weekSelect.innerHTML = options.map(o=>`<option value="${escapeAttr(o.value)}">${escapeHtml(o.label)}</option>`).join("");
}

let rChart = null;

function renderRChart(startIso, endIso){
  if(!rChartCanvas || typeof Chart === "undefined") return;
  const trades = tradesInRange(startIso, endIso).slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  let cum = 0;
  const labels = [];
  const data = [];

  trades.forEach(t=>{
    const r = Number(t.postReview?.realizedR);
    if(!Number.isFinite(r)) return;
    cum += r;
    labels.push(`${t.date} ${t.symbol || ""}`.trim());
    data.push(Number(cum.toFixed(2)));
  });

  if(rChart) rChart.destroy();
  rChart = new Chart(rChartCanvas.getContext("2d"), {
    type: "line",
    data: { labels, datasets: [{ label:"Cumulative R", data, tension:0.25 }] },
    options: {
      responsive: true,
      plugins: { legend: { display:false } },
      scales: {
        x: { display:false },
        y: { ticks: { callback:(v)=>v } }
      }
    }
  });
}

function renderWeekly(startIso){
  const w = weeklyStats(startIso);
  if(weekAvgR) weekAvgR.textContent = w.rev.length ? w.avgR.toFixed(2) : "—";
  if(weekMini) weekMini.textContent = `${w.rev.length} reviewed • ${w.winRate}% win • Top strat: ${w.topStrat}`;
  if(weeklySummary){
    weeklySummary.textContent = w.trades.length
      ? `Trades: ${w.trades.length}. Reviewed: ${w.rev.length}. Sum R: ${w.sumR.toFixed(2)}. Avg R: ${w.rev.length ? w.avgR.toFixed(2) : "—"}. Win rate: ${w.winRate}%. Top mistake: ${w.topMistake}.`
      : "No trades logged this week. Either you were disciplined… or you were asleep. Both are acceptable.";
  }
  renderRChart(w.start, w.end);
}

function renderStreaks(){
  if(streakReview) streakReview.textContent = String(computeReviewStreak());
  if(streakDisciplined) streakDisciplined.textContent = String(computeDisciplinedStreak());
}

if(weekSelect){
  weekSelect.addEventListener("change", ()=> renderWeekly(weekSelect.value));
}

function renderAll(scrollTop=true) {
  syncFiltersAndSelects();
  renderLocks();
  renderStrategies();
  renderStatsAndCharts();
  renderTrades();
  renderDrift();
  
  buildWeekSelect();
  if(weekSelect && weekSelect.value) renderWeekly(weekSelect.value);
  renderStreaks();
  startHeroTimer();
  
  if(quoteLine) quoteLine.textContent = dailyQuote(todayISO());
  
  if (scrollTop) {
    tDate.value = tDate.value || todayISO();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// Supabase boot
async function bootSupabase(){
  try{
    const { data } = await sb.auth.getSession();
    const session = data.session;
    
    if(!session){
      show(authGate);
      hide(onboardingGate);
      return;
    }
    
    hide(authGate);
    currentUserId = session.user.id;
    currentEmail = session.user.email || "";

    const { data: prof } = await sb.from("profiles").select("username").eq("id", currentUserId).maybeSingle();
    currentUsername = prof?.username || "";
    currentUser = currentUsername || (currentEmail ? currentEmail.split("@")[0] : "Trader");

    let remote = null;
    try { remote = await loadStateRemote(); } catch(e){ 
      console.warn("Failed to load remote state:", e);
      remote = null; 
    }

    if(remote){
      state = Object.assign(structuredClone(defaultState), remote);
      saveState(state);
    } else {
      state = loadState();
      try { await saveStateRemote(state); } catch(e){ 
        console.warn("Failed initial remote save:", e);
      }
    }

    const isNew = localStorage.getItem("tc_new_user_flag_v1") === "1";
    if (isNew || (state.strategies?.length || 0) === 0){
      initOnboardingRules();
      show(onboardingGate);
    } else {
      hide(onboardingGate);
      renderAll();
    }

  } catch(e){
    console.error("Boot error:", e);
    setAuthMessage("Setup error: " + e.message);
    show(authGate);
  }
}

// Auth event listeners
if(loginBtn){
  loginBtn.addEventListener("click", async ()=>{
    try{
      const email = (authEmail.value||"").trim();
      const pass = authPass.value||"";
      setAuthMessage("");
      if(!email.includes("@") || pass.length < 6){ 
        setAuthMessage("Email + 6+ char password required."); 
        return; 
      }
      await sbLogin(email, pass);
      location.reload();
    } catch(e){
      setAuthMessage(e.message || String(e));
    }
  });
}

if(signupBtn){
  signupBtn.addEventListener("click", async ()=>{
    try{
      const email = (authEmail.value||"").trim();
      const pass = authPass.value||"";
      setAuthMessage("");
      if(!email.includes("@") || pass.length < 6){ 
        setAuthMessage("Email + 6+ char password required."); 
        return; 
      }
      const data = await sbSignUp(email, pass);
      if(!data.session){ 
        setAuthMessage("Check your email to confirm, then log in."); 
        return; 
      }
      const uname = email.split("@")[0].slice(0,24);
      await sb.from("profiles").upsert({ id: data.user.id, username: uname });
      localStorage.setItem("tc_new_user_flag_v1", "1");
      location.reload();
    } catch(e){
      setAuthMessage(e.message || String(e));
    }
  });
}

if(logoutBtn){
  logoutBtn.addEventListener("click", async ()=>{
    try{ await sbLogout(); location.reload(); } catch(e){ console.warn(e); }
  });
}

if(onboardLogout){
  onboardLogout.addEventListener("click", async ()=>{
    try{ await sbLogout(); location.reload(); } catch(e){ console.warn(e); }
  });
}

// Boot on load
document.addEventListener("DOMContentLoaded", bootSupabase);
</script>
</body>
</html>
