<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradeCheck | Discipline + Post-Trade Review</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
    }
    
    .card { 
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 48px rgba(0,0,0,0.2);
    }
    
    .chip { 
      border: 1px solid rgba(255,255,255,0.10);
      transition: all 0.2s;
    }
    
    .chip:hover {
      transform: scale(1.05);
    }
    
    .disabled { opacity: 0.55; cursor: not-allowed; }
    
    /* Gradient backgrounds */
    .gradient-green {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.1) 100%);
    }
    
    .gradient-red {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%);
    }
    
    .gradient-blue {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
    }
    
    .gradient-amber {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
    }

    /* Glass morphism */
    .glass {
      background: rgba(17, 25, 40, 0.75);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.125);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      body { padding-bottom: 80px; }
      
      .mobile-nav { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        z-index: 50;
        background: rgba(3, 7, 18, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(59, 130, 246, 0.2);
        padding: 0.5rem;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
      }
      
      .desktop-nav { display: none; }
      
      .mobile-nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        font-size: 0.7rem;
        font-weight: 500;
        color: rgb(156, 163, 175);
        transition: all 0.2s;
        min-width: 64px;
      }
      
      .mobile-nav-btn.active {
        color: rgb(96, 165, 250);
        background: rgba(59, 130, 246, 0.15);
      }
      
      .mobile-nav-icon {
        width: 22px;
        height: 22px;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-nav { display: none; }
    }

    /* Goal progress animations */
    .goal-progress {
      height: 12px;
      border-radius: 9999px;
      background: rgba(31, 41, 55, 1);
      overflow: hidden;
      position: relative;
    }
    
    .goal-progress-bar {
      height: 100%;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(90deg, rgb(59, 130, 246), rgb(16, 185, 129));
      position: relative;
      overflow: hidden;
    }
    
    .goal-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Achievement badge pop animation */
    @keyframes pop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .achievement-badge {
      animation: pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* Risk meter */
    .risk-meter {
      height: 14px;
      border-radius: 9999px;
      background: rgba(31, 41, 55, 1);
      overflow: hidden;
      position: relative;
    }
    
    .risk-meter-fill {
      height: 100%;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .risk-low { 
      background: linear-gradient(90deg, rgb(16, 185, 129), rgb(5, 150, 105));
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .risk-medium { 
      background: linear-gradient(90deg, rgb(251, 191, 36), rgb(245, 158, 11));
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    
    .risk-high { 
      background: linear-gradient(90deg, rgb(239, 68, 68), rgb(220, 38, 38));
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Trade card colors */
    .trade-card-win {
      border-left: 4px solid rgb(16, 185, 129);
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent);
    }
    
    .trade-card-loss {
      border-left: 4px solid rgb(239, 68, 68);
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.05), transparent);
    }
    
    .trade-card-pending {
      border-left: 4px solid rgb(107, 114, 128);
      background: linear-gradient(90deg, rgba(107, 114, 128, 0.05), transparent);
    }

    /* Smooth modal transitions */
    .modal-enter {
      animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Button hover effects */
    .btn-primary {
      background: linear-gradient(135deg, rgb(59, 130, 246), rgb(37, 99, 235));
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }

    /* Stat number emphasis */
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Streak fire effect */
    .streak-fire {
      display: inline-block;
      animation: flicker 1.5s infinite;
    }
    
    @keyframes flicker {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#030712">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TradeCheck">
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
  <!-- AUTH GATE -->
  <div id="authGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="w-full max-w-sm rounded-3xl glass p-8 modal-enter">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center font-bold text-xl shadow-lg">TC</div>
        <div>
          <div class="font-bold text-lg leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Sign in to continue</div>
        </div>
      </div>

      <div class="space-y-3">
        <input id="authEmail" type="email" class="w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Email" autocomplete="email">
        <input id="authPass" type="password" class="w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Password (6+ chars)" autocomplete="current-password">
      </div>

      <button id="loginBtn" class="mt-4 w-full px-4 py-3 rounded-xl btn-primary text-sm font-semibold">Login</button>
      <button id="signupBtn" class="mt-3 w-full px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Sign up</button>

      <div id="authMsg" class="text-xs text-red-300 mt-3 text-center"></div>
    </div>
  </div>

  <!-- ONBOARDING GATE -->
  <div id="onboardingGate" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 p-4">
    <div class="w-full max-w-2xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-bold">Create your first strategy</div>
          <div class="text-sm text-gray-400 mt-1">No strategies, no trades. Build the rules first.</div>
        </div>
        <button id="onboardLogout" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Logout</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <div>
          <label class="text-xs text-gray-400 font-medium">Strategy name</label>
          <input id="obName" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="e.g., NY ORB Reversal">
        </div>
        <div>
          <label class="text-xs text-gray-400 font-medium">Timeframe</label>
          <select id="obTF" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
            <option value="">Select</option>
            <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
          </select>
        </div>
      </div>

      <div class="mt-6">
        <label class="text-xs text-gray-400 font-medium">Checklist rules</label>
        <div id="obRulesList" class="mt-3 space-y-2"></div>
        <button type="button" id="obAddRuleBtn" class="mt-3 w-full px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">
          + Add rule
        </button>
        <div class="text-xs text-gray-500 mt-2">Each rule has a weight (Core=3, Confluence=2, Filter=1).</div>
      </div>

      <div class="mt-6">
        <button id="finishOnboardingBtn" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">Create strategy & continue</button>
      </div>

      <div id="obMsg" class="text-xs text-red-300 mt-3 text-center"></div>
    </div>
  </div>

  <!-- Desktop Header -->
  <header class="desktop-nav sticky top-0 z-10 glass border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center font-bold shadow-lg">TC</div>
        <div>
          <div class="font-bold leading-tight">TradeCheck</div>
          <div class="text-xs text-gray-400">Discipline + Post-Trade Review</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="goalsBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">üéØ Goals</button>
        <button id="dailyReviewBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold">Daily Review</button>
        <button id="analyticsBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">üìà Analytics</button>
        <button id="journalBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">üìî Journal</button>
        <button id="exportBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">üíæ Export</button>
        <button id="settingsBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">‚öôÔ∏è</button>
        <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Logout</button>
      </div>
    </div>
  </header>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav">
    <button class="mobile-nav-btn active" data-view="dashboard">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/>
      </svg>
      <span>Home</span>
    </button>
    <button class="mobile-nav-btn" data-view="trades">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-7-8h8M7 4h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2z"/>
      </svg>
      <span>Trades</span>
    </button>
    <button class="mobile-nav-btn" data-view="goals">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a8 8 0 110 16 8 8 0 010-16zm0 6l3 3"/>
      </svg>
      <span>Goals</span>
    </button>
    <button class="mobile-nav-btn" data-view="review">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8M8 11h8M8 15h5M6 3h9l3 3v15a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2z"/>
      </svg>
      <span>Review</span>
    </button>
    <button class="mobile-nav-btn" data-view="analytics">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19h16M7 16V8m5 8V4m5 12v-6"/>
      </svg>
      <span>Stats</span>
    </button>
    <button class="mobile-nav-btn" data-view="settings">
      <svg class="mobile-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 15a7.9 7.9 0 00.1-1 7.9 7.9 0 00-.1-1l2-1.5-2-3.5-2.4 1a7.3 7.3 0 00-1.7-1L14.9 3h-4l-.4 2.5a7.3 7.3 0 00-1.7 1L6.4 5.5l-2 3.5 2 1.5a7.9 7.9 0 000 2l-2 1.5 2 3.5 2.4-1a7.3 7.3 0 001.7 1L10.9 21h4l.4-2.5a7.3 7.3 0 001.7-1l2.4 1 2-3.5-2-1.5z"/>
      </svg>
      <span>Settings</span>
    </button>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- Risk Dashboard Alert -->
    <div id="riskAlert" class="hidden rounded-2xl border px-6 py-4"></div>

    <!-- Hero Section -->
    <section class="rounded-3xl border border-gray-800 glass p-8">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div>
          <div id="greetingLine" class="text-3xl font-bold">Good morning</div>
          <div id="subGreeting" class="text-sm text-gray-400 mt-2">Trade your plan, not your feelings.</div>
          <div id="quoteLine" class="text-sm text-blue-400 mt-3 italic font-medium">‚Äî</div>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="rounded-2xl border border-gray-800 gradient-blue p-5 min-w-[240px]">
            <div class="text-xs text-gray-400 font-medium">Market open</div>
            <div id="marketOpenLine" class="text-xl font-bold mt-1">‚Äî</div>
            <div id="marketCountdown" class="text-xs text-gray-500 mt-2">‚Äî</div>
          </div>
          <div class="rounded-2xl border border-gray-800 gradient-amber p-5 min-w-[240px]">
            <div class="text-xs text-gray-400 font-medium">Today's focus</div>
            <div id="todayFocusLine" class="text-sm text-gray-200 mt-2 font-medium">Finish your Daily Review.</div>
          </div>
        </div>
      </div>

      <!-- Risk Management Dashboard -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Daily Loss Limit</div>
          <div class="mt-3">
            <div class="flex items-baseline gap-2">
              <span id="dailyPnL" class="text-2xl font-bold">$0</span>
              <span id="dailyPnLLimit" class="text-xs text-gray-500">/ $500</span>
            </div>
            <div class="risk-meter mt-3">
              <div id="riskMeterFill" class="risk-meter-fill risk-low" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Trades Today</div>
          <div class="mt-3 flex items-baseline gap-2">
            <span id="tradesToday" class="text-2xl font-bold">0</span>
            <span id="tradesLimit" class="text-xs text-gray-500">/ 5 max</span>
          </div>
        </div>
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="text-xs text-gray-400 font-medium">Current Streak</div>
          <div class="mt-3 flex items-baseline gap-2">
            <span id="currentStreak" class="text-2xl font-bold">0</span>
            <span class="text-xs text-gray-500">PD days</span>
            <span class="streak-fire text-xl ml-1">üî•</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Performance Dashboard -->
    <section class="rounded-3xl border border-gray-800 glass p-8">
      <div class="flex items-start justify-between gap-4 flex-col lg:flex-row">
        <div>
          <div class="text-2xl font-bold">Your Dashboard</div>
          <div class="text-sm text-gray-400 mt-1">Streaks, weekly summary, and your R-curve.</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-2xl gradient-blue border border-blue-500/20 p-6">
          <div class="text-xs text-blue-300 font-medium">Daily Review Streak</div>
          <div id="streakReview" class="stat-number mt-3">0</div>
          <div class="text-xs text-gray-400 mt-2">Consecutive days you saved a review.</div>
        </div>
        <div class="rounded-2xl gradient-green border border-emerald-500/20 p-6">
          <div class="text-xs text-emerald-300 font-medium">Disciplined Streak</div>
          <div id="streakDisciplined" class="stat-number mt-3">0 <span class="streak-fire text-2xl">üî•</span></div>
          <div class="text-xs text-gray-400 mt-2">Consecutive PD days (profitable + disciplined).</div>
        </div>
        <div class="rounded-2xl gradient-amber border border-amber-500/20 p-6">
          <div class="text-xs text-amber-300 font-medium">This Week's Avg R</div>
          <div id="weekAvgR" class="stat-number mt-3">‚Äî</div>
          <div id="weekMini" class="text-xs text-gray-400 mt-2">‚Äî</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="text-sm font-bold">Weekly Summary</div>
          <div id="weeklySummary" class="text-sm text-gray-300 mt-4 leading-relaxed">‚Äî</div>
        </div>
        <div class="lg:col-span-2 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold">P&L Curve (R)</div>
            <div class="text-xs text-gray-500">Updates as you log trades</div>
          </div>
          <div class="mt-4">
            <canvas id="rChart" height="110"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Mistake Trend Analysis -->
    <section class="rounded-3xl border border-gray-800 glass p-8">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-bold">Mistake Trend Analysis</div>
          <div class="text-sm text-gray-400 mt-1">Track your emotional patterns over time</div>
        </div>
      </div>
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
        <canvas id="mistakeTrendChart" height="80"></canvas>
      </div>
    </section>

    <!-- Stats Grid -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card rounded-3xl glass border border-gray-800 p-6">
        <div class="text-sm text-gray-400 font-medium">Total Trades (filtered)</div>
        <div id="statTotalTrades" class="stat-number mt-3">0</div>
      </div>
      <div class="card rounded-3xl glass border border-gray-800 p-6">
        <div class="text-sm text-gray-400 font-medium">Avg Post Score (weighted)</div>
        <div id="statAvgScore" class="stat-number mt-3">0%</div>
      </div>
      <div class="card rounded-3xl glass border border-gray-800 p-6">
        <div class="text-sm text-gray-400 font-medium">Win Rate (filtered)</div>
        <div id="statWinRate" class="stat-number mt-3">0%</div>
      </div>
      <div class="card rounded-3xl glass border border-gray-800 p-6">
        <div class="text-sm text-gray-400 font-medium">Avg Realized R (filtered)</div>
        <div id="statAvgR" class="stat-number mt-3">0.00</div>
      </div>
    </section>

    <!-- Analytics Filters -->
    <section id="analyticsSection" class="card rounded-3xl glass border border-gray-800 p-8">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <div class="text-2xl font-bold">Analytics Filters</div>
          <div class="text-sm text-gray-400 mt-1">Slice by strategy/session/day/setup. The truth hurts, but it's cheaper.</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
          <div>
            <label class="text-xs text-gray-400 font-medium">Strategy</label>
            <select id="filterStrategy" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="ALL">All strategies</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400 font-medium">Setup</label>
            <select id="filterSetup" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="ALL">All setups</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400 font-medium">Session</label>
            <select id="filterSession" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="ALL">All</option>
              <option value="London">London</option>
              <option value="NY">NY</option>
              <option value="ORB">ORB</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400 font-medium">Day of week</label>
            <select id="filterDOW" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="ALL">All</option>
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Score Distribution (A/B/C)</div>
            <div class="text-xs text-gray-400">post score</div>
          </div>
          <div class="mt-4 space-y-3" id="distBars"></div>
        </div>

        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Avg R by Grade</div>
            <div class="text-xs text-gray-400">completed reviews</div>
          </div>
          <div class="mt-4 space-y-3" id="rBars"></div>
        </div>
      </div>

      <!-- Setup Performance -->
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
        <div class="font-semibold mb-4">Performance by Setup</div>
        <div id="setupPerformance" class="space-y-3"></div>
      </div>
    </section>

    <!-- Strategy Builder + Rule Locks -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card rounded-3xl glass border border-gray-800 p-8">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-2xl font-bold">Strategy Builder</div>
            <div class="text-sm text-gray-400 mt-1">Each checklist item has a weight 1‚Äì3.</div>
          </div>
          <button id="newStrategyBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold">New Strategy</button>
        </div>

        <div id="strategyCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>

        <div id="strategyFormWrap" class="hidden mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Create Strategy</div>
            <button id="cancelStrategyBtn" class="text-sm text-gray-300 hover:text-white transition">Cancel</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="text-xs text-gray-400 font-medium">Strategy name</label>
              <input id="sName" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., ORB Reversal"/>
            </div>
            <div>
              <label class="text-xs text-gray-400 font-medium">Timeframe</label>
              <select id="sTF" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
                <option value="">Select</option>
                <option>1m</option><option>5m</option><option>15m</option><option>1H</option><option>4H</option><option>1D</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">Checklist items</div>
                <div class="text-xs text-gray-400">Rule text + weight (1‚Äì3)</div>
              </div>
              <button id="addRuleBtn" class="px-3 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm transition">Add rule</button>
            </div>
            <div id="rulesList" class="mt-3 space-y-2"></div>
          </div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="saveStrategyBtn" class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold">Save</button>
          </div>
        </div>
      </div>

      </section>

    <!-- Trade Entry + Trades List -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 card rounded-3xl glass border border-gray-800 p-8">
        <div>
          <div class="text-xl font-bold">Trade Entry</div>
          <div class="text-sm text-gray-400 mt-1">Pre-trade checklist + confidence. Post-trade review is separate.</div>
        </div>

        <form id="tradeForm" class="mt-6 space-y-4">
          <div>
            <label class="text-xs text-gray-400 font-medium">Strategy (required)</label>
            <select id="tStrategy" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="">Select</option>
            </select>
          </div>

          <div>
            <label class="text-xs text-gray-400 font-medium">Setup Type</label>
            <select id="tSetup" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="">Select</option>
              <option>ORB</option>
              <option>Reversal</option>
              <option>Breakout</option>
              <option>Continuation</option>
              <option>Pullback</option>
              <option>Scalp</option>
              <option>Swing</option>
              <option>Other</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400 font-medium">Symbol</label>
              <input id="tSymbol" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="AAPL / MNQ"/>
            </div>
            <div>
              <label class="text-xs text-gray-400 font-medium">Session</label>
              <select id="tSession" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
                <option>London</option><option>NY</option><option>ORB</option><option>Other</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400 font-medium">Date</label>
            <input id="tDate" type="date" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
          </div>

          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400 font-medium">Risk ($)</label>
              <input id="tRisk" type="number" step="0.01" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
            </div>
            <div>
              <label class="text-xs text-gray-400 font-medium">Confidence</label>
              <select id="tConfidence" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
                <option value="1">Low</option>
                <option value="2" selected>Medium</option>
                <option value="3">High</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-400 font-medium">Screenshot</label>
            <input id="tShot" type="file" accept="image/*" class="mt-2 w-full text-sm text-gray-300">
          </div>

          <div>
            <label class="text-xs text-gray-400 font-medium">Notes</label>
            <textarea id="tNotes" rows="2" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="Reasoning, mistakes, etc."></textarea>
          </div>

          <button type="button" id="preTradeBtn" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">
            Pre-trade checklist
          </button>
        </form>
      </div>

      <div class="lg:col-span-2 card rounded-3xl glass border border-gray-800 p-8">
        <div>
          <div class="text-xl font-bold">Trades</div>
          <div class="text-sm text-gray-400 mt-1">Complete a post-trade review to unlock the best analytics.</div>
        </div>

        <div id="tradesList" class="mt-6 space-y-4"></div>
      </div>
    </section>
  </main>

  <!-- ALL MODALS START HERE -->

  <!-- Goals Modal -->
  <div id="modalGoals" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-5xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Goals & Milestones üéØ</div>
          <div class="text-sm text-gray-400 mt-1">Track your progress and celebrate wins</div>
        </div>
        <button id="goalsClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <!-- Current Goals -->
      <div class="mt-6 space-y-4" id="goalsList"></div>

      <!-- Add New Goal -->
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
        <div class="font-bold text-lg mb-4">Create New Goal</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-gray-400 font-medium">Goal Type</label>
            <select id="goalType" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
              <option value="monthly_r">Monthly R-Multiple</option>
              <option value="win_rate">Win Rate</option>
              <option value="pd_streak">PD Streak</option>
              <option value="a_grade_trades">A-Grade Trades</option>
              <option value="custom">Custom Goal</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-400 font-medium">Target Value</label>
            <input id="goalTarget" type="number" step="0.1" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 10">
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-gray-400 font-medium">Goal Description</label>
            <input id="goalDesc" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., Achieve 10R for the month">
          </div>
        </div>
        <button id="addGoalBtn" class="mt-4 px-6 py-3 rounded-xl btn-primary text-sm font-bold">Add Goal</button>
      </div>

      <!-- Achievements -->
      <div class="mt-6">
        <div class="font-bold text-lg mb-4">Recent Achievements üéâ</div>
        <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="modalExport" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-md rounded-3xl glass p-8 modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Export Data</div>
          <div class="text-sm text-gray-400 mt-1">Download your trading data</div>
        </div>
        <button id="exportClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <div class="mt-6 space-y-3">
        <button id="exportAllData" class="w-full px-6 py-4 rounded-2xl bg-gray-800 hover:bg-gray-700 text-left transition">
          <div class="font-semibold">Export All Data (CSV)</div>
          <div class="text-xs text-gray-400 mt-1">All trades with complete details</div>
        </button>
        <button id="exportReport" class="w-full px-6 py-4 rounded-2xl bg-gray-800 hover:bg-gray-700 text-left transition">
          <div class="font-semibold">Generate Report (Text)</div>
          <div class="text-xs text-gray-400 mt-1">Performance summary with insights</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="modalSettings" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-3xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Settings</div>
          <div class="text-sm text-gray-400 mt-1">Risk limits, notifications & accountability</div>
        </div>
        <button id="settingsClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <!-- Risk Management -->
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
        <div class="font-bold text-lg mb-4">Risk Management</div>
        <div class="space-y-4">
          <div>
            <label class="text-xs text-gray-400 font-medium">Daily Loss Limit ($)</label>
            <input id="settingDailyLossLimit" type="number" step="10" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="500">
          </div>
          <div>
            <label class="text-xs text-gray-400 font-medium">Max Trades Per Day</label>
            <input id="settingMaxTrades" type="number" step="1" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="5">
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Hard Stop Mode</div>
              <div class="text-xs text-gray-400">Prevent trading after hitting limits</div>
            </div>
            <input id="settingHardStop" type="checkbox" class="w-5 h-5">
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
        <div class="font-bold text-lg mb-4">Notifications</div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Daily Review Reminder</div>
              <div class="text-xs text-gray-400">8:00 PM daily</div>
            </div>
            <input id="notifDailyReview" type="checkbox" class="w-5 h-5">
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Pre-Market Checklist</div>
              <div class="text-xs text-gray-400">9:00 AM on trading days</div>
            </div>
            <input id="notifPreMarket" type="checkbox" class="w-5 h-5">
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Risk Limit Warnings</div>
              <div class="text-xs text-gray-400">When approaching limits</div>
            </div>
            <input id="notifRiskLimit" type="checkbox" class="w-5 h-5">
          </div>
          <button id="requestNotifPermission" class="w-full px-4 py-3 rounded-xl btn-primary text-sm font-bold">
            Enable Notifications
          </button>
        </div>
      </div>

      <!-- Accountability Partner -->
      <div class="mt-6 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
        <div class="font-bold text-lg mb-4">Accountability Partner</div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Enable Sharing</div>
              <div class="text-xs text-gray-400">Generate shareable link for your stats</div>
            </div>
            <input id="accountabilityEnabled" type="checkbox" class="w-5 h-5">
          </div>
          <div id="accountabilityLink" class="hidden">
            <label class="text-xs text-gray-400 font-medium">Your Share Link</label>
            <div class="mt-2 flex gap-2">
              <input id="shareLink" readonly class="flex-1 bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm" value="https://tradecheck.app/share/abc123">
              <button id="copyShareLink" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Copy</button>
            </div>
            <div class="text-xs text-gray-500 mt-2">Your partner can view stats but not trade details or notes.</div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between gap-2">
        <button id="resetBtn" class="px-6 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-sm font-bold transition">Reset All Data</button>
        <button id="saveSettingsBtn" class="px-6 py-3 rounded-xl btn-primary text-sm font-bold">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Pre-trade Modal -->
  <div id="modalPre" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-3xl rounded-3xl glass p-8 modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Pre-trade Checklist</div>
          <div class="text-sm text-gray-400 mt-1">Predict score before saving.</div>
        </div>
        <button id="preClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <div id="preWarn" class="hidden mt-6 rounded-2xl border px-6 py-4 text-sm"></div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">Check what you truly have, not what you want.</div>
          <div id="preRules" class="mt-4 space-y-3"></div>
        </div>

        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Predicted Score</div>
          <div class="mt-4">
            <div class="text-5xl font-black" id="preScore">0%</div>
            <div class="text-sm text-gray-400 mt-2" id="preGrade">Grade: C</div>
          </div>

          <div class="mt-6 text-sm text-gray-300 space-y-2">
            <div><span class="text-gray-400">Strategy:</span> <span id="preStrategy" class="font-medium">‚Äî</span></div>
            <div><span class="text-gray-400">Confidence:</span> <span id="preConf" class="font-medium">‚Äî</span></div>
          </div>

          <div class="mt-6 flex items-center gap-3">
            <button id="saveTradeBtn" class="flex-1 px-4 py-3 rounded-xl btn-primary text-sm font-bold">Save trade</button>
            <button id="preCancel" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Cancel</button>
          </div>

          <div class="text-xs text-gray-500 mt-4">
            Rule locks apply here. If block is enabled and score is under threshold, saving is disabled.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-trade Review Modal -->
  <div id="modalPost" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-6xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Post-trade Review</div>
          <div id="postSub" class="text-sm text-gray-400 mt-1">Complete review to lock in truth.</div>
        </div>
        <button id="postClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <div id="postLockMsg" class="hidden mt-6 rounded-2xl border border-red-500/30 gradient-red px-6 py-4 text-sm text-red-200"></div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: screenshot + summary -->
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Trade Snapshot</div>
          <div class="text-xs text-gray-400 mt-1" id="postMeta">‚Äî</div>
          <div class="mt-4">
            <img id="postImg" class="hidden rounded-xl border border-gray-800 max-h-80 object-contain w-full bg-black" alt="chart">
            <div id="postNoImg" class="text-sm text-gray-500">No screenshot saved for this trade.</div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl gradient-blue border border-blue-500/20 p-4">
              <div class="text-xs text-blue-300 font-medium">Pre Score</div>
              <div class="text-2xl font-bold mt-1" id="postPreScore">‚Äî</div>
            </div>
            <div class="rounded-xl gradient-green border border-emerald-500/20 p-4">
              <div class="text-xs text-emerald-300 font-medium">Post Score</div>
              <div class="text-2xl font-bold mt-1" id="postPostScore">‚Äî</div>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400" id="postDelta">‚Äî</div>
        </div>

        <!-- Middle: post checklist -->
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Post Checklist (weighted)</div>
          <div class="text-xs text-gray-400 mt-1">What actually happened.</div>
          <div id="postRules" class="mt-4 space-y-3"></div>
        </div>

        <!-- Right: outcome + mistakes -->
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="font-bold text-lg">Outcome & Review</div>
          <div class="text-xs text-gray-400 mt-1">Keep it structured so analytics work.</div>

          <div class="mt-4 space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-400 font-medium">Result</label>
                <select id="prResult" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
                  <option value="">Select</option>
                  <option value="win">Win</option>
                  <option value="loss">Loss</option>
                  <option value="be">Break-even</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-gray-400 font-medium">Realized R</label>
                <input id="prR" type="number" step="0.01" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 1.50 or -1.00">
              </div>
            </div>

            <div>
              <label class="text-xs text-gray-400 font-medium">Exit reason</label>
              <select id="prExit" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition">
                <option value="">Select</option>
                <option>TP hit</option>
                <option>SL hit</option>
                <option>Manual exit</option>
                <option>Time stop</option>
                <option>Rule violation exit</option>
                <option>Other</option>
              </select>
            </div>

            <div>
              <div class="text-xs text-gray-400 font-medium mb-2">Mistake tags</div>
              <div id="mistakeChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div>
              <label class="text-xs text-gray-400 font-medium">One-sentence lesson (required)</label>
              <input id="prLesson" maxlength="120" class="mt-2 w-full bg-gray-950 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="Next time I will...">
              <div class="text-xs text-gray-500 mt-1">Max 120 characters. No essays. No coping.</div>
            </div>

            <div class="flex items-center gap-3 pt-2">
              <button id="savePostBtn" class="flex-1 px-4 py-3 rounded-xl btn-primary text-sm font-bold">Save post review</button>
              <button id="postCancel" class="px-4 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Cancel</button>
            </div>

            <div class="text-xs text-gray-500">
              Post review locks 24 hours after you save it.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Review Modal -->
  <div id="modalDaily" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-5xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Daily Review</div>
          <div id="dailySub" class="text-sm text-gray-400 mt-1">A 5-minute truth session. Your excuses can wait.</div>
        </div>
        <button id="dailyClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: date + summary -->
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="flex items-center justify-between">
            <div class="font-bold">Day</div>
            <input id="dailyDate" type="date" class="bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 transition">
          </div>

          <div class="mt-4 rounded-xl gradient-blue border border-blue-500/20 p-4">
            <div class="text-xs text-blue-300 font-medium">Auto summary</div>
            <div id="dailySummary" class="text-sm text-gray-200 mt-2">‚Äî</div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl border border-gray-800 bg-gray-950 p-3">
              <div class="text-xs text-gray-400">Trades</div>
              <div class="text-xl font-bold mt-1" id="dailyTrades">0</div>
            </div>
            <div class="rounded-xl border border-gray-800 bg-gray-950 p-3">
              <div class="text-xs text-gray-400">Avg R</div>
              <div class="text-xl font-bold mt-1" id="dailyAvgR">0.00</div>
            </div>
            <div class="rounded-xl border border-gray-800 bg-gray-950 p-3">
              <div class="text-xs text-gray-400">Win rate</div>
              <div class="text-xl font-bold mt-1" id="dailyWinRate">0%</div>
            </div>
            <div class="rounded-xl border border-gray-800 bg-gray-950 p-3">
              <div class="text-xs text-gray-400">Reviews done</div>
              <div class="text-xl font-bold mt-1" id="dailyReviewRate">0%</div>
            </div>
          </div>
        </div>

        <!-- Right: prompts -->
        <div class="lg:col-span-2 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-lg">Tonight's prompts</div>
              <div class="text-xs text-gray-400 mt-1">Generated from today's behavior. Not your intentions.</div>
            </div>
            <button id="dailyRegenerate" class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Regenerate</button>
          </div>

          <div id="dailyPrompts" class="mt-6 space-y-4"></div>

          <div class="mt-6 flex items-center justify-end gap-3">
            <button id="dailySave" class="px-6 py-3 rounded-xl btn-primary text-sm font-bold">Save daily review</button>
            <button id="dailyCancel" class="px-6 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Cancel</button>
          </div>

          <div id="dailyMsg" class="text-xs text-red-300 mt-3"></div>
          <div class="text-xs text-gray-500 mt-3">Saved reviews stay editable.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Journal Modal -->
  <div id="modalJournal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="w-full max-w-6xl rounded-3xl glass p-8 max-h-[90vh] overflow-y-auto modal-enter">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-bold">Journal</div>
          <div class="text-sm text-gray-400 mt-1">Your daily prompt, your answer, and the receipts.</div>
        </div>
        <button id="journalClose" class="text-gray-300 hover:text-white text-2xl transition">‚úï</button>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 rounded-2xl border border-gray-800 bg-gray-950/50 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
            <div class="text-sm font-bold">Entries</div>
            <button id="journalExport" class="text-xs px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 font-medium transition">Export</button>
          </div>
          <div id="journalList" class="max-h-[55vh] overflow-auto divide-y divide-gray-800"></div>
        </div>

        <div class="lg:col-span-2 rounded-2xl border border-gray-800 bg-gray-950/50 p-6">
          <div class="rounded-xl gradient-amber border border-amber-500/20 p-5 mb-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm font-bold">Free write</div>
                <div class="text-xs text-gray-400 mt-1">No prompt. No judgment. Just text.</div>
              </div>
              <button id="freeWriteSave" class="text-xs px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 font-medium transition">Save</button>
            </div>
            <textarea id="freeWriteText" rows="4" class="mt-4 w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="Dump the thoughts here..."></textarea>
          </div>

          <div id="journalDetail" class="text-sm text-gray-300">Select a date on the left.</div>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-end gap-2">
        <button id="journalDone" class="px-6 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition">Done</button>
      </div>
    </div>
  </div>
<script>
// =====================================================================
// SUPABASE CONFIGURATION
// =====================================================================
const SUPABASE_URL = "https://hfnpqamhtxhhsrwmngtv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_2im62kUUfZ_WLgaHuNmP7w_vFsuE0QV";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentEmail = "";
let currentUser = null;

const MS_24H = 24 * 60 * 60 * 1000;

// Helper functions
const todayISO = () => new Date().toISOString().slice(0,10);
const dowShort = (isoDate) => {
  const d = new Date(isoDate + "T00:00:00");
  return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
};
const gradeFromPct = (pct) => pct >= 80 ? "A" : (pct >= 60 ? "B" : "C");

const mistakeOptions = [
  "Early entry","Late entry","No confirmation","Moved stop","Cut winner early","Let loser run",
  "Revenge trade","Overrisked","FOMO","None"
];

const setupTypes = ["ORB", "Reversal", "Breakout", "Continuation", "Pullback", "Scalp", "Swing", "Other"];

const defaultState = {
  locks: { warn:false, block:false, threshold:70 },
  strategies: [],
  trades: [],
  journals: [],
  freeWrites: [],
  goals: [],
  achievements: [],
  settings: {
    dailyLossLimit: 500,
    maxTradesPerDay: 5,
    hardStopMode: false,
    notifications: {
      dailyReview: false,
      preMarket: false,
      riskLimit: true
    },
    accountability: {
      enabled: false,
      shareCode: null
    }
  }
};

const getLSKey = () => currentUserId ? `tradecheck_v5_${currentUserId}` : `tradecheck_v5__blocked`;

const loadState = () => {
  try {
    const raw = localStorage.getItem(getLSKey());
    if (!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    return Object.assign(structuredClone(defaultState), parsed);
  } catch(e) {
    return structuredClone(defaultState);
  }
};

const saveState = (st) => localStorage.setItem(getLSKey(), JSON.stringify(st));

async function loadStateRemote(){
  const { data, error } = await sb.from("app_state").select("state").eq("user_id", currentUserId).maybeSingle();
  if(error) throw error;
  return data?.state || null;
}

async function saveStateRemote(st){
  const payload = { user_id: currentUserId, state: st, updated_at: new Date().toISOString() };
  const { error } = await sb.from("app_state").upsert(payload);
  if(error) throw error;
}

let _remoteSaveTimer = null;
const saveStateSmart = (st) => {
  saveState(st);
  if(!currentUserId) return;
  clearTimeout(_remoteSaveTimer);
  _remoteSaveTimer = setTimeout(async ()=>{
    try { await saveStateRemote(st); } catch(e){ console.warn("Remote save failed:", e); }
  }, 500);
};

let state = structuredClone(defaultState);

const numOrNull = (v) => {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
};

const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const escapeAttr = (s) => escapeHtml(s).replaceAll("\n"," ");

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function show(el){ if(!el) return; el.classList.remove("hidden"); el.classList.add("flex"); }
function hide(el){ if(!el) return; el.classList.add("hidden"); el.classList.remove("flex"); }

// Confetti celebration
function celebrate() {
  const duration = 3000;
  const animationEnd = Date.now() + duration;
  const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  const interval = setInterval(function() {
    const timeLeft = animationEnd - Date.now();
    if (timeLeft <= 0) return clearInterval(interval);
    
    const particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
    }));
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
    }));
  }, 250);
}

// =====================================================================
// AUTH FUNCTIONS
// =====================================================================
async function sbSignUp(email, password){
  const { data, error } = await sb.auth.signUp({ email, password });
  if(error) throw error;
  return data;
}

async function sbLogin(email, password){
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) throw error;
  return data;
}

async function sbLogout(){
  const { error } = await sb.auth.signOut();
  if(error) throw error;
}

function setAuthMessage(t){ if(authMsg) authMsg.textContent = t || ""; }
function setObMessage(t){ if(obMsg) obMsg.textContent = t || ""; }
function setDailyMessage(t){ if(dailyMsg) dailyMsg.textContent = t || ""; }

// =====================================================================
// BOOT SUPABASE
// =====================================================================
async function bootSupabase(){
  const { data: { session } } = await sb.auth.getSession();
  if(session?.user){
    currentUser = session.user;
    currentUserId = session.user.id;
    currentEmail = session.user.email || "";
    await loadUserState();
    show(document.querySelector("main"));
    hide(authGate);
  } else {
    show(authGate);
  }
}

async function loadUserState(){
  try {
    const remote = await loadStateRemote();
    const local = loadState();
    if(remote && remote.trades && remote.trades.length > local.trades.length){
      state = remote;
    } else {
      state = local;
    }
  } catch(e){
    state = loadState();
  }
  
  if(!state.strategies || state.strategies.length === 0){
    show(onboardingGate);
    hide(document.querySelector("main"));
  } else {
    checkAndInitializeNotifications();
    render();
  }
}

// =====================================================================
// NOTIFICATIONS
// =====================================================================
function checkAndInitializeNotifications() {
  if (!("Notification" in window)) return;
  
  if (Notification.permission === "granted") {
    scheduleNotifications();
  }
}

function scheduleNotifications() {
  if (!state.settings.notifications) return;
  
  // Daily review reminder at 8 PM
  if (state.settings.notifications.dailyReview) {
    const now = new Date();
    const reminder = new Date();
    reminder.setHours(20, 0, 0, 0);
    if (now > reminder) reminder.setDate(reminder.getDate() + 1);
    
    const timeUntilReminder = reminder - now;
    setTimeout(() => {
      new Notification("TradeCheck: Daily Review", {
        body: "Time to review your trading day!",
        icon: "/TradeCheck/icons/icon-192.png",
        tag: "daily-review"
      });
    }, timeUntilReminder);
  }
  
  // Pre-market reminder at 9 AM
  if (state.settings.notifications.preMarket) {
    const now = new Date();
    const reminder = new Date();
    reminder.setHours(9, 0, 0, 0);
    if (now > reminder) reminder.setDate(reminder.getDate() + 1);
    
    const timeUntilReminder = reminder - now;
    setTimeout(() => {
      new Notification("TradeCheck: Pre-Market", {
        body: "Review your strategy before market open!",
        icon: "/TradeCheck/icons/icon-192.png",
        tag: "pre-market"
      });
    }, timeUntilReminder);
  }
}

// =====================================================================
// MOBILE NAVIGATION
// =====================================================================
function setupMobileNav() {
  const navBtns = document.querySelectorAll(".mobile-nav-btn");
  navBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      navBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const view = btn.dataset.view;
      if (view === "dashboard") {
        document.querySelector("main").scrollIntoView({ behavior: "smooth" });
      } else if (view === "trades") {
        document.querySelector("#tradesList").scrollIntoView({ behavior: "smooth" });
      } else if (view === "goals") {
        show(modalGoals);
        renderGoals();
      } else if (view === "review") {
        dailyDate.value = todayISO();
        generateDailyPrompts();
        show(modalDaily);
      } else if (view === "analytics") {
        const el = document.querySelector("#analyticsSection");
        if (el) el.scrollIntoView({ behavior: "smooth" });
      } else if (view === "settings") {
        show(modalSettings);
        loadSettings();
      }
    });
  });
}

// =====================================================================
// RISK MANAGEMENT
// =====================================================================
function updateRiskDashboard() {
  const today = todayISO();
  const todayTrades = state.trades.filter(t => t.date === today);
  
  // Calculate daily P&L
  let totalPnL = 0;
  todayTrades.forEach(t => {
    if (t.postReview && t.postReview.realizedR != null && t.risk != null) {
      totalPnL += (t.postReview.realizedR * t.risk);
    }
  });
  
  dailyPnL.textContent = `$${totalPnL.toFixed(2)}`;
  dailyPnLLimit.textContent = `/ $${state.settings.dailyLossLimit}`;
  
  // Update risk meter
  const lossLimitPct = Math.abs(totalPnL / state.settings.dailyLossLimit) * 100;
  riskMeterFill.style.width = `${Math.min(lossLimitPct, 100)}%`;
  
  riskMeterFill.classList.remove("risk-low", "risk-medium", "risk-high");
  if (lossLimitPct < 50) {
    riskMeterFill.classList.add("risk-low");
  } else if (lossLimitPct < 80) {
    riskMeterFill.classList.add("risk-medium");
  } else {
    riskMeterFill.classList.add("risk-high");
  }
  
  // Update trades today
  tradesToday.textContent = todayTrades.length;
  tradesLimit.textContent = `/ ${state.settings.maxTradesPerDay} max`;
  
  // Check for risk alerts
  if (totalPnL <= -state.settings.dailyLossLimit) {
    showRiskAlert("Daily loss limit reached! Stop trading.", "error");
    if (state.settings.hardStopMode) {
      preTradeBtn.disabled = true;
      preTradeBtn.classList.add("disabled");
    }
  } else if (totalPnL <= -state.settings.dailyLossLimit * 0.8) {
    showRiskAlert("Approaching daily loss limit. Be careful.", "warning");
  } else if (todayTrades.length >= state.settings.maxTradesPerDay) {
    showRiskAlert("Max trades reached for today.", "warning");
    if (state.settings.hardStopMode) {
      preTradeBtn.disabled = true;
      preTradeBtn.classList.add("disabled");
    }
  } else {
    hideRiskAlert();
    preTradeBtn.disabled = false;
    preTradeBtn.classList.remove("disabled");
  }
  
  // Update current streak
  const pdStreak = calcStreakDisciplined();
  currentStreak.textContent = pdStreak;
}

function showRiskAlert(message, type) {
  riskAlert.textContent = message;
  riskAlert.classList.remove("hidden", "gradient-red", "gradient-amber");
  if (type === "error") {
    riskAlert.classList.add("gradient-red", "border-red-500/30");
  } else {
    riskAlert.classList.add("gradient-amber", "border-amber-500/30");
  }
}

function hideRiskAlert() {
  riskAlert.classList.add("hidden");
}

// =====================================================================
// GOALS & MILESTONES
// =====================================================================
function renderGoals() {
  const goalsList = document.getElementById("goalsList");
  const achievementsList = document.getElementById("achievementsList");
  
  if (state.goals.length === 0) {
    goalsList.innerHTML = `<div class="text-center text-gray-400 py-8">No goals yet. Create one below!</div>`;
  } else {
    goalsList.innerHTML = state.goals.map(goal => {
      const progress = calculateGoalProgress(goal);
      const progressPct = Math.min((progress / goal.target) * 100, 100);
      const isComplete = progress >= goal.target;
      
      return `
        <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-6 ${isComplete ? 'gradient-green border-emerald-500/30' : ''}">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <div class="font-bold text-lg">${escapeHtml(goal.description)}</div>
              <div class="text-xs text-gray-400 mt-1">${escapeHtml(goal.type.replace(/_/g, ' '))}</div>
            </div>
            ${isComplete ? '<div class="text-3xl">üéâ</div>' : ''}
          </div>
          
          <div class="flex items-end justify-between mb-2">
            <div class="text-2xl font-bold">${progress.toFixed(1)} / ${goal.target}</div>
            <div class="text-sm text-gray-400">${progressPct.toFixed(0)}%</div>
          </div>
          
          <div class="goal-progress">
            <div class="goal-progress-bar" style="width: ${progressPct}%"></div>
          </div>
          
          <div class="flex items-center justify-between mt-3">
            <div class="text-xs text-gray-500">Created ${new Date(goal.createdAt).toLocaleDateString()}</div>
            <button class="text-xs px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-500 font-medium transition" onclick="deleteGoal('${goal.id}')">Delete</button>
          </div>
        </div>
      `;
    }).join("");
  }
  
  // Render achievements
  if (state.achievements.length === 0) {
    achievementsList.innerHTML = `<div class="col-span-2 text-center text-gray-400 py-8">No achievements yet. Keep trading!</div>`;
  } else {
    achievementsList.innerHTML = state.achievements.slice(-6).reverse().map(ach => `
      <div class="achievement-badge rounded-2xl gradient-amber border border-amber-500/30 p-5">
        <div class="text-3xl mb-2">${ach.emoji}</div>
        <div class="font-bold">${escapeHtml(ach.title)}</div>
        <div class="text-xs text-gray-400 mt-1">${escapeHtml(ach.description)}</div>
        <div class="text-xs text-gray-500 mt-2">${new Date(ach.earnedAt).toLocaleDateString()}</div>
      </div>
    `).join("");
  }
}

function calculateGoalProgress(goal) {
  switch (goal.type) {
    case "monthly_r": {
      const thisMonth = new Date().toISOString().slice(0, 7);
      const monthTrades = state.trades.filter(t => t.date.startsWith(thisMonth) && t.postReview?.realizedR != null);
      return monthTrades.reduce((sum, t) => sum + t.postReview.realizedR, 0);
    }
    case "win_rate": {
      const completed = state.trades.filter(t => t.postReview?.result);
      const wins = completed.filter(t => t.postReview.result === "win").length;
      return completed.length > 0 ? (wins / completed.length) * 100 : 0;
    }
    case "pd_streak": {
      return calcStreakDisciplined();
    }
    case "a_grade_trades": {
      return state.trades.filter(t => t.postScore && gradeFromPct(t.postScore) === "A").length;
    }
    default:
      return 0;
  }
}

function checkAndAwardAchievements() {
  const newAchievements = [];
  
  // Check 10-day PD streak
  const pdStreak = calcStreakDisciplined();
  if (pdStreak >= 10 && !state.achievements.find(a => a.id === "pd_streak_10")) {
    newAchievements.push({
      id: "pd_streak_10",
      emoji: "üî•",
      title: "10-Day Streak!",
      description: "10 consecutive profitable & disciplined days",
      earnedAt: new Date().toISOString()
    });
  }
  
  // Check 50 A-grade trades
  const aGradeTrades = state.trades.filter(t => t.postScore && gradeFromPct(t.postScore) === "A").length;
  if (aGradeTrades >= 50 && !state.achievements.find(a => a.id === "a_grade_50")) {
    newAchievements.push({
      id: "a_grade_50",
      emoji: "‚≠ê",
      title: "50 A-Grade Trades!",
      description: "Executed 50 high-quality setups",
      earnedAt: new Date().toISOString()
    });
  }
  
  // Check first profitable month
  const thisMonth = new Date().toISOString().slice(0, 7);
  const monthTrades = state.trades.filter(t => t.date.startsWith(thisMonth) && t.postReview?.realizedR != null);
  const monthR = monthTrades.reduce((sum, t) => sum + t.postReview.realizedR, 0);
  if (monthR > 0 && !state.achievements.find(a => a.id === "first_green_month")) {
    newAchievements.push({
      id: "first_green_month",
      emoji: "üíö",
      title: "First Green Month!",
      description: "Positive R-multiple for the month",
      earnedAt: new Date().toISOString()
    });
  }
  
  if (newAchievements.length > 0) {
    state.achievements.push(...newAchievements);
    celebrate();
    saveStateSmart(state);
  }
}

window.deleteGoal = function(goalId) {
  if (confirm("Delete this goal?")) {
    state.goals = state.goals.filter(g => g.id !== goalId);
    saveStateSmart(state);
    renderGoals();
  }
};

// =====================================================================
// MISTAKE TREND ANALYSIS
// =====================================================================
let mistakeTrendChart = null;

function renderMistakeTrend() {
  const canvas = document.getElementById("mistakeTrendChart");
  if (!canvas) return;
  
  // Get last 30 days
  const today = new Date();
  const dates = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0, 10));
  }
  
  // Count emotional mistakes per day
  const emotionalMistakes = ["Revenge trade", "FOMO", "Moved stop", "Cut winner early", "Let loser run"];
  const mistakeCounts = dates.map(date => {
    const dayTrades = state.trades.filter(t => t.date === date && t.postReview?.mistakes);
    let count = 0;
    dayTrades.forEach(t => {
      count += t.postReview.mistakes.filter(m => emotionalMistakes.includes(m)).length;
    });
    return count;
  });
  
  if (mistakeTrendChart) {
    mistakeTrendChart.destroy();
  }
  
  mistakeTrendChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [{
        label: 'Emotional Mistakes',
        data: mistakeCounts,
        borderColor: 'rgb(239, 68, 68)',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(17, 25, 40, 0.95)',
          titleColor: 'rgb(229, 231, 235)',
          bodyColor: 'rgb(156, 163, 175)',
          borderColor: 'rgba(75, 85, 99, 0.5)',
          borderWidth: 1,
          padding: 12,
          displayColors: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            color: 'rgb(107, 114, 128)',
            font: { size: 11 }
          },
          grid: { color: 'rgba(75, 85, 99, 0.2)' }
        },
        x: {
          ticks: { 
            color: 'rgb(107, 114, 128)',
            font: { size: 10 },
            maxRotation: 45,
            minRotation: 45
          },
          grid: { display: false }
        }
      }
    }
  });
}

// =====================================================================
// EXPORT FUNCTIONS
// =====================================================================
function exportAllDataCSV() {
  const headers = [
    "Date", "Symbol", "Strategy", "Setup", "Session", "Direction", "Entry", "Stop", "Target", 
    "Risk", "Confidence", "Pre Score", "Post Score", "Result", "Realized R", "Exit Reason", 
    "Mistakes", "Lesson", "Notes"
  ];
  
  const rows = state.trades.map(t => {
    const strat = state.strategies.find(s => s.id === t.strategyId);
    return [
      t.date || "",
      t.symbol || "",
      strat?.name || "",
      t.setup || "",
      t.session || "",
      t.direction || "",
      t.entry || "",
      t.stop || "",
      t.target || "",
      t.risk || "",
      t.confidence || "",
      t.preScore || "",
      t.postScore || "",
      t.postReview?.result || "",
      t.postReview?.realizedR || "",
      t.postReview?.exitReason || "",
      t.postReview?.mistakes?.join("; ") || "",
      t.postReview?.lesson || "",
      t.notes || ""
    ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(",");
  });
  
  const csv = [headers.join(","), ...rows].join("\n");
  downloadFile(csv, "tradecheck_all_data.csv", "text/csv");
}

function exportReport() {
  const completed = state.trades.filter(t => t.postReview?.realizedR != null);
  const totalR = completed.reduce((sum, t) => sum + t.postReview.realizedR, 0);
  const wins = completed.filter(t => t.postReview.result === "win").length;
  const winRate = completed.length > 0 ? (wins / completed.length) * 100 : 0;
  const avgR = completed.length > 0 ? totalR / completed.length : 0;
  
  const aGrades = state.trades.filter(t => t.postScore && gradeFromPct(t.postScore) === "A").length;
  const bGrades = state.trades.filter(t => t.postScore && gradeFromPct(t.postScore) === "B").length;
  const cGrades = state.trades.filter(t => t.postScore && gradeFromPct(t.postScore) === "C").length;
  
  const pdStreak = calcStreakDisciplined();
  const reviewStreak = calcStreakReview();
  
  const report = `
TRADECHECK PERFORMANCE REPORT
Generated: ${new Date().toLocaleString()}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
OVERALL STATS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Total Trades: ${state.trades.length}
Completed Reviews: ${completed.length}
Total R: ${totalR.toFixed(2)}
Average R: ${avgR.toFixed(2)}
Win Rate: ${winRate.toFixed(1)}%
Wins: ${wins} | Losses: ${completed.length - wins}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GRADE DISTRIBUTION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

A-Grade: ${aGrades} trades
B-Grade: ${bGrades} trades
C-Grade: ${cGrades} trades

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
STREAKS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Disciplined Streak: ${pdStreak} days üî•
Review Streak: ${reviewStreak} days

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GOALS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${state.goals.map(g => {
  const progress = calculateGoalProgress(g);
  const pct = ((progress / g.target) * 100).toFixed(0);
  return `${g.description}: ${progress.toFixed(1)} / ${g.target} (${pct}%)`;
}).join("\n")}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
END OF REPORT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  `.trim();
  
  downloadFile(report, "tradecheck_report.txt", "text/plain");
}

function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
// =====================================================================
// ONBOARDING
// =====================================================================
let obRulesCount = 0;

obAddRuleBtn.addEventListener("click", () => {
  obRulesCount++;
  const id = `obRule_${obRulesCount}`;
  const row = document.createElement("div");
  row.className = "flex items-center gap-2";
  row.innerHTML = `
    <input id="${id}_text" class="flex-1 bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm" placeholder="e.g., RSI below 30"/>
    <select id="${id}_weight" class="bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm">
      <option value="3">Core (3)</option>
      <option value="2">Confluence (2)</option>
      <option value="1">Filter (1)</option>
    </select>
    <button type="button" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-sm transition" onclick="this.parentElement.remove()">‚úï</button>
  `;
  obRulesList.appendChild(row);
});

finishOnboardingBtn.addEventListener("click", async () => {
  const name = obName.value.trim();
  const tf = obTF.value;
  if(!name || !tf){
    setObMessage("Please fill name and timeframe.");
    return;
  }
  
  const rulesEls = obRulesList.querySelectorAll("div");
  const rules = [];
  rulesEls.forEach(r => {
    const textEl = r.querySelector("input");
    const weightEl = r.querySelector("select");
    if(textEl && weightEl && textEl.value.trim()){
      rules.push({ text: textEl.value.trim(), weight: parseInt(weightEl.value) });
    }
  });
  
  if(rules.length === 0){
    setObMessage("Add at least one rule.");
    return;
  }
  
  const strategy = {
    id: Date.now().toString(),
    name,
    timeframe: tf,
    rules,
    createdAt: new Date().toISOString()
  };
  
  state.strategies.push(strategy);
  saveStateSmart(state);
  
  hide(onboardingGate);
  show(document.querySelector("main"));
  
  checkAndInitializeNotifications();
  render();
});

onboardLogout.addEventListener("click", async () => {
  await sbLogout();
  location.reload();
});

// =====================================================================
// AUTH HANDLERS
// =====================================================================
loginBtn.addEventListener("click", async () => {
  const email = authEmail.value.trim();
  const pass = authPass.value;
  if(!email || !pass){
    setAuthMessage("Enter email and password");
    return;
  }
  try {
    await sbLogin(email, pass);
    location.reload();
  } catch(e){
    setAuthMessage(e.message);
  }
});

signupBtn.addEventListener("click", async () => {
  const email = authEmail.value.trim();
  const pass = authPass.value;
  if(!email || pass.length < 6){
    setAuthMessage("Email required, password 6+ chars");
    return;
  }
  try {
    await sbSignUp(email, pass);
    setAuthMessage("Check your email to confirm!");
  } catch(e){
    setAuthMessage(e.message);
  }
});

logoutBtn.addEventListener("click", async () => {
  await sbLogout();
  location.reload();
});

// =====================================================================
// STRATEGY BUILDER
// =====================================================================
let editingStrategyId = null;
let ruleCount = 0;

newStrategyBtn.addEventListener("click", () => {
  editingStrategyId = null;
  sName.value = "";
  sTF.value = "";
  rulesList.innerHTML = "";
  ruleCount = 0;
  strategyFormWrap.classList.remove("hidden");
});

cancelStrategyBtn.addEventListener("click", () => {
  strategyFormWrap.classList.add("hidden");
});

addRuleBtn.addEventListener("click", () => {
  ruleCount++;
  const id = `rule_${ruleCount}`;
  const row = document.createElement("div");
  row.className = "flex items-center gap-2";
  row.innerHTML = `
    <input id="${id}_text" class="flex-1 bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm" placeholder="e.g., Price above VWAP"/>
    <select id="${id}_weight" class="bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm">
      <option value="3">Core (3)</option>
      <option value="2">Confluence (2)</option>
      <option value="1">Filter (1)</option>
    </select>
    <button type="button" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-sm font-medium transition" onclick="this.parentElement.remove()">‚úï</button>
  `;
  rulesList.appendChild(row);
});

saveStrategyBtn.addEventListener("click", () => {
  const name = sName.value.trim();
  const tf = sTF.value;
  if(!name || !tf){
    alert("Name and timeframe required");
    return;
  }
  
  const rulesEls = rulesList.querySelectorAll("div");
  const rules = [];
  rulesEls.forEach(r => {
    const textEl = r.querySelector("input");
    const weightEl = r.querySelector("select");
    if(textEl && weightEl && textEl.value.trim()){
      rules.push({ text: textEl.value.trim(), weight: parseInt(weightEl.value) });
    }
  });
  
  if(rules.length === 0){
    alert("Add at least one rule");
    return;
  }
  
  if(editingStrategyId){
    const idx = state.strategies.findIndex(s => s.id === editingStrategyId);
    if(idx >= 0){
      state.strategies[idx] = { ...state.strategies[idx], name, timeframe: tf, rules };
    }
  } else {
    const strategy = {
      id: Date.now().toString(),
      name,
      timeframe: tf,
      rules,
      createdAt: new Date().toISOString()
    };
    state.strategies.push(strategy);
  }
  
  saveStateSmart(state);
  strategyFormWrap.classList.add("hidden");
  renderStrategies();
  populateStrategySelects();
});

function renderStrategies(){
  if(state.strategies.length === 0){
    strategyCards.innerHTML = `<div class="col-span-2 text-center text-gray-400 py-8">No strategies yet.</div>`;
    return;
  }
  
  strategyCards.innerHTML = state.strategies.map(s => `
    <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="font-bold text-lg">${escapeHtml(s.name)}</div>
          <div class="text-xs text-gray-400 mt-1">${escapeHtml(s.timeframe)}</div>
        </div>
        <button class="text-xs px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 font-medium transition" onclick="editStrategy('${s.id}')">Edit</button>
      </div>
      <div class="text-sm text-gray-300 space-y-1">
        ${s.rules.map(r => `<div>‚Ä¢ ${escapeHtml(r.text)} (${r.weight})</div>`).join("")}
      </div>
    </div>
  `).join("");
}

window.editStrategy = function(id){
  const strat = state.strategies.find(s => s.id === id);
  if(!strat) return;
  
  editingStrategyId = id;
  sName.value = strat.name;
  sTF.value = strat.timeframe;
  
  rulesList.innerHTML = "";
  ruleCount = 0;
  strat.rules.forEach(rule => {
    ruleCount++;
    const rId = `rule_${ruleCount}`;
    const row = document.createElement("div");
    row.className = "flex items-center gap-2";
    row.innerHTML = `
      <input id="${rId}_text" class="flex-1 bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm" value="${escapeAttr(rule.text)}"/>
      <select id="${rId}_weight" class="bg-gray-950 border border-gray-700 rounded-xl px-3 py-2 text-sm">
        <option value="3" ${rule.weight === 3 ? "selected" : ""}>Core (3)</option>
        <option value="2" ${rule.weight === 2 ? "selected" : ""}>Confluence (2)</option>
        <option value="1" ${rule.weight === 1 ? "selected" : ""}>Filter (1)</option>
      </select>
      <button type="button" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-sm font-medium transition" onclick="this.parentElement.remove()">‚úï</button>
    `;
    rulesList.appendChild(row);
  });
  
  strategyFormWrap.classList.remove("hidden");
};

// =====================================================================
// TRADE ENTRY
// =====================================================================
tDate.value = todayISO();

preTradeBtn.addEventListener("click", async () => {
  const stratId = tStrategy.value;
  if(!stratId){
    alert("Select a strategy");
    return;
  }
  
  const strat = state.strategies.find(s => s.id === stratId);
  if(!strat){
    alert("Strategy not found");
    return;
  }
  
  // Populate pre-trade modal
  preStrategy.textContent = strat.name;
  preConf.textContent = tConfidence.options[tConfidence.selectedIndex].text;
  
  preRules.innerHTML = strat.rules.map((r, i) => `
    <div class="flex items-start gap-3">
      <input type="checkbox" id="preCheck_${i}" class="w-5 h-5 mt-1" onchange="updatePreScore()">
      <label for="preCheck_${i}" class="flex-1 text-sm">${escapeHtml(r.text)} <span class="text-gray-500">(${r.weight})</span></label>
    </div>
  `).join("");
  
  updatePreScore();
  show(modalPre);
});

window.updatePreScore = function(){
  const stratId = tStrategy.value;
  const strat = state.strategies.find(s => s.id === stratId);
  if(!strat) return;
  
  let checkedWeight = 0;
  let totalWeight = 0;
  strat.rules.forEach((r, i) => {
    totalWeight += r.weight;
    const cb = document.getElementById(`preCheck_${i}`);
    if(cb && cb.checked) checkedWeight += r.weight;
  });
  
  const score = totalWeight > 0 ? Math.round((checkedWeight / totalWeight) * 100) : 0;
  const grade = gradeFromPct(score);
  
  preScore.textContent = `${score}%`;
  preGrade.textContent = `Grade: ${grade}`;
  
  // Apply locks
  if(state.locks.warn && score < state.locks.threshold){
    preWarn.textContent = `‚ö†Ô∏è Score is below ${state.locks.threshold}%. Review your setup.`;
    preWarn.classList.remove("hidden", "gradient-red", "gradient-amber");
    preWarn.classList.add("gradient-amber", "border-amber-500/30");
  } else {
    preWarn.classList.add("hidden");
  }
  
  if(state.locks.block && score < state.locks.threshold){
    saveTradeBtn.disabled = true;
    saveTradeBtn.classList.add("disabled");
    preWarn.textContent = `üö´ Score below ${state.locks.threshold}%. Trade blocked by rule lock.`;
    preWarn.classList.remove("hidden", "gradient-amber");
    preWarn.classList.add("gradient-red", "border-red-500/30");
  } else {
    saveTradeBtn.disabled = false;
    saveTradeBtn.classList.remove("disabled");
  }
};

saveTradeBtn.addEventListener("click", async () => {
  const stratId = tStrategy.value;
  const strat = state.strategies.find(s => s.id === stratId);
  if(!strat) return;
  
  // Calculate pre-score
  let checkedWeight = 0;
  let totalWeight = 0;
  const preChecklist = [];
  strat.rules.forEach((r, i) => {
    totalWeight += r.weight;
    const cb = document.getElementById(`preCheck_${i}`);
    const checked = cb ? cb.checked : false;
    if(checked) checkedWeight += r.weight;
    preChecklist.push({ ...r, checked });
  });
  
  const preScore = totalWeight > 0 ? Math.round((checkedWeight / totalWeight) * 100) : 0;
  
  const trade = {
    id: Date.now().toString(),
    strategyId: stratId,
    symbol: tSymbol.value.trim(),
    setup: tSetup.value,
    session: tSession.value,
    date: tDate.value,
risk: numOrNull(tRisk.value),
    confidence: parseInt(tConfidence.value),
    notes: tNotes.value.trim(),
    preScore,
    preChecklist,
    screenshot: null,
    postScore: null,
    postReview: null,
    createdAt: new Date().toISOString()
  };
  
  // Handle screenshot
  const file = tShot.files[0];
  if(file){
    try {
      trade.screenshot = await fileToDataURL(file);
    } catch(e){
      console.error("Screenshot error:", e);
    }
  }
  
  state.trades.push(trade);
  saveStateSmart(state);
  
  hide(modalPre);
  
  // Reset form
  tSymbol.value = "";
  tSetup.value = "";
tRisk.value = "";
  tConfidence.value = "2";
  tNotes.value = "";
  tShot.value = "";
  tDate.value = todayISO();
  
  render();
  checkAndAwardAchievements();
});

preClose.addEventListener("click", () => hide(modalPre));
preCancel.addEventListener("click", () => hide(modalPre));

// =====================================================================
// POST-TRADE REVIEW
// =====================================================================
let currentPostTradeId = null;

window.openPostReview = function(tradeId){
  const trade = state.trades.find(t => t.id === tradeId);
  if(!trade) return;
  
  const strat = state.strategies.find(s => s.id === trade.strategyId);
  if(!strat) return;
  
  // Check if locked
  if(trade.postReview && trade.postReview.lockedAt){
    const lockedTime = new Date(trade.postReview.lockedAt).getTime();
    const now = Date.now();
    if(now - lockedTime > MS_24H){
      postLockMsg.textContent = "‚ö†Ô∏è This review is locked (24h elapsed). Cannot edit.";
      postLockMsg.classList.remove("hidden");
      savePostBtn.disabled = true;
    } else {
      postLockMsg.classList.add("hidden");
      savePostBtn.disabled = false;
    }
  } else {
    postLockMsg.classList.add("hidden");
    savePostBtn.disabled = false;
  }
  
  currentPostTradeId = tradeId;
  
  postMeta.textContent = `${trade.symbol} | ${strat.name} | ${trade.date}`;
  
  if(trade.screenshot){
    postImg.src = trade.screenshot;
    postImg.classList.remove("hidden");
    postNoImg.classList.add("hidden");
  } else {
    postImg.classList.add("hidden");
    postNoImg.classList.remove("hidden");
  }
  
  postPreScore.textContent = `${trade.preScore}%`;
  postPostScore.textContent = trade.postScore ? `${trade.postScore}%` : "‚Äî";
  
  if(trade.postScore){
    const delta = trade.postScore - trade.preScore;
    const deltaText = delta >= 0 ? `+${delta}%` : `${delta}%`;
    const deltaColor = delta >= 0 ? "text-emerald-400" : "text-red-400";
    postDelta.innerHTML = `Delta: <span class="${deltaColor} font-semibold">${deltaText}</span>`;
  } else {
    postDelta.textContent = "Complete review to see delta";
  }
  
  // Post checklist
  postRules.innerHTML = strat.rules.map((r, i) => `
    <div class="flex items-start gap-3">
      <input type="checkbox" id="postCheck_${i}" class="w-5 h-5 mt-1" ${trade.postReview?.postChecklist?.[i]?.checked ? "checked" : ""}>
      <label for="postCheck_${i}" class="flex-1 text-sm">${escapeHtml(r.text)} <span class="text-gray-500">(${r.weight})</span></label>
    </div>
  `).join("");
  
  // Outcome fields
  prResult.value = trade.postReview?.result || "";
  prR.value = trade.postReview?.realizedR ?? "";
  prExit.value = trade.postReview?.exitReason || "";
  prLesson.value = trade.postReview?.lesson || "";
  
  // Mistake chips
  mistakeChips.innerHTML = mistakeOptions.map(m => {
    const selected = trade.postReview?.mistakes?.includes(m);
    return `
      <button type="button" class="chip px-3 py-1.5 rounded-lg text-xs font-medium transition ${selected ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-gray-800 text-gray-300'}" onclick="toggleMistake('${escapeAttr(m)}', this)">
        ${escapeHtml(m)}
      </button>
    `;
  }).join("");
  
  show(modalPost);
};

window.toggleMistake = function(mistake, btn){
  btn.classList.toggle("bg-red-500/20");
  btn.classList.toggle("border-red-500/50");
  btn.classList.toggle("text-red-200");
  btn.classList.toggle("bg-gray-800");
  btn.classList.toggle("text-gray-300");
};

savePostBtn.addEventListener("click", () => {
  const trade = state.trades.find(t => t.id === currentPostTradeId);
  if(!trade) return;
  
  const strat = state.strategies.find(s => s.id === trade.strategyId);
  if(!strat) return;
  
  const result = prResult.value;
  const realizedR = numOrNull(prR.value);
  const exitReason = prExit.value;
  const lesson = prLesson.value.trim();
  
  if(!result || realizedR == null || !exitReason || !lesson){
    alert("Complete all required fields");
    return;
  }
  
  // Calculate post score
  let checkedWeight = 0;
  let totalWeight = 0;
  const postChecklist = [];
  strat.rules.forEach((r, i) => {
    totalWeight += r.weight;
    const cb = document.getElementById(`postCheck_${i}`);
    const checked = cb ? cb.checked : false;
    if(checked) checkedWeight += r.weight;
    postChecklist.push({ ...r, checked });
  });
  
  const postScore = totalWeight > 0 ? Math.round((checkedWeight / totalWeight) * 100) : 0;
  
  // Get mistakes
  const mistakes = [];
  mistakeOptions.forEach(m => {
    const btn = Array.from(mistakeChips.querySelectorAll("button")).find(b => b.textContent.trim() === m);
    if(btn && btn.classList.contains("bg-red-500/20")){
      mistakes.push(m);
    }
  });
  
  trade.postScore = postScore;
  trade.postReview = {
    result,
    realizedR,
    exitReason,
    mistakes,
    lesson,
    postChecklist,
    completedAt: new Date().toISOString(),
    lockedAt: trade.postReview?.lockedAt || new Date().toISOString()
  };
  
  saveStateSmart(state);
  hide(modalPost);
  render();
  checkAndAwardAchievements();
});

postClose.addEventListener("click", () => hide(modalPost));
postCancel.addEventListener("click", () => hide(modalPost));

// =====================================================================
// DAILY REVIEW
// =====================================================================
dailyReviewBtn.addEventListener("click", () => {
  dailyDate.value = todayISO();
  generateDailyPrompts();
  show(modalDaily);
});

// Quick jump to analytics
const analyticsBtn = document.getElementById("analyticsBtn");
if(analyticsBtn){ analyticsBtn.addEventListener("click", () => { const el = document.getElementById("analyticsSection"); if(el) el.scrollIntoView({ behavior: "smooth" }); }); }


function generateDailyPrompts(){
  const date = dailyDate.value;
  const dayTrades = state.trades.filter(t => t.date === date);
  
  const completed = dayTrades.filter(t => t.postReview?.realizedR != null);
  const avgR = completed.length > 0 ? completed.reduce((sum, t) => sum + t.postReview.realizedR, 0) / completed.length : 0;
  const wins = completed.filter(t => t.postReview.result === "win").length;
  const winRate = completed.length > 0 ? (wins / completed.length) * 100 : 0;
  const reviewRate = dayTrades.length > 0 ? (completed.length / dayTrades.length) * 100 : 0;
  
  let emotionalCount = 0;
  completed.forEach(t => {
    if(t.postReview.mistakes && t.postReview.mistakes.some(m => 
      ["Revenge trade", "FOMO", "Moved stop", "Cut winner early", "Let loser run"].includes(m)
    )){
      emotionalCount++;
    }
  });
  const emotionalRate = completed.length > 0 ? (emotionalCount / completed.length) * 100 : 0;
  
  dailySummary.textContent = dayTrades.length === 0 ? "No trades today." : `${dayTrades.length} trades, Avg R: ${avgR.toFixed(2)}`;
  dailyTrades.textContent = dayTrades.length;
  dailyAvgR.textContent = avgR.toFixed(2);
  dailyWinRate.textContent = `${winRate.toFixed(0)}%`;
  dailyReviewRate.textContent = `${reviewRate.toFixed(0)}%`;
  
  // Determine quadrant
  const profitable = avgR > 0;
  const disciplined = emotionalRate < 34 && reviewRate === 100;
  
  let quadrant = "";
  if(profitable && disciplined) quadrant = "PD";
  else if(profitable && !disciplined) quadrant = "PE";
  else if(!profitable && disciplined) quadrant = "UD";
  else quadrant = "UE";
  
  // Generate prompts based on quadrant
  const prompts = getPromptsForQuadrant(quadrant, dayTrades, completed);
  
  dailyPrompts.innerHTML = prompts.map((p, i) => `
    <div class="rounded-2xl border border-gray-800 bg-gray-950 p-5">
      <div class="font-semibold mb-2">${i + 1}. ${escapeHtml(p.question)}</div>
      <textarea id="prompt_${i}" rows="3" class="w-full mt-2 bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="Your honest answer...">${escapeHtml(p.answer || "")}</textarea>
    </div>
  `).join("");
}

function getPromptsForQuadrant(quadrant, dayTrades, completed){
  const existingJournal = state.journals.find(j => j.date === dailyDate.value);
  
  const basePrompts = {
    "PD": [
      { question: "What did you do well today that you want to repeat?", answer: existingJournal?.prompts?.[0]?.answer || "" },
      { question: "How did following your rules contribute to your success?", answer: existingJournal?.prompts?.[1]?.answer || "" },
      { question: "What's one thing you could optimize to increase your edge?", answer: existingJournal?.prompts?.[2]?.answer || "" }
    ],
    "PE": [
      { question: "You made money, but broke rules. Which rules did you violate and why?", answer: existingJournal?.prompts?.[0]?.answer || "" },
      { question: "What emotional state led to rule breaks? (FOMO, overconfidence, etc.)", answer: existingJournal?.prompts?.[1]?.answer || "" },
      { question: "If you continue this pattern, what will happen to your account?", answer: existingJournal?.prompts?.[2]?.answer || "" }
    ],
    "UD": [
      { question: "You followed your rules and lost. Is this normal statistical variance?", answer: existingJournal?.prompts?.[0]?.answer || "" },
      { question: "Do your rules need adjustment, or do you need more sample size?", answer: existingJournal?.prompts?.[1]?.answer || "" },
      { question: "How do you feel knowing you traded perfectly despite the loss?", answer: existingJournal?.prompts?.[2]?.answer || "" }
    ],
    "UE": [
      { question: "What went wrong today? Be specific about rule violations.", answer: existingJournal?.prompts?.[0]?.answer || "" },
      { question: "What emotional pattern drove today's poor decisions?", answer: existingJournal?.prompts?.[1]?.answer || "" },
      { question: "What's ONE concrete action to prevent this tomorrow?", answer: existingJournal?.prompts?.[2]?.answer || "" }
    ]
  };
  
  return basePrompts[quadrant] || basePrompts["UE"];
}

dailyRegenerate.addEventListener("click", generateDailyPrompts);

dailySave.addEventListener("click", () => {
  const date = dailyDate.value;
  const prompts = [];
  
  const promptEls = dailyPrompts.querySelectorAll("textarea");
  promptEls.forEach((el, i) => {
    const question = dailyPrompts.querySelectorAll(".font-semibold")[i].textContent.replace(/^\d+\.\s*/, "");
    prompts.push({
      question,
      answer: el.value.trim()
    });
  });
  
  if(prompts.some(p => !p.answer)){
    setDailyMessage("Please answer all prompts");
    return;
  }
  
  const existingIdx = state.journals.findIndex(j => j.date === date);
  const journal = {
    date,
    prompts,
    savedAt: new Date().toISOString()
  };
  
  if(existingIdx >= 0){
    state.journals[existingIdx] = journal;
  } else {
    state.journals.push(journal);
  }
  
  saveStateSmart(state);
  hide(modalDaily);
  render();
  checkAndAwardAchievements();
});

dailyClose.addEventListener("click", () => hide(modalDaily));
dailyCancel.addEventListener("click", () => hide(modalDaily));

// =====================================================================
// JOURNAL
// =====================================================================
journalBtn.addEventListener("click", () => {
  renderJournalList();
  show(modalJournal);
});

function renderJournalList(){
  if(state.journals.length === 0){
    journalList.innerHTML = `<div class="px-5 py-8 text-center text-gray-400">No journal entries yet.</div>`;
    return;
  }
  
  journalList.innerHTML = state.journals.sort((a, b) => new Date(b.date) - new Date(a.date)).map(j => `
    <div class="px-5 py-4 hover:bg-gray-900 cursor-pointer transition" onclick="showJournalDetail('${j.date}')">
      <div class="font-semibold">${new Date(j.date + "T00:00:00").toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
      <div class="text-xs text-gray-400 mt-1">${j.prompts.length} prompts answered</div>
    </div>
  `).join("");
}

window.showJournalDetail = function(date){
  const journal = state.journals.find(j => j.date === date);
  if(!journal){
    journalDetail.textContent = "No entry found.";
    return;
  }
  
  journalDetail.innerHTML = `
    <div class="mb-6">
      <div class="text-xl font-bold">${new Date(date + "T00:00:00").toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div>
      <div class="text-xs text-gray-400 mt-1">Saved ${new Date(journal.savedAt).toLocaleString()}</div>
    </div>
    
    ${journal.prompts.map((p, i) => `
      <div class="mb-6">
        <div class="font-semibold text-gray-200 mb-2">${i + 1}. ${escapeHtml(p.question)}</div>
        <div class="text-sm text-gray-300 bg-gray-900 rounded-xl p-4 border border-gray-800">${escapeHtml(p.answer)}</div>
      </div>
    `).join("")}
  `;
};

freeWriteSave.addEventListener("click", () => {
  const text = freeWriteText.value.trim();
  if(!text){
    alert("Write something first!");
    return;
  }
  
  state.freeWrites.push({
    id: Date.now().toString(),
    text,
    createdAt: new Date().toISOString()
  });
  
  saveStateSmart(state);
  freeWriteText.value = "";
  alert("Free write saved!");
});

journalExport.addEventListener("click", () => {
  const data = {
    journals: state.journals,
    freeWrites: state.freeWrites
  };
  const json = JSON.stringify(data, null, 2);
  downloadFile(json, "tradecheck_journal.json", "application/json");
});

journalClose.addEventListener("click", () => hide(modalJournal));
journalDone.addEventListener("click", () => hide(modalJournal));

// =====================================================================
// SETTINGS
// =====================================================================
settingsBtn.addEventListener("click", () => {
  loadSettings();
  show(modalSettings);
});

function loadSettings(){
  settingDailyLossLimit.value = state.settings.dailyLossLimit;
  settingMaxTrades.value = state.settings.maxTradesPerDay;
  settingHardStop.checked = state.settings.hardStopMode;
  
  notifDailyReview.checked = state.settings.notifications.dailyReview;
  notifPreMarket.checked = state.settings.notifications.preMarket;
  notifRiskLimit.checked = state.settings.notifications.riskLimit;
  
  accountabilityEnabled.checked = state.settings.accountability.enabled;
  if(state.settings.accountability.enabled){
    accountabilityLink.classList.remove("hidden");
    if(!state.settings.accountability.shareCode){
      state.settings.accountability.shareCode = Math.random().toString(36).substring(2, 15);
      saveStateSmart(state);
    }
    shareLink.value = `https://tradecheck.app/share/${state.settings.accountability.shareCode}`;
  } else {
    accountabilityLink.classList.add("hidden");
  }
}

saveSettingsBtn.addEventListener("click", () => {
  state.settings.dailyLossLimit = parseInt(settingDailyLossLimit.value) || 500;
  state.settings.maxTradesPerDay = parseInt(settingMaxTrades.value) || 5;
  state.settings.hardStopMode = settingHardStop.checked;
  
  state.settings.notifications.dailyReview = notifDailyReview.checked;
  state.settings.notifications.preMarket = notifPreMarket.checked;
  state.settings.notifications.riskLimit = notifRiskLimit.checked;
  
  state.settings.accountability.enabled = accountabilityEnabled.checked;
  
  saveStateSmart(state);
  hide(modalSettings);
  render();
  alert("Settings saved!");
});

requestNotifPermission.addEventListener("click", async () => {
  if (!("Notification" in window)) {
    alert("Notifications not supported in this browser");
    return;
  }
  
  const permission = await Notification.requestPermission();
  if (permission === "granted") {
    alert("Notifications enabled!");
    scheduleNotifications();
  } else {
    alert("Notification permission denied");
  }
});

accountabilityEnabled.addEventListener("change", (e) => {
  if(e.target.checked){
    accountabilityLink.classList.remove("hidden");
    if(!state.settings.accountability.shareCode){
      state.settings.accountability.shareCode = Math.random().toString(36).substring(2, 15);
    }
    shareLink.value = `https://tradecheck.app/share/${state.settings.accountability.shareCode}`;
  } else {
    accountabilityLink.classList.add("hidden");
  }
});

copyShareLink.addEventListener("click", () => {
  shareLink.select();
  document.execCommand("copy");
  alert("Link copied to clipboard!");
});

resetBtn.addEventListener("click", () => {
  if(confirm("This will delete ALL your data. Are you absolutely sure?")){
    if(confirm("Last chance. Delete everything?")){
      state = structuredClone(defaultState);
      saveStateSmart(state);
      location.reload();
    }
  }
});

settingsClose.addEventListener("click", () => hide(modalSettings));

// =====================================================================
// GOALS MODAL HANDLERS
// =====================================================================
goalsBtn.addEventListener("click", () => {
  renderGoals();
  show(modalGoals);
});

addGoalBtn.addEventListener("click", () => {
  const type = goalType.value;
  const target = parseFloat(goalTarget.value);
  const desc = goalDesc.value.trim();
  
  if(!type || !target || !desc){
    alert("Fill all fields");
    return;
  }
  
  const goal = {
    id: Date.now().toString(),
    type,
    target,
    description: desc,
    createdAt: new Date().toISOString()
  };
  
  state.goals.push(goal);
  saveStateSmart(state);
  
  goalType.value = "monthly_r";
  goalTarget.value = "";
  goalDesc.value = "";
  
  renderGoals();
});

goalsClose.addEventListener("click", () => hide(modalGoals));

// =====================================================================
// EXPORT MODAL HANDLERS
// =====================================================================
exportBtn.addEventListener("click", () => show(modalExport));

document.getElementById("exportAllData").addEventListener("click", () => {
  exportAllDataCSV();
  hide(modalExport);
});

document.getElementById("exportReport").addEventListener("click", () => {
  exportReport();
  hide(modalExport);
});

exportClose.addEventListener("click", () => hide(modalExport));

// =====================================================================
// ANALYTICS & RENDERING
// =====================================================================
function populateStrategySelects(){
  const opts = state.strategies.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
  tStrategy.innerHTML = `<option value="">Select</option>` + opts;
  filterStrategy.innerHTML = `<option value="ALL">All strategies</option>` + opts;
}

function populateSetupFilter(){
  const setups = [...new Set(state.trades.map(t => t.setup).filter(Boolean))];
  filterSetup.innerHTML = `<option value="ALL">All setups</option>` + setups.map(s => `<option value="${escapeAttr(s)}">${escapeHtml(s)}</option>`).join("");
}

function getFilteredTrades(){
  let filtered = state.trades;
  
  const stratFilter = filterStrategy.value;
  if(stratFilter !== "ALL"){
    filtered = filtered.filter(t => t.strategyId === stratFilter);
  }
  
  const setupFilter = filterSetup.value;
  if(setupFilter !== "ALL"){
    filtered = filtered.filter(t => t.setup === setupFilter);
  }
  
  const sessionFilter = filterSession.value;
  if(sessionFilter !== "ALL"){
    filtered = filtered.filter(t => t.session === sessionFilter);
  }
  
  const dowFilter = filterDOW.value;
  if(dowFilter !== "ALL"){
    filtered = filtered.filter(t => dowShort(t.date) === dowFilter);
  }
  
  return filtered;
}

function renderStats(){
  const filtered = getFilteredTrades();
  const completed = filtered.filter(t => t.postReview?.realizedR != null);
  
  statTotalTrades.textContent = filtered.length;
  
  if(completed.length > 0){
    const avgScore = completed.reduce((sum, t) => sum + (t.postScore || 0), 0) / completed.length;
    statAvgScore.textContent = `${avgScore.toFixed(0)}%`;
    
    const wins = completed.filter(t => t.postReview.result === "win").length;
    const winRate = (wins / completed.length) * 100;
    statWinRate.textContent = `${winRate.toFixed(0)}%`;
    
    const avgR = completed.reduce((sum, t) => sum + t.postReview.realizedR, 0) / completed.length;
    statAvgR.textContent = avgR.toFixed(2);
  } else {
    statAvgScore.textContent = "0%";
    statWinRate.textContent = "0%";
    statAvgR.textContent = "0.00";
  }
}

function renderDistBars(){
  const filtered = getFilteredTrades();
  const aCount = filtered.filter(t => t.postScore && gradeFromPct(t.postScore) === "A").length;
  const bCount = filtered.filter(t => t.postScore && gradeFromPct(t.postScore) === "B").length;
  const cCount = filtered.filter(t => t.postScore && gradeFromPct(t.postScore) === "C").length;
  const total = aCount + bCount + cCount;
  
  distBars.innerHTML = total === 0 ? `<div class="text-sm text-gray-400">No completed reviews yet.</div>` : `
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">A-Grade</span>
        <span class="text-gray-400">${aCount} (${((aCount/total)*100).toFixed(0)}%)</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400" style="width: ${(aCount/total)*100}%"></div>
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">B-Grade</span>
        <span class="text-gray-400">${bCount} (${((bCount/total)*100).toFixed(0)}%)</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-500 to-blue-400" style="width: ${(bCount/total)*100}%"></div>
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">C-Grade</span>
        <span class="text-gray-400">${cCount} (${((cCount/total)*100).toFixed(0)}%)</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full bg-gradient-to-r from-amber-500 to-amber-400" style="width: ${(cCount/total)*100}%"></div>
      </div>
    </div>
  `;
}

function renderRBars(){
  const filtered = getFilteredTrades();
  const completed = filtered.filter(t => t.postReview?.realizedR != null);
  
  const aGrades = completed.filter(t => gradeFromPct(t.postScore) === "A");
  const bGrades = completed.filter(t => gradeFromPct(t.postScore) === "B");
  const cGrades = completed.filter(t => gradeFromPct(t.postScore) === "C");
  
  const avgA = aGrades.length > 0 ? aGrades.reduce((sum, t) => sum + t.postReview.realizedR, 0) / aGrades.length : 0;
  const avgB = bGrades.length > 0 ? bGrades.reduce((sum, t) => sum + t.postReview.realizedR, 0) / bGrades.length : 0;
  const avgC = cGrades.length > 0 ? cGrades.reduce((sum, t) => sum + t.postReview.realizedR, 0) / cGrades.length : 0;
  
  const maxR = Math.max(Math.abs(avgA), Math.abs(avgB), Math.abs(avgC), 1);
  
  rBars.innerHTML = completed.length === 0 ? `<div class="text-sm text-gray-400">No completed reviews yet.</div>` : `
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">A-Grade Avg R</span>
        <span class="text-gray-400">${avgA.toFixed(2)}R</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full ${avgA >= 0 ? 'bg-gradient-to-r from-emerald-500 to-emerald-400' : 'bg-gradient-to-r from-red-500 to-red-400'}" style="width: ${(Math.abs(avgA)/maxR)*100}%"></div>
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">B-Grade Avg R</span>
        <span class="text-gray-400">${avgB.toFixed(2)}R</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full ${avgB >= 0 ? 'bg-gradient-to-r from-emerald-500 to-emerald-400' : 'bg-gradient-to-r from-red-500 to-red-400'}" style="width: ${(Math.abs(avgB)/maxR)*100}%"></div>
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-medium">C-Grade Avg R</span>
        <span class="text-gray-400">${avgC.toFixed(2)}R</span>
      </div>
      <div class="h-3 rounded-full bg-gray-800 overflow-hidden">
        <div class="h-full ${avgC >= 0 ? 'bg-gradient-to-r from-emerald-500 to-emerald-400' : 'bg-gradient-to-r from-red-500 to-red-400'}" style="width: ${(Math.abs(avgC)/maxR)*100}%"></div>
      </div>
    </div>
  `;
}

function renderSetupPerformance(){
  const filtered = getFilteredTrades();
  const completed = filtered.filter(t => t.postReview?.realizedR != null && t.setup);
  
  const setupStats = {};
  completed.forEach(t => {
    if(!setupStats[t.setup]){
      setupStats[t.setup] = { count: 0, totalR: 0, wins: 0 };
    }
    setupStats[t.setup].count++;
    setupStats[t.setup].totalR += t.postReview.realizedR;
    if(t.postReview.result === "win") setupStats[t.setup].wins++;
  });
  
  const setups = Object.keys(setupStats);
  if(setups.length === 0){
    document.getElementById("setupPerformance").innerHTML = `<div class="text-sm text-gray-400">No setup data yet.</div>`;
    return;
  }
  
  document.getElementById("setupPerformance").innerHTML = setups.map(setup => {
    const stats = setupStats[setup];
    const avgR = stats.totalR / stats.count;
    const winRate = (stats.wins / stats.count) * 100;
    
    return `
      <div class="flex items-center justify-between p-4 rounded-xl border border-gray-800 bg-gray-950">
        <div>
          <div class="font-medium">${escapeHtml(setup)}</div>
          <div class="text-xs text-gray-400 mt-1">${stats.count} trades</div>
        </div>
        <div class="text-right">
          <div class="font-bold ${avgR >= 0 ? 'text-emerald-400' : 'text-red-400'}">${avgR.toFixed(2)}R</div>
          <div class="text-xs text-gray-400">${winRate.toFixed(0)}% WR</div>
        </div>
      </div>
    `;
  }).join("");
}

function renderTradesList(){
  const filtered = getFilteredTrades().sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if(filtered.length === 0){
    tradesList.innerHTML = `<div class="text-center text-gray-400 py-8">No trades yet. Enter your first trade!</div>`;
    return;
  }
  
  tradesList.innerHTML = filtered.map(t => {
    const strat = state.strategies.find(s => s.id === t.strategyId);
    const grade = t.postScore ? gradeFromPct(t.postScore) : "?";
    const hasReview = t.postReview != null;
    const cardClass = hasReview ? (t.postReview.result === "win" ? "trade-card-win" : "trade-card-loss") : "trade-card-pending";
    
    return `
      <div class="rounded-2xl border border-gray-800 bg-gray-950/50 p-5 ${cardClass}">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <div class="font-bold text-lg">${escapeHtml(t.symbol || "???")}</div>
              <div class="px-2 py-1 rounded-lg bg-gray-800 text-xs font-medium">${escapeHtml(strat?.name || "Unknown")}</div>
              ${t.setup ? `<div class="px-2 py-1 rounded-lg bg-blue-500/20 text-blue-300 text-xs font-medium">${escapeHtml(t.setup)}</div>` : ""}
            </div>
            <div class="text-sm text-gray-400 mt-2">
              ${t.date} | ${escapeHtml(t.session)} | Confidence: ${["Low", "Medium", "High"][t.confidence - 1]}
            </div>
            <div class="flex items-center gap-4 mt-3 text-sm">
              <div>Pre: <span class="font-semibold">${t.preScore}%</span> (${gradeFromPct(t.preScore)})</div>
              ${hasReview ? `<div>Post: <span class="font-semibold">${t.postScore}%</span> (${grade})</div>` : `<div class="text-gray-500">Post: Pending</div>`}
              ${hasReview && t.postReview.realizedR != null ? `<div class="${t.postReview.realizedR >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${t.postReview.realizedR.toFixed(2)}R</div>` : ""}
            </div>
          </div>
          <div class="flex flex-col gap-2">
            ${!hasReview ? `<button class="px-4 py-2 rounded-xl btn-primary text-sm font-semibold" onclick="openPostReview('${t.id}')">Review</button>` : `<button class="px-4 py-2 rounded-xl bg-gray-800 hover:bg-gray-700 text-sm font-medium transition" onclick="openPostReview('${t.id}')">View</button>`}
            <button class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-sm font-medium transition" onclick="deleteTrade('${t.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

window.deleteTrade = function(id){
  if(confirm("Delete this trade?")){
    state.trades = state.trades.filter(t => t.id !== id);
    saveStateSmart(state);
    render();
  }
};

let rChart = null;

function renderRChart(){
  const canvas = rChartCanvas;
  if(!canvas) return;
  
  const completed = state.trades.filter(t => t.postReview?.realizedR != null).sort((a, b) => new Date(a.date) - new Date(b.date));
  
  if(completed.length === 0){
    if(rChart) rChart.destroy();
    return;
  }
  
  let cumR = 0;
  const data = completed.map(t => {
    cumR += t.postReview.realizedR;
    return cumR;
  });
  
  const labels = completed.map((t, i) => `Trade ${i + 1}`);
  
  if(rChart){
    rChart.destroy();
  }
  
  rChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Cumulative R',
        data,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(17, 25, 40, 0.95)',
          titleColor: 'rgb(229, 231, 235)',
          bodyColor: 'rgb(156, 163, 175)',
          borderColor: 'rgba(75, 85, 99, 0.5)',
          borderWidth: 1,
          padding: 12,
          displayColors: false
        }
      },
      scales: {
        y: {
          ticks: { 
            color: 'rgb(107, 114, 128)',
            font: { size: 11 }
          },
          grid: { color: 'rgba(75, 85, 99, 0.2)' }
        },
        x: {
          ticks: { 
            color: 'rgb(107, 114, 128)',
            font: { size: 10 }
          },
          grid: { display: false }
        }
      }
    }
  });
}

function calcStreakReview(){
  const sortedJournals = state.journals.sort((a, b) => new Date(b.date) - new Date(a.date));
  let streak = 0;
  const today = todayISO();
  
  for(let i = 0; i < 365; i++){
    const d = new Date();
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().slice(0, 10);
    
    if(sortedJournals.find(j => j.date === dateStr)){
      streak++;
    } else {
      break;
    }
  }
  
  return streak;
}

function calcStreakDisciplined(){
  let streak = 0;
  const today = new Date();
  
  for(let i = 0; i < 365; i++){
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().slice(0, 10);
    
    if(dayData.quadrant === "pd"){
      streak++;
    } else if(dayData.quadrant !== "empty"){
      break;
    }
  }
  
  return streak;
}

function renderStreaks(){
  streakReview.textContent = calcStreakReview();
  streakDisciplined.textContent = calcStreakDisciplined();
}

function renderHero(){
  const hour = new Date().getHours();
  if(hour < 12) greetingLine.textContent = "Good morning";
  else if(hour < 18) greetingLine.textContent = "Good afternoon";
  else greetingLine.textContent = "Good evening";
  
  const quotes = [
    "Process over outcome.",
    "The market doesn't care about your feelings.",
    "Discipline = Freedom.",
    "Your worst trade teaches you more than your best.",
    "If it's not an A-setup, it's an F-setup."
  ];
  quoteLine.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
  
  // Market countdown (example for 9:30 AM ET)
  const now = new Date();
  const marketOpen = new Date();
  marketOpen.setHours(9, 30, 0, 0);
  if(now > marketOpen) marketOpen.setDate(marketOpen.getDate() + 1);
  
  const msUntilOpen = marketOpen - now;
  const hoursUntil = Math.floor(msUntilOpen / (1000 * 60 * 60));
  const minsUntil = Math.floor((msUntilOpen % (1000 * 60 * 60)) / (1000 * 60));
  
  marketOpenLine.textContent = "9:30 AM ET";
  marketCountdown.textContent = `${hoursUntil}h ${minsUntil}m until open`;
  
  // Focus
  const todayJournal = state.journals.find(j => j.date === todayISO());
  if(!todayJournal){
    todayFocusLine.textContent = "Complete your Daily Review tonight.";
  } else {
    todayFocusLine.textContent = "Review complete! Focus on A-setups.";
  }
}

function render(){
  populateStrategySelects();
  populateSetupFilter();
  renderStrategies();
  renderStats();
  renderDistBars();
  renderRBars();
  renderSetupPerformance();
  renderTradesList();
  renderRChart();
  renderStreaks();
  renderHero();
  renderMistakeTrend();
  loadLocks();
  updateRiskDashboard();
}

// Filter change listeners
filterStrategy.addEventListener("change", render);
filterSetup.addEventListener("change", render);
filterSession.addEventListener("change", render);
filterDOW.addEventListener("change", render);

// Initialize
setupMobileNav();

// Service Worker Registration (PWA)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(console.warn);
}

// Boot on load
document.addEventListener("DOMContentLoaded", bootSupabase);
</script>
</body>
</html>